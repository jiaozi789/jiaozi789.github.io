---
title: "Transformeræ¨¡å‹è¯¦è§£03-Self-Attentionï¼ˆè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼‰"
date: 2025-09-18T16:55:17+08:00
# bookComments: false
# bookSearchExclude: false
---


# ç®€ä»‹
ä¸‹å›¾æ˜¯è®ºæ–‡ä¸­ Transformer çš„å†…éƒ¨ç»“æ„å›¾ï¼Œå·¦ä¾§ä¸º Encoder blockï¼Œå³ä¾§ä¸º Decoder blockã€‚çº¢è‰²åœˆä¸­çš„éƒ¨åˆ†ä¸º Multi-Head Attentionï¼Œæ˜¯ç”±å¤šä¸ª Self-Attentionç»„æˆçš„ï¼Œå¯ä»¥çœ‹åˆ° Encoder block åŒ…å«ä¸€ä¸ª Multi-Head Attentionï¼Œè€Œ Decoder block åŒ…å«ä¸¤ä¸ª Multi-Head Attention (å…¶ä¸­æœ‰ä¸€ä¸ªç”¨åˆ° Masked)ã€‚Multi-Head Attention ä¸Šæ–¹è¿˜åŒ…æ‹¬ä¸€ä¸ª Add & Norm å±‚ï¼ŒAdd è¡¨ç¤ºæ®‹å·®è¿æ¥ (Residual Connection) ç”¨äºé˜²æ­¢ç½‘ç»œé€€åŒ–ï¼ŒNorm è¡¨ç¤º Layer Normalizationï¼Œç”¨äºå¯¹æ¯ä¸€å±‚çš„æ¿€æ´»å€¼è¿›è¡Œå½’ä¸€åŒ–ã€‚

å› ä¸º Self-Attentionæ˜¯ Transformer çš„é‡ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨ Multi-Head Attention ä»¥åŠ Self-Attentionï¼Œé¦–å…ˆè¯¦ç»†äº†è§£ä¸€ä¸‹ Self-Attention çš„å†…éƒ¨é€»è¾‘ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/00279ac79343fc02a712529c58477977.png)
# åŸºç¡€çŸ¥è¯†
## å‘é‡çš„å†…ç§¯
**å‘é‡çš„å†…ç§¯æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•è®¡ç®—ï¼Œæœ€é‡è¦çš„ï¼Œå…¶å‡ ä½•æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ**

å†…ç§¯çš„è®¡ç®—æ–¹æ³•æ˜¯å°†ä¸¤ä¸ªå‘é‡å¯¹åº”åˆ†é‡ç›¸ä¹˜ï¼Œç„¶åå°†ç»“æœç›¸åŠ ã€‚
å†…ç§¯çš„å‡ ä½•æ„ä¹‰æ˜¯éå¸¸é‡è¦çš„ã€‚åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œä¸¤ä¸ªå‘é‡çš„å†…ç§¯ç­‰äºä¸¤ä¸ªå‘é‡çš„æ¨¡ï¼ˆé•¿åº¦ï¼‰ä¹‹ç§¯ä¹˜ä»¥å®ƒä»¬ä¹‹é—´çš„å¤¹è§’çš„ä½™å¼¦å€¼ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœ 
Î¸ æ˜¯ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„å¤¹è§’ï¼Œåˆ™å®ƒä»¬çš„å†…ç§¯ä¸ºï¼š
$$\mathbf{a} \cdot \mathbf{b} = |\mathbf{a}| |\mathbf{b}| \cos(\theta)$$
è¿™ä¸ªå…¬å¼è¡¨æ˜ï¼Œ**å†…ç§¯å¯ä»¥ç”¨æ¥è¡¡é‡ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼ç¨‹åº¦**ã€‚å½“ä¸¤ä¸ªå‘é‡çš„å¤¹è§’ä¸º 0æ—¶(cos0=1)ï¼Œå®ƒä»¬çš„å†…ç§¯å–å¾—æœ€å¤§å€¼ï¼Œè¡¨ç¤ºå®ƒä»¬çš„æ–¹å‘ç›¸åŒï¼›å½“å¤¹è§’ä¸º 90æ—¶(cos90=0)ï¼Œå†…ç§¯ä¸º 0ï¼Œè¡¨ç¤ºå®ƒä»¬çš„æ–¹å‘å‚ç›´ï¼›å½“å¤¹è§’ä¸º180(cos180=-1) æ—¶ï¼Œå†…ç§¯å–å¾—æœ€å°å€¼ï¼Œè¡¨ç¤ºå®ƒä»¬çš„æ–¹å‘ç›¸åã€‚
## çŸ©é˜µä¸è½¬ç½®ç›¸ä¹˜
**ä¸€ä¸ªçŸ©é˜µ ä¸å…¶è‡ªèº«çš„è½¬ç½®ç›¸ä¹˜ï¼Œå¾—åˆ°çš„ç»“æœæœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ**
çŸ©é˜µçš„å¯¹ç§°æ€§æŒ‡çš„æ˜¯çŸ©é˜µåœ¨æŸç§å˜æ¢ä¸‹ä¿æŒä¸å˜çš„æ€§è´¨ã€‚å¯¹ç§°çŸ©é˜µæ˜¯ä¸€ç§ç‰¹æ®Šçš„çŸ©é˜µï¼Œå®ƒæ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼šçŸ©é˜µçš„è½¬ç½®ç­‰äºå®ƒè‡ªèº«ã€‚
å…·ä½“æ¥è¯´ï¼Œå¯¹ç§°çŸ©é˜µ  A æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
$$\mathbf{A} = \mathbf{A}^\intercal$$
è¿™æ„å‘³ç€çŸ©é˜µçš„ä¸»å¯¹è§’çº¿ä¸Šçš„å…ƒç´ ä¿æŒä¸å˜ï¼Œè€Œå…¶ä»–å…ƒç´ å…³äºä¸»å¯¹è§’çº¿å¯¹ç§°ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªçŸ©é˜µ A çš„å…ƒç´ ä¸ºï¼š
$$\mathbf{A} = \begin{pmatrix} a & b & c \\ b & d & e \\ c & e & f \end{pmatrix}$$
çŸ©é˜µä¸­çš„å…ƒç´ å¯¹ç§°äºä¸»å¯¹è§’çº¿ã€‚
å¯¹ç§°çŸ©é˜µåœ¨æ•°å­¦å’Œå·¥ç¨‹é¢†åŸŸä¸­éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒä»¬å…·æœ‰è®¸å¤šæœ‰ç”¨çš„æ€§è´¨ï¼Œæ¯”å¦‚ç‰¹å¾å€¼éƒ½æ˜¯å®æ•°ã€å¯ä»¥é€šè¿‡æ­£äº¤å˜æ¢å¯¹è§’åŒ–ç­‰ã€‚åœ¨åº”ç”¨ä¸­ï¼Œå¯¹ç§°çŸ©é˜µå¹¿æ³›ç”¨äºæè¿°å¯¹ç§°ç³»ç»Ÿã€è¡¨ç¤ºç‰©ç†ç°è±¡ç­‰ã€‚

å½“ä¸€ä¸ªçŸ©é˜µä¸å…¶è‡ªèº«çš„è½¬ç½®ç›¸ä¹˜æ—¶ï¼Œå¾—åˆ°çš„ç»“æœçŸ©é˜µå…·æœ‰é‡è¦çš„æ€§è´¨ï¼Œå…¶ä¸­æœ€æ˜¾è‘—çš„æ˜¯ç»“æœçŸ©é˜µæ˜¯ä¸€ä¸ªå¯¹ç§°çŸ©é˜µã€‚è¿™ä¸ªæ€§è´¨åœ¨è®¸å¤šé¢†åŸŸä¸­éƒ½æœ‰é‡è¦çš„åº”ç”¨ï¼Œæ¯”å¦‚åœ¨ç»Ÿè®¡å­¦ä¸­ç”¨äºåæ–¹å·®çŸ©é˜µçš„è®¡ç®—ï¼Œä»¥åŠåœ¨æœºå™¨å­¦ä¹ ä¸­ç”¨äºç‰¹å¾æå–å’Œæ•°æ®é™ç»´ã€‚

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå…·ä½“çš„çŸ©é˜µç¤ºä¾‹æ¥æ¼”ç¤ºè¿™ä¸ªæ€§è´¨ã€‚è€ƒè™‘ä¸€ä¸ª $3 \times 2$çš„çŸ©é˜µ
çš„çŸ©é˜µ$\mathbf{A}$ï¼š
$$\mathbf{A} = \begin{pmatrix} 1 & 2 \\ 3 & 4 \\ 5 & 6 \end{pmatrix}$$
é¦–å…ˆï¼Œæˆ‘ä»¬è®¡ç®— A çš„è½¬ç½® $\mathbf{A}^\intercal$
$$\mathbf{A}^\intercal = \begin{pmatrix} 1 & 3 & 5 \\ 2 & 4 & 6 \end{pmatrix}$$
ç„¶åï¼Œæˆ‘ä»¬å°† ğ´ ç›¸ä¹˜$\mathbf{A}^\intercal$ï¼Œå¾—åˆ°ç»“æœçŸ©é˜µ $\mathbf{A} \mathbf{A}^\intercal$
$$\mathbf{A} \mathbf{A}^\intercal = \begin{pmatrix} 1 & 2 \\ 3 & 4 \\ 5 & 6 \end{pmatrix} \begin{pmatrix} 1 & 3 & 5 \\ 2 & 4 & 6 \end{pmatrix} = \begin{pmatrix} 5 & 11 & 17 \\ 11 & 25 & 39 \\ 17 & 39 & 61 \end{pmatrix}$$

å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç»“æœçŸ©é˜µ $\mathbf{A} \mathbf{A}^\intercal$æ˜¯ä¸€ä¸ªå¯¹ç§°çŸ©é˜µã€‚

## Q,K,V
åœ¨Transformeræ¨¡å‹ä¸­ï¼ŒQï¼ˆQueryï¼‰ã€Kï¼ˆKeyï¼‰å’ŒVï¼ˆValueï¼‰åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ç†è§£å®ƒä»¬çš„ç‰©ç†æ„ä¹‰ï¼š

å‡è®¾æˆ‘ä»¬è¦ç¿»è¯‘ä¸€æ®µæ–‡æœ¬ï¼Œæ¯”å¦‚å°†è‹±æ–‡å¥å­ "The cat sat on the mat" ç¿»è¯‘æˆæ³•æ–‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒQã€K å’Œ V å¯ä»¥è¢«è§£é‡Šä¸ºï¼š

- Queryï¼ˆæŸ¥è¯¢ï¼‰ï¼šåœ¨ç¿»è¯‘æ—¶ï¼ŒQueryè¡¨ç¤ºå½“å‰æ­£åœ¨ç¿»è¯‘çš„å•è¯æˆ–è€…çŸ­è¯­ã€‚ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å°è¯•ç¿»è¯‘ "sat" è¿™ä¸ªè¯æ—¶ï¼Œ"sat" å°±æ˜¯å½“å‰çš„ Queryã€‚
    
- Keyï¼ˆé”®ï¼‰ï¼šKeyè¡¨ç¤ºæºè¯­è¨€ï¼ˆè‹±æ–‡ï¼‰ä¸­å…¶ä»–ä½ç½®çš„ä¿¡æ¯ï¼Œç”¨äºä¸å½“å‰ Query è¿›è¡Œæ¯”è¾ƒã€‚åœ¨ç¿»è¯‘ä»»åŠ¡ä¸­ï¼ŒKeyå¯ä»¥æ˜¯æºè¯­è¨€å¥å­ä¸­çš„å…¶ä»–å•è¯æˆ–è€…çŸ­è¯­ã€‚æ¯”å¦‚ï¼Œåœ¨ç¿»è¯‘ "sat" æ—¶ï¼ŒKey å¯èƒ½æ˜¯æºè¯­è¨€å¥å­ä¸­çš„ "The"ã€"cat"ã€"on" ç­‰å•è¯ã€‚
    
- Valueï¼ˆå€¼ï¼‰ï¼šValueåŒ…å«äº†ä¸ Key ç›¸å…³çš„å®é™…æ•°å€¼ä¿¡æ¯ã€‚åœ¨ç¿»è¯‘ä»»åŠ¡ä¸­ï¼ŒValue å¯ä»¥æ˜¯æºè¯­è¨€å¥å­ä¸­ä¸ Key å¯¹åº”çš„è¯è¯­çš„åµŒå…¥å‘é‡æˆ–è€…è¡¨ç¤ºã€‚æ¯”å¦‚ï¼Œä¸ Key "The" ç›¸å…³çš„ Value å¯èƒ½æ˜¯ "Le"ï¼Œä¸ Key "cat" ç›¸å…³çš„ Value å¯èƒ½æ˜¯ "chat"ï¼Œç­‰ç­‰ã€‚
    

**åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œç³»ç»Ÿä¼šè®¡ç®—å½“å‰ Queryï¼ˆå¦‚ "sat"ï¼‰ä¸æ‰€æœ‰ Keyï¼ˆå¦‚ "The"ã€"cat"ã€"on"ï¼‰ä¹‹é—´çš„ç›¸å…³æ€§å¾—åˆ†ï¼Œç„¶åä½¿ç”¨è¿™äº›å¾—åˆ†å¯¹ Valueï¼ˆå¦‚ "Le"ã€"chat"ï¼‰è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œä»¥äº§ç”Ÿæœ€ç»ˆçš„ç¿»è¯‘è¾“å‡ºã€‚è¿™æ ·ï¼Œæ¨¡å‹å¯ä»¥æ ¹æ®è¾“å…¥çš„ Queryï¼ˆå³è¦ç¿»è¯‘çš„å•è¯æˆ–çŸ­è¯­ï¼‰é€‰æ‹©æ€§åœ°å…³æ³¨æºè¯­è¨€å¥å­ä¸­ä¸ä¹‹ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ç¿»è¯‘ç»“æœã€‚** 

é€šè¿‡ä¸Šé¢çš„ä¾‹å­ç¨å¾®ç†è§£Q,K,Væ¦‚å¿µåï¼Œå¯¹åç»­ç†è§£å…¬å¼æœ‰å¸®åŠ©ã€‚
# ä»€ä¹ˆæ˜¯Attention
æ‰€è°“Attentionï¼Œé¡¾åæ€ä¹‰ï¼šæ³¨æ„åŠ›ï¼Œæ„æ€æ˜¯å¤„ç†ä¸€ä¸ªé—®é¢˜çš„æ—¶å€™æŠŠ"æ³¨æ„åŠ›"æ”¾åˆ°é‡è¦çš„åœ°æ–¹ä¸Šã€‚Attentionæ€æƒ³å…¶å®æ˜¯ä»äººç±»çš„ä¹ æƒ¯ä¸­æå–å‡ºæ¥çš„ã€‚äººä»¬åœ¨ç¬¬ä¸€æ¬¡çœ‹ä¸€å¼ ç…§ç‰‡çš„æ—¶å€™ï¼Œç¬¬ä¸€çœ¼ä¸€å®šè½åˆ°è¿™å¼ ç…§ç‰‡çš„æŸä¸ªä½ç½®ä¸Šï¼Œå¯èƒ½æ˜¯ä¸ªæ˜¾è‘—çš„å»ºç­‘ç‰©ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæœ‰ç‰¹ç‚¹çš„äººç­‰ç­‰ï¼Œæ€»ä¹‹ï¼Œäººä»¬é€šå¸¸å¹¶æ²¡æœ‰çœ‹æ¸…å›¾ç‰‡çš„å…¨éƒ¨å†…å®¹ï¼Œè€Œæ˜¯å°†æ³¨æ„åŠ›é›†ä¸­åœ¨äº†å›¾ç‰‡çš„ç„¦ç‚¹ä¸Šã€‚

2017å¹´çš„æŸä¸€å¤©,Google æœºå™¨ç¿»è¯‘å›¢é˜Ÿå‘è¡¨äº†ã€ŠAttention is All You Needã€‹è¿™ç¯‡è®ºæ–‡ï¼ŒçŠ¹å¦‚ä¸€é“æƒŠé›·ï¼ŒAttentionæ¨ªç©ºå‡ºä¸–äº†ï¼ï¼ˆæœ‰ä¸€è¯´ä¸€ï¼Œè¿™æ ‡é¢˜ä¹Ÿå¤ªä»–å–µåš£å¼ äº†ï¼Œä¸è¿‡äººå®¶æœ‰è¿™ä¸ªèµ„æœ¬(oï¾Ÿâ–½ï¾Ÿ)o ï¼‰

Attention æœºåˆ¶æœ€æ—©æ˜¯åœ¨è®¡ç®—æœºè§†è§‰é‡Œåº”ç”¨çš„ï¼Œéšååœ¨NLPé¢†åŸŸä¹Ÿå¼€å§‹åº”ç”¨äº†ï¼ŒçœŸæ­£å‘æ‰¬å…‰å¤§æ˜¯åœ¨NLPé¢†åŸŸï¼Œç”±äº2018å¹´GPTæ¨¡å‹çš„æ•ˆæœæ˜¾è‘—ï¼ŒTransformerå’ŒAttentionè¿™äº›æ ¸å¿ƒæ‰å¼€å§‹è¢«å¤§å®¶é‡ç‚¹å…³æ³¨ã€‚

 ä¸‹é¢ä¸¾ä¸ªä¾‹å­ä¸Šè¯´æ˜ä¸€ä¸‹æ³¨æ„åŠ›å’Œè‡ªæ³¨æ„åŠ›ï¼Œå¯èƒ½ä¸å¤Ÿä¸¥è°¨ï¼Œä½†è¶³ä»¥è¯´æ˜æ³¨æ„åŠ›å’Œè‡ªæ³¨æ„åŠ›æ˜¯ä»€ä¹ˆäº†ã€‚
  â€ƒé¦–å…ˆæˆ‘ä»¬ä¸å»è€ƒè™‘å¾—åˆ°æ³¨æ„åŠ›åˆ†æ•°çš„ç»†èŠ‚ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªæ“ä½œè®¤ä¸ºæ˜¯ä¸€ä¸ªå°è£…å¥½çš„å‡½æ•°ã€‚æ¯”å¦‚å®šä¹‰ä¸ºattention_score(a,b)ï¼Œè¡¨ç¤ºè¯aå’Œbçš„æ³¨æ„åŠ›åˆ†æ•°ã€‚ç°åœ¨æœ‰ä¸¤ä¸ªå¥å­A=â€œyou are beautifulâ€å’ŒB=â€œä½ å¾ˆæ¼‚äº®â€ï¼Œæˆ‘ä»¬æƒ³è®©Bå¥å­ä¸­çš„è¯â€œä½ â€æ›´åŠ å…³æ³¨Aå¥å­ä¸­çš„è¯â€œyouâ€ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯¹äºæ¯ä¸€ä¸ªAå¥å­ä¸­çš„è¯ï¼Œè®¡ç®—ä¸€ä¸‹å®ƒä¸â€œyouâ€çš„æ³¨æ„åŠ›åˆ†æ•°ã€‚ä¹Ÿå°±æ˜¯æŠŠ
```
attention_score(â€œyouâ€,â€œä½ â€)
attention_score(â€œareâ€,â€œä½ â€)
attention_score(â€œbeautifulâ€,â€œä½ â€)
```
éƒ½è®¡ç®—ä¸€éï¼Œåœ¨å®ç°attention_scoreè¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œåº•å±‚çš„è¿ç®—ä¼šè®©ç›¸ä¼¼åº¦æ¯”è¾ƒå¤§çš„ä¸¤ä¸ªè¯åˆ†æ•°æ›´é«˜ï¼Œå› æ­¤attention_score(â€œyouâ€,â€œä½ â€)çš„åˆ†æ•°æœ€é«˜ï¼Œä¹Ÿç›¸å½“äºå‘Šè¯‰äº†è®¡ç®—æœºï¼Œåœ¨å¯¹Bå¥å­ä¸­â€œä½ â€è¿›è¡ŒæŸäº›æ“ä½œçš„æ—¶å€™ï¼Œä½ åº”è¯¥æ›´åŠ å…³æ³¨Aå¥å­ä¸­çš„â€œyouâ€ï¼Œè€Œä¸æ˜¯â€œareâ€æˆ–è€…â€œbeautifulâ€ã€‚
  â€ƒä»¥ä¸Šè¿™ç§æ–¹å¼å°±æ˜¯æ³¨æ„åŠ›æœºåˆ¶ï¼Œä¸¤ä¸ªä¸åŒçš„å¥å­å»è¿›è¡Œæ³¨æ„åŠ›çš„è®¡ç®—ã€‚è€Œå½“å¥å­åªæœ‰ä¸€ä¸ªçš„æ—¶å€™ï¼Œåªèƒ½å»è®¡ç®—è‡ªå·±ä¸è‡ªå·±çš„æ³¨æ„åŠ›ï¼Œè¿™ç§æ–¹å¼å°±æ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚æ¯”å¦‚åªçœ‹Aå¥å­ï¼Œå»è®¡ç®—
```
attention_score(â€œyouâ€,â€œyouâ€)
attention_score(â€œareâ€,â€œyouâ€)
attention_score(â€œbeautifulâ€,â€œyouâ€)
```
è¿™ç§æ–¹å¼å¯ä»¥æŠŠæ³¨æ„åŠ›æ”¾åœ¨å¥å­å†…éƒ¨å„ä¸ªå•è¯ä¹‹é—´çš„è”ç³»ï¼Œéå¸¸é€‚åˆå¯»æ‰¾ä¸€ä¸ªå¥å­å†…éƒ¨çš„è¯­ä¹‰å…³ç³»ã€‚

å†ä¸¾ä¸ªä¾‹å­æ¯”å¦‚è¿™å¥è¯â€œè¿™åªè´è¶çœŸæ¼‚äº®ï¼Œåœåœ¨èŠ±æœµä¸Šï¼Œæˆ‘å¾ˆå–œæ¬¢å®ƒâ€ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¿™ä¸ªâ€œå®ƒâ€æŒ‡çš„æ˜¯â€œè´è¶â€è¿˜æ˜¯â€œèŠ±æœµâ€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ç”¨è‡ªæ³¨æ„åŠ›æœºåˆ¶è®¡ç®—å‡ºè¿™ä¸ªâ€œå®ƒâ€å’Œå…¶ä»–æ‰€æœ‰è¾“å…¥è¯çš„â€œåˆ†æ•°â€ï¼Œè¿™ä¸ªâ€œåˆ†æ•°â€ä¸€å®šç¨‹åº¦ä¸Šå†³å®šäº†å…¶ä»–å•è¯ä¸è¿™ä¸ªè”ç³»ã€‚å¯ä»¥ç†è§£æˆè¶Šç›¸ä¼¼çš„ï¼Œåˆ†å°±è¶Šé«˜ï¼ˆé€šè¿‡æƒé‡æ¥æ§åˆ¶ï¼‰ã€‚é€šè¿‡è®¡ç®—ï¼Œå‘ç°å¯¹äºâ€œå®ƒâ€è¿™ä¸ªå­—ï¼Œâ€œè´è¶â€æ¯”â€œèŠ±æœµâ€æ‰“çš„åˆ†é«˜ã€‚æ‰€ä»¥å¯¹äºâ€œå®ƒâ€æ¥è¯´ï¼Œâ€œè´è¶â€æ›´é‡è¦ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™ä¸ªâ€œå®ƒâ€æŒ‡çš„å°±æ˜¯è´è¶ã€‚

# Self Attention
## åŸç†    
### é€šä¿—æ˜“æ‡‚ç†è§£
åœ¨äººç±»çš„ç†è§£ä¸­ï¼Œå¯¹å¾…é—®é¢˜æ˜¯æœ‰æ˜æ˜¾çš„ä¾§é‡ã€‚å…·ä½“ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼šâ€œæˆ‘å–œæ¬¢è¸¢è¶³çƒï¼Œæ›´å–œæ¬¢æ‰“ç¯®çƒã€‚â€ï¼Œå¯¹äºäººç±»æ¥è¯´ï¼Œæ˜¾ç„¶çŸ¥é“è¿™ä¸ªäººæ›´å–œæ¬¢æ‰“ç¯®çƒã€‚ä½†å¯¹äºæ·±åº¦å­¦ä¹ æ¥è¯´ï¼Œåœ¨ä¸çŸ¥é“â€æ›´â€œè¿™ä¸ªå­—çš„å«ä¹‰å‰ï¼Œæ˜¯æ²¡åŠæ³•çŸ¥é“è¿™ä¸ªç»“æœçš„ã€‚æ‰€ä»¥åœ¨è®­ç»ƒæ¨¡å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåŠ å¤§â€œæ›´â€å­—çš„æƒé‡ï¼Œè®©å®ƒåœ¨å¥å­ä¸­çš„é‡è¦æ€§è·å¾—æ›´å¤§çš„å æ¯”ã€‚æ¯”å¦‚ï¼š
$$C(seq) = F(0.1*d(æˆ‘)ï¼Œ0.1*d(å–œ)ï¼Œ...ï¼Œ0.8*d(æ›´)ï¼Œ0.2*d(å–œ)ï¼Œ...) $$
åœ¨çŸ¥é“äº†attentionåœ¨æœºå™¨å­¦ä¹ ä¸­çš„å«ä¹‰ä¹‹åï¼ˆä¸‹æ–‡éƒ½ç§°ä¹‹ä¸ºæ³¨æ„åŠ›æœºåˆ¶ï¼‰ã€‚äººä¸ºè®¾è®¡çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ˜¯éå¸¸ä¸»è§‚çš„ï¼Œè€Œä¸”æ²¡æœ‰ä¸€ä¸ªå‡†åˆ™æ¥è¯„å®šï¼Œè¿™ä¸ªæƒé‡è®¾ç½®ä¸ºå¤šå°‘æ‰å¥½ã€‚æ‰€ä»¥ï¼Œå¦‚ä½•è®©æ¨¡å‹è‡ªå·±å¯¹å˜é‡çš„æƒé‡è¿›è¡Œè‡ªèµ‹å€¼æˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæƒé‡è‡ªèµ‹å€¼çš„è¿‡ç¨‹ä¹Ÿå°±æ˜¯self-attentionã€‚

å®šä¹‰ï¼šå‡è®¾æœ‰å››ä¸ªè¾“å…¥å˜é‡$a^1$ï¼Œ$a^2$ï¼Œ$a^3$ï¼Œ$a^4$ï¼Œå¸Œæœ›å®ƒä»¬ç»è¿‡ä¸€ä¸ªself-attention layerä¹‹åå˜ä¸º$b^1$ï¼Œ$b^2$ï¼Œ$b^3$ï¼Œ$b^4$
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9a28d974155b3a6b9e583c74d63c3cdc.png)
æ‹¿$a^1$å’Œ$b^1$åšä¾‹å­,$b^1$è¿™ä¸ªç»“æœæ˜¯ç»¼åˆäº†$a^1$ï¼Œ$a^2$ï¼Œ$a^3$ï¼Œ$a^4$è€Œå¾—å‡ºæ¥çš„ä¸€ä¸ªç»“æœã€‚æ—¢ç„¶å¾—åˆ°ä¸€ä¸ªb æ˜¯è¦ç»¼åˆæ‰€æœ‰çš„aæ‰è¡Œï¼Œé‚£ä¹ˆæœ€ç›´æ¥çš„åšæ³•å°±æ˜¯$a^1$ä¸$a^2$ï¼Œ$a^3$ï¼Œ$a^4$
éƒ½åšä¸€æ¬¡è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœå°±ä»£è¡¨äº†è¿™ä¸ªå˜é‡çš„æ³¨æ„åŠ›ç³»æ•°ã€‚ç›´æ¥åšä¹˜æ³•å¤ªæš´åŠ›äº†ï¼Œæ‰€ä»¥é€‰æ‹©ä¸€ä¸ªæ›´æŸ”å’Œçš„æ–¹æ³•ï¼šå¼•å…¥ä¸‰ä¸ªå˜é‡$W^q$,$W^k$,$W^v$è¿™ä¸‰ä¸ªå˜é‡ä¸$a^1$ç›¸ä¹˜å¾—åˆ°$q^1$,$k^1$,$v^1$
åŒæ ·çš„æ–¹æ³•å¯¹$a^2$ï¼Œ$a^3$ï¼Œ$a^4$éƒ½åšä¸€æ¬¡,è‡³äºè¿™é‡Œçš„q , k , vå…·ä½“ä»£è¡¨ä»€ä¹ˆï¼Œä¸‹é¢å°±æ…¢æ…¢å±•å¼€è®²è§£ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/b1c6c752a921fc8d84c7633a59b47a51.png)
ç„¶åæ‹¿è‡ªå·±çš„qä¸åˆ«äººçš„kç›¸ä¹˜å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªç³»æ•°$\alpha$ã€‚è¿™é‡Œ$q^1$åœ¨å’Œå…¶ä»–çš„kåšå†…ç§¯æ—¶ï¼Œå¯è¿‘ä¼¼çš„çœ‹æˆæ˜¯åœ¨åšç›¸ä¼¼åº¦è®¡ç®—(å‰é¢åŸºç¡€å‘é‡çš„å†…ç§¯)ã€‚æ¯”å¦‚ï¼š
$$ \alpha_{1,1} =q^1\cdot k^1\\ \alpha_{1,2} =q^1\cdot k^2\\ \alpha_{1,3} =q^1\cdot k^3\\ \alpha_{1,4} =q^1\cdot k^4\\ $$

åœ¨å®é™…çš„ç¥ç»ç½‘ç»œè®¡ç®—è¿‡ç¨‹ä¸­ï¼Œè¿˜å¾—é™¤äºä¸€ä¸ªç¼©æ”¾ç³»æ•°$\sqrt{d}$è¿™ä¸ªdæ˜¯æŒ‡qå’Œkçš„ç»´åº¦,å› ä¸ºqå’Œkä¼šåšå†…ç§¯ï¼Œæ‰€ä»¥ç»´åº¦æ˜¯ä¸€æ ·çš„ã€‚ä¹‹æ‰€ä»¥è¦é™¤$\sqrt{d}$â€‹ï¼Œæ˜¯å› ä¸ºåšå®Œå†…ç§¯ä¹‹åï¼Œï¼Œ$\alpha$ä¼šéšç€å®ƒä»¬çš„ç»´åº¦å¢å¤§è€Œå¢å¤§ï¼Œé™¤$\sqrt{d}$ç›¸å½“äºæ ‡å‡†åŒ–ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/de0372019a7306080715494a0ff2c19c.png)
å¾—åˆ°äº†å››ä¸ª$\alpha$ä¹‹åï¼Œæˆ‘ä»¬åˆ†åˆ«å¯¹å…¶è¿›è¡Œsoftmaxï¼Œå¾—åˆ°å››ä¸ª $\hat{\alpha}_1$ï¼Œå¢åŠ æ¨¡å‹çš„éçº¿æ€§ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/1cf7059b60d0dbafa8fd26687cff1429.png)
å››ä¸ª$\alpha$åˆ†åˆ«æ˜¯ $\hat{\alpha}_1$,$\hat{\alpha}_2$,$\hat{\alpha}_3$,$\hat{\alpha}_4$,åˆ«å¿˜äº†è¿˜æœ‰æˆ‘ä»¬ä¸€å¼€å§‹è®¡ç®—å‡ºæ¥çš„ ${v}^1$,${v}^2$,${v}^3$,${v}^4$ï¼Œç›´æ¥æŠŠå„ä¸ª$\hat{\alpha}_1$ç›´æ¥ä¸å„ä¸ªa ç›¸ä¹˜ä¸å°±å¾—å‡ºäº†æœ€åçš„ç»“æœäº†å—ï¼Ÿè™½ç„¶è¿™ä¹ˆè¯´ä¹Ÿæ²¡é”™ï¼Œä½†ä¸ºäº†å¢åŠ ç½‘ç»œæ·±åº¦ï¼Œå°†aå˜æˆvä¹Ÿå¯ä»¥å‡å°‘åŸå§‹çš„aå¯¹æœ€ç»ˆæ³¨æ„åŠ›è®¡ç®—çš„å½±å“ã€‚
é‚£ä¹ˆè·ç¦»æœ€åè®¡ç®—å‡º$b^1$åªå‰©æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰çš„$\hat{\alpha}_1$
 ä¸æ‰€æœ‰çš„våˆ†åˆ«ç›¸ä¹˜ï¼Œç„¶åæ±‚å’Œï¼Œå°±å¾—å‡º$b^1$å•¦ï¼å…·ä½“è®¡ç®—å¦‚ä¸‹ï¼š
 $$b^1=\hat{\alpha}_{1,1}*v^1+\hat{\alpha}_{1,2}*v^2+\hat{\alpha}_{1,3}*v^3+\hat{\alpha}_{1,4}*v^4 $$
å…¬å¼ç®€åŒ–ä¸ºï¼š
$$b^1=\sum_i\hat{\alpha}_{1,i}*v^i $$
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/76562e272b3535eec19ca4327d82ba9b.png)
åŒæ ·çš„è®¡ç®—è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯¹å‰©ä¸‹çš„aéƒ½è¿›è¡Œä¸€æ¬¡ï¼Œå°±å¯ä»¥å¾—åˆ°$b^2$,$b^3$,$b^4$,æ¯ä¸ªbéƒ½æ˜¯ç»¼åˆäº†æ¯ä¸ªaä¹‹é—´çš„ç›¸å…³æ€§è®¡ç®—å‡ºæ¥çš„ï¼Œè¿™ä¸ªç›¸å…³æ€§å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ³¨æ„åŠ›æœºåˆ¶,ã€‚é‚£ä¹ˆæˆ‘ä»¬å°†è¿™æ ·çš„è®¡ç®—å±‚ç§°ä¸ºself-attention layerã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9df6d6fb906bb384454c9726c0fb773e.png)
æˆ‘ä»¬æŠŠä¸€ä¸ªå¥å­ä¸­çš„æ¯ä¸ªå­—ä»£å…¥ä¸Šå›¾çš„ $x^1$ï¼Œ$x^2$ ,$x^3$ï¼Œ $x^4$
### çŸ©é˜µè®¡ç®—
é€šè¿‡æ³¨æ„åŠ›è®¡ç®—å‡ºæ¥çš„ç»“æœæ˜¯æ¯ä¸ªä½ç½®å•è¯çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºï¼Œæ¯ä¸ªä½ç½®çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºæ˜¯æŒ‡åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œé€šè¿‡å°†æ¯ä¸ªä½ç½®çš„è¯åµŒå…¥å‘é‡ä¸æ³¨æ„åŠ›æƒé‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°çš„æ¯ä¸ªä½ç½®çš„è¯­ä¹‰è¡¨ç¤ºã€‚è¿™ä¸ªè¯­ä¹‰è¡¨ç¤ºåŒ…å«äº†è¾“å…¥åºåˆ—ä¸­æ¯ä¸ªä½ç½®çš„è¯­ä¹‰ä¿¡æ¯ï¼Œç»è¿‡åŠ æƒåæ›´åŠ å…¨å±€å’Œä¸°å¯Œã€‚

ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè¾“å…¥åºåˆ—ï¼š"The cat sat on the mat."ï¼Œå¹¶ä¸”ä½¿ç”¨ Transformer æ¨¡å‹è¿›è¡Œç¼–ç ï¼Œå…¶ä¸­æ¯ä¸ªå•è¯å¯¹åº”ä¸€ä¸ªä½ç½®ã€‚åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œæ¨¡å‹ä¼šè®¡ç®—æ¯ä¸ªä½ç½®å¯¹å…¶ä»–ä½ç½®çš„æ³¨æ„åŠ›æƒé‡ï¼Œç„¶åå°†è¿™äº›æƒé‡ä¸å¯¹åº”ä½ç½®çš„è¯åµŒå…¥å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æ¯ä¸ªä½ç½®çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºã€‚

è€ƒè™‘ä½ç½® 3ï¼Œå¯¹åº”å•è¯ "sat"ã€‚åœ¨è®¡ç®—æ³¨æ„åŠ›æƒé‡æ—¶ï¼Œæ¨¡å‹ä¼šè€ƒè™‘ "sat" ä¸å…¶ä»–å•è¯ä¹‹é—´çš„å…³è”ç¨‹åº¦ã€‚å‡è®¾åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ"sat" ä¸ "cat"ã€"mat" ä¹‹é—´æœ‰è¾ƒé«˜çš„æ³¨æ„åŠ›æƒé‡ï¼Œè€Œä¸ "on" çš„å…³è”è¾ƒä½ã€‚å› æ­¤ï¼Œç»è¿‡åŠ æƒæ±‚å’Œåï¼Œä½ç½® 3 çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºå°†ä¼šå¼ºè°ƒ "sat" ä¸ "cat"ã€"mat" ä¹‹é—´çš„è¯­ä¹‰å…³ç³»ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¯ä¸ªä½ç½®çš„ä¸Šä¸‹æ–‡è¡¨ç¤ºä¼šå—åˆ°æ•´ä¸ªè¾“å…¥åºåˆ—ä¸­æ‰€æœ‰ä½ç½®çš„å½±å“ï¼Œä»è€Œæ›´å¥½åœ°æ•æ‰è¾“å…¥åºåˆ—çš„è¯­ä¹‰ç»“æ„å’Œä¿¡æ¯ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/562ef34ffe46a9ff285f4d2764f6c323.png)
ä¸Šå›¾æ˜¯ Self-Attention çš„ç»“æ„ï¼Œåœ¨è®¡ç®—çš„æ—¶å€™éœ€è¦ç”¨åˆ°çŸ©é˜µQ(æŸ¥è¯¢),K(é”®å€¼),V(å€¼)ã€‚åœ¨å®é™…ä¸­ï¼ŒSelf-Attention æ¥æ”¶çš„æ˜¯è¾“å…¥(å•è¯çš„è¡¨ç¤ºå‘é‡xç»„æˆçš„çŸ©é˜µX) æˆ–è€…ä¸Šä¸€ä¸ª Encoder block çš„è¾“å‡ºã€‚è€ŒQ,K,Væ­£æ˜¯é€šè¿‡ Self-Attention çš„è¾“å…¥è¿›è¡Œçº¿æ€§å˜æ¢å¾—åˆ°çš„ã€‚
#### Qï¼ŒKï¼ŒVè®¡ç®—
>è¾“å…¥çŸ©é˜µX=position encoding+word embedding,å…¶ä¸­ç»´åº¦d_modelï¼Œè¡Œä¸ºå¥å­ä¸­å•è¯çš„ä¸ªæ•°ã€‚
>éœ€è¦çŸ¥é“xçš„æ ¼å¼å‚è€ƒï¼š[Word2Vecå®ä¾‹](https://blog.csdn.net/liaomin416100569/article/details/138177633?spm=1001.2014.3001.5501)

Self-Attention çš„è¾“å…¥ç”¨çŸ©é˜µXè¿›è¡Œè¡¨ç¤ºï¼Œåˆ™å¯ä»¥ä½¿ç”¨çº¿æ€§å˜é˜µçŸ©é˜µWQ,WK,WVè®¡ç®—å¾—åˆ°Q,K,Vã€‚è®¡ç®—
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ³¨æ„ X, Q, K, V çš„æ¯ä¸€è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ªå•è¯ï¼ŒWQï¼ŒWKï¼ŒWVæ˜¯ä¸€ä¸ªd_model(è¾“å…¥çŸ©é˜µçš„åˆ—)è¡Œçš„çº¿æ€§å˜é˜µå‚æ•°ï¼ŒXçš„æ¯ä¸€è¡Œéƒ½ä¼šéƒ½ä¼šæœ‰è‡ªå·±çš„QKVï¼Œæ¯”å¦‚$X_1$å¯¹åº”$Q_1,K_1,V_1$,å³$X_n$å¯¹åº”$Q_n,K_n,V_n$ï¼Œæ‰€ä»¥ X, Q, K, V çš„æ¯ä¸€è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ªå•è¯ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/50d8444794e7a5e3a4c890cd536b3271.png)
>è¿™é‡Œé€šè¿‡çº¿æ€§å˜æ¢çš„Q,K,Vçš„ç‰©ç†æ„ä¹‰æ˜¯åŒ…å«äº†åŸå§‹æ•°æ®çš„ä¿¡æ¯ï¼Œå¯èƒ½å…³æ³¨çš„ç‰¹å¾ç‚¹ä¸ä¸€æ ·ã€‚
#### Self-Attention çš„è¾“å‡º
å¾—åˆ°çŸ©é˜µ Q, K, Vä¹‹åå°±å¯ä»¥è®¡ç®—å‡º Self-Attention çš„è¾“å‡ºäº†ï¼Œè®¡ç®—çš„å…¬å¼å¦‚ä¸‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/041c201225ab4b2d694b3cc0b64327d7.png)
å…¬å¼ä¸­è®¡ç®—çŸ©é˜µQå’ŒKæ¯ä¸€è¡Œå‘é‡çš„å†…ç§¯ï¼Œä¸ºäº†é˜²æ­¢å†…ç§¯è¿‡å¤§ï¼Œå› æ­¤é™¤ä»¥$d_k$çš„å¹³æ–¹æ ¹ï¼Œç¼©æ”¾æ³¨æ„åŠ›ï¼Œä»¥ä½¿å¾—æ³¨æ„åŠ›åˆ†å¸ƒçš„æ–¹å·®åœ¨ä¸åŒç»´åº¦ä¸Šä¿æŒä¸€è‡´ï¼Œä»è€Œæ›´å¥½åœ°æ§åˆ¶æ¢¯åº¦çš„ç¨³å®šæ€§ã€‚ã€‚Qä¹˜ä»¥Kçš„è½¬ç½®åï¼Œå¾—åˆ°çš„çŸ©é˜µè¡Œåˆ—æ•°éƒ½ä¸º nï¼Œn ä¸ºå¥å­å•è¯æ•°ï¼Œè¿™ä¸ªçŸ©é˜µå¯ä»¥è¡¨ç¤ºå•è¯ä¹‹é—´çš„ attention å¼ºåº¦ã€‚ä¸‹å›¾ä¸ºQä¹˜ä»¥$K^T$, 1234 è¡¨ç¤ºçš„æ˜¯å¥å­ä¸­çš„å•è¯ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/314e6881f97d49ae50ce9c5e6218ee74.png)
>$Q*K^T$å…¶å®ç»ˆç®—å‡ºæ¥çš„æ˜¯ï¼Œæ¯ä¸€ä¸ªå•è¯ä¸å…¶ä»–æ‰€æœ‰çš„å•è¯çš„æ³¨æ„åŠ›ç³»æ•°ï¼Œå› ä¸ºQä»£è¡¨å•è¯æœ¬èº«å‡å¦‚ æˆ‘æœ‰ä¸€åªçŒ«ï¼Œåˆ†è¯å1=æˆ‘ï¼Œ2=æœ‰ï¼Œ3=ä¸€åªï¼Œ4=çŒ«ã€‚ å› ä¸ºKä»£è¡¨å…¶ä»–å•è¯ï¼Œè½¬è‡³ç›¸ä¹˜æœ€ç»ˆ$Q*K^T$çŸ©é˜µçš„(1,1)è¿™ä¸ªå„è‡ªå°±æ˜¯æ ‡è¯†æˆ‘å’Œæˆ‘çš„æ³¨æ„åŠ›æƒé‡ï¼Œ(1,2)å°±æ˜¯æˆ‘å’Œæœ‰çš„æ³¨æ„åŠ›æƒé‡ï¼Œ(2,4)å°±æ˜¯æœ‰å’ŒçŒ«çš„æ³¨æ„åŠ›æƒé‡


å¾—åˆ°$QK^T$ä¹‹åï¼Œä½¿ç”¨ Softmax è®¡ç®—æ¯ä¸€ä¸ªå•è¯å¯¹äºå…¶ä»–å•è¯çš„ attention ç³»æ•°ï¼Œå…¬å¼ä¸­çš„ Softmax æ˜¯å¯¹çŸ©é˜µçš„æ¯ä¸€è¡Œè¿›è¡Œ Softmaxï¼Œå³æ¯ä¸€è¡Œçš„å’Œéƒ½å˜ä¸º 1.
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/b5d5264febff91c511ea5aa5b15c4b8e.png)
å¾—åˆ° Softmax çŸ©é˜µä¹‹åå¯ä»¥å’ŒVç›¸ä¹˜ï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºZã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/c767b2b3325f15042ff3d9008f8852cb.png)
ä¸Šå›¾ä¸­ Softmax çŸ©é˜µçš„ç¬¬ 1 è¡Œè¡¨ç¤ºå•è¯ 1 ä¸å…¶ä»–æ‰€æœ‰å•è¯çš„ attention ç³»æ•°ï¼Œæœ€ç»ˆå•è¯ 1 çš„è¾“å‡º$Z_1$ç­‰äºæ‰€æœ‰å•è¯ i çš„å€¼$V_i$æ ¹æ® attention ç³»æ•°çš„æ¯”ä¾‹åŠ åœ¨ä¸€èµ·å¾—åˆ°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/9a84ef6ae723980a224f4dfe8a6d3c88.png)
>è¿™é‡Œç®—å‡ºæ¥çš„$Z_1$ç¬¬ä¸€è¡Œå°±æ˜¯ç¬¬ä¸€ä¸ªå•è¯å’Œå…¶ä»–å•è¯çš„æ³¨æ„åŠ›ç³»æ•°æƒé‡ï¼Œ
## ä¼˜åŠ¿
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/b439c926205829160dbb46dc47107785.png)
ä»self-attentionçš„åŸç†ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸€å±‚éœ€è¦å­¦ä¹ çš„å‚æ•°åªæœ‰$W^q$ ,$W^k$, $W^v$ï¼Œå¤§éƒ¨åˆ†å˜é‡æ¥è‡ªäºå†…éƒ¨è®¡ç®—å¾—å‡ºæ¥çš„ï¼Œæ‰€ä»¥å®ƒçš„å‚æ•°é‡å°‘ä½†æ¯ä¸ªå‚æ•°æ‰€æ¶µç›–çš„ä¿¡æ¯å¤šï¼Œè¿™æ˜¯å®ƒçš„ç¬¬ä¸€ä¸ªä¼˜ç‚¹ã€‚
æ¯ä¸ªbçš„è®¡ç®—éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™ä¸€ç‚¹ç›¸æ¯”ä¹‹å‰çš„RNNæ¥è¯´å¾ˆä¸ä¸€æ ·ï¼ŒRNNæ˜¯éœ€è¦ç­‰å‰é¢çš„$a^1$ç®—å®Œäº†æ‰èƒ½ç®—$a^2$ï¼Œæ˜¯ä¸²è¡Œçš„ã€‚æ‰€ä»¥RNNæ— è®ºæ˜¯è®­ç»ƒè¿˜æ˜¯æ¨ç†ï¼Œéƒ½ä¼šå› ä¸ºä¸èƒ½è®¡ç®—å¹¶è¡Œè€Œå˜æ…¢ï¼Œè¿™æ˜¯å®ƒçš„çš„ç¬¬äºŒä¸ªä¼˜ç‚¹ã€‚
RNNçš„ä¸€ä¸ªæœ€å¤§çš„é—®é¢˜æ˜¯ï¼šå‰é¢çš„å˜é‡åœ¨ç»è¿‡å¤šæ¬¡RNNè®¡ç®—åï¼Œå·²ç»å¤±å»äº†åŸæœ‰çš„ç‰¹å¾ã€‚è¶Šåˆ°åé¢ï¼Œæœ€å‰é¢çš„å˜é‡å æ¯”å°±è¶Šå°ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆåäººç±»çš„è®¾è®¡ã€‚è€Œself-attentionåœ¨æ¯æ¬¡è®¡ç®—ä¸­éƒ½èƒ½ä¿è¯æ¯ä¸ªè¾“å…¥å˜é‡ açš„åˆå§‹å æ¯”æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ç»è¿‡self-attention layerè®¡ç®—åä»–çš„æ³¨æ„åŠ›ç³»æ•°æ˜¯å¯ä¿¡çš„ã€‚
æ‰€ä»¥æ€»ç»“ä¸‹æ¥ï¼Œå®ƒçš„ä¸‰ä¸ªä¼˜ç‚¹åˆ†åˆ«æ˜¯ï¼š
- éœ€è¦å­¦ä¹ çš„å‚æ•°é‡å°‘
- å¯ä»¥å¹¶è¡Œè®¡ç®—
- èƒ½å¤Ÿä¿è¯æ¯ä¸ªå˜é‡åˆå§‹å æ¯”æ˜¯ä¸€æ ·çš„

## ä»£ç å®ç°
```
import torch
import torch.nn as nn
import torch.nn.functional as F

class SelfAttention(nn.Module):
    def __init__(self, embed_size, num_heads):
        """
        åˆå§‹åŒ– SelfAttention å±‚
        
        å‚æ•°:
            embed_size (int): è¾“å…¥ç‰¹å¾çš„ç»´åº¦
            num_heads (int): æ³¨æ„åŠ›å¤´çš„æ•°é‡
        """
        super(SelfAttention, self).__init__()
        self.embed_size = embed_size
        self.num_heads = num_heads
        self.head_dim = embed_size // num_heads
        
        # ç¡®ä¿ embed_size èƒ½è¢« num_heads æ•´é™¤
        assert (
            self.head_dim * num_heads == embed_size
        ), "Embedding size needs to be divisible by heads"
        
        # åˆå§‹åŒ–çº¿æ€§å±‚
        self.values = nn.Linear(self.head_dim, self.head_dim, bias=False)
        self.keys = nn.Linear(self.head_dim, self.head_dim, bias=False)
        self.queries = nn.Linear(self.head_dim, self.head_dim, bias=False)
        self.fc_out = nn.Linear(num_heads * self.head_dim, embed_size)

    def forward(self, values, keys, query):
        """
        å‰å‘ä¼ æ’­å‡½æ•°
        
        å‚æ•°:
            values (Tensor): å€¼çš„å¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, value_len, embed_size)
            keys (Tensor): é”®çš„å¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, key_len, embed_size)
            query (Tensor): æŸ¥è¯¢çš„å¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, query_len, embed_size)
        
        è¿”å›:
            out (Tensor): è¾“å‡ºå¼ é‡ï¼Œå½¢çŠ¶ä¸º (batch_size, query_len, embed_size)
        """
        # è·å–å¼ é‡çš„å¤§å°
        N = query.shape[0]
        value_len, key_len, query_len = values.shape[1], keys.shape[1], query.shape[1]
        
        # å°†è¾“å…¥å¼ é‡æŒ‰å¤´æ•°å’Œå¤´ç»´åº¦è¿›è¡Œåˆ‡åˆ†
        values = values.reshape(N, value_len, self.num_heads, self.head_dim)
        keys = keys.reshape(N, key_len, self.num_heads, self.head_dim)
        queries = query.reshape(N, query_len, self.num_heads, self.head_dim)
        
        # é€šè¿‡çº¿æ€§å±‚è¿›è¡Œå˜æ¢
        values = self.values(values)
        keys = self.keys(keys)
        queries = self.queries(queries)
        
        # è®¡ç®—ç‚¹ç§¯æ³¨æ„åŠ›
        energy = torch.einsum("nqhd,nkhd->nhqk", [queries, keys]) # batch_size, num_heads, query_len, key_len
        
        # è®¡ç®—æ³¨æ„åŠ›æƒé‡
        attention = torch.nn.functional.softmax(energy / (self.embed_size ** (1/2)), dim=3)
        
        # å°†æ³¨æ„åŠ›æƒé‡åº”ç”¨åˆ°å€¼ä¸Š
        out = torch.einsum("nhql,nlhd->nqhd", [attention, values]).reshape(
            N, query_len, self.num_heads * self.head_dim
        )
        
        # åˆå¹¶å¤šä¸ªå¤´å¹¶é€šè¿‡çº¿æ€§å±‚è¿›è¡Œå˜æ¢
        out = self.fc_out(out)
        return out
```
# Multi-head self-attention
## ä¸ºä»€ä¹ˆè¦å¤šå¤´
åœ¨å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œæ¯ä¸ªæ³¨æ„åŠ›å¤´å­¦ä¹ ä¸åŒçš„ç‰¹å¾è¡¨ç¤ºï¼Œè¿™æ˜¯ä¸ºäº†æé«˜æ¨¡å‹çš„è¡¨å¾èƒ½åŠ›å’Œæ³›åŒ–èƒ½åŠ›ã€‚è¿™ç§è®¾è®¡å…è®¸æ¨¡å‹åœ¨ä¸åŒæŠ½è±¡çº§åˆ«ä¸Šå…³æ³¨è¾“å…¥çš„ä¸åŒéƒ¨åˆ†ï¼Œä»è€Œæ›´å¥½åœ°æ•è·è¾“å…¥ä¹‹é—´çš„å…³ç³»ã€‚

å…·ä½“æ¥è¯´ï¼Œæ¯ä¸ªæ³¨æ„åŠ›å¤´éƒ½æœ‰è‡ªå·±çš„æƒé‡çŸ©é˜µï¼ˆé€šå¸¸æ˜¯é€šè¿‡å­¦ä¹ å¾—åˆ°çš„ï¼‰ï¼Œè¿™äº›æƒé‡çŸ©é˜µå†³å®šäº†æ¯ä¸ªå¤´å¯¹è¾“å…¥çš„ä¸åŒéƒ¨åˆ†çš„å…³æ³¨ç¨‹åº¦ã€‚é€šè¿‡å…è®¸å¤šä¸ªå¤´å¹¶ä¸”æ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„ç‰¹å¾è¡¨ç¤ºï¼Œæ¨¡å‹å¯ä»¥åŒæ—¶å…³æ³¨è¾“å…¥çš„ä¸åŒæ–¹é¢ï¼Œä»è€Œæ›´å¥½åœ°æ•è·è¾“å…¥ä¹‹é—´çš„å¤æ‚å…³ç³»ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼Œè€ƒè™‘ä¸€ä¸ªç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†çš„ Transformer æ¨¡å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ³¨æ„åŠ›å¤´å¯ä»¥å­¦ä¹ å…³æ³¨å¥å­ä¸­çš„ä¸åŒå•è¯æˆ–çŸ­è¯­ï¼Œå…¶ä¸­ä¸€äº›å¤´å¯èƒ½æ›´å…³æ³¨ä¸»è¯­-è°“è¯­å…³ç³»ï¼Œå¦ä¸€äº›å¤´å¯èƒ½æ›´å…³æ³¨å®¾è¯­-è°“è¯­å…³ç³»ï¼Œè€Œå…¶ä»–å¤´å¯èƒ½å…³æ³¨å¥å­ä¸­çš„ä¿®é¥°è¯æˆ–è€…è¯­æ³•ç»“æ„ç­‰ã€‚é€šè¿‡å…è®¸æ¯ä¸ªå¤´å­¦ä¹ ä¸åŒçš„ç‰¹å¾è¡¨ç¤ºï¼Œæ¨¡å‹å¯ä»¥æ›´å¥½åœ°æ•è·å¥å­ä¸­ä¸åŒéƒ¨åˆ†ä¹‹é—´çš„è¯­ä¹‰å…³ç³»ï¼Œä»è€Œæé«˜äº†æ¨¡å‹çš„æ€§èƒ½ã€‚

æ€»çš„æ¥è¯´ï¼Œå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹ä»¥å¤šä¸ªä¸åŒçš„è§†è§’æ¥è§‚å¯Ÿè¾“å…¥æ•°æ®ï¼Œä»è€Œæé«˜äº†æ¨¡å‹å¯¹è¾“å…¥æ•°æ®çš„è¡¨å¾èƒ½åŠ›å’Œæ³›åŒ–èƒ½åŠ›ã€‚
## åŸç†
### é€šä¿—æ˜“æ‡‚ç†è§£
multi-head self-attentionï¼Œæ‰€è°“headä¹Ÿå°±æ˜¯æŒ‡ä¸€ä¸ªa è¡ç”Ÿå‡ºå‡ ä¸ªq , k , v ã€‚ä¸Šè¿°æ‰€è®²è§£çš„self-attentionæ˜¯åŸºäºsingle-headçš„ã€‚ä»¥2 headä¸ºä¾‹ï¼š
é¦–å…ˆï¼Œ$a^i$å…ˆç”Ÿæˆ$q^1$,$k^1$,$v^1$,ç„¶åï¼Œæ¥ä¸‹æ¥å°±å’Œsingle-headä¸ä¸€æ ·äº†ï¼Œ$q^i$ç”Ÿæˆ$q^{i,1},q^{i,2}$ç”Ÿæˆçš„æ–¹å¼æœ‰ä¸¤ç§ï¼š
1. $q^i$ä¹˜ä¸Šä¸€ä¸ª$W^{q,1}$å¾—åˆ°$q^{i,2}$ï¼Œè¿™ä¸ªå’Œsingle-headçš„ç”Ÿæˆæ˜¯å·®ä¸å¤šçš„ï¼›
2. $q^i$ç›´æ¥ä»é€šé“ç»´ï¼Œå¹³å‡æ‹†åˆ†æˆä¸¤ä¸ªï¼Œå¾—åˆ°$q^{i,1},q^{i,2}$

 è¿™ä¸¤ç§æ–¹å¼ï¼Œåœ¨æœ€åç»“æœä¸Šéƒ½å·®ä¸å¤šã€‚è‡³äºä¸ºå•¥ï¼Œåé¢ä¼šè®²ä¸€ä¸‹åŸå› ã€‚
é‚£ä¹ˆè¿™é‡Œçš„å›¾è§£ä½¿ç”¨ç¬¬1ä¸ªæ–¹å¼ï¼Œå…ˆå¾—åˆ°$q^{i,1}$,$k^{i,1}$,$v^{i,1}$ã€‚å¯¹$a^j$åšåŒæ ·çš„æ“ä½œå¾—åˆ°
,å¯¹$a^j$åšåŒæ ·çš„æ“ä½œå¾—åˆ°$q^{j,1}$,$k^{j,1}$,$v^{j,1}$ã€‚è¿™è¾¹éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼Œ$q^{i,1}$æ˜¯è¦å’Œ$k^{j,1}$åšçŸ©é˜µä¹˜æ³•ï¼Œè€Œé$k^{j,2}$ï¼Œä¸€ä¸€å¯¹åº”ã€‚åé¢è®¡ç®—å°±å’Œsingle-headä¸€æ ·äº†ï¼Œæœ€åå¾—åˆ°$b^{i,1}$
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/f632d4373743df255fa6b8ad32bacf91.png)
ç¬¬äºŒæ­¥ï¼Œå¯¹$q^{i,2}$,$k^{i,2}$,$v^{i,2}$åšä¸€æ ·çš„æ“ä½œï¼Œå¾—åˆ°$b^{i,2}$
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/305a71e0af123935786dc2abbf618dc5.png)
è¿™é‡Œæˆ‘ä»¬ç®—å‡ºçš„$b^{i,1}$,$b^{i,2}$æ˜¯åŒç»´åº¦çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶concatåœ¨ä¸€èµ·ï¼Œå†é€šè¿‡ä¸€ä¸ª$W^0$æŠŠä»–è½¬æˆæƒ³è¦çš„ç»´åº¦ã€‚è¿™ä¹Ÿå°±ä¸éš¾ç†è§£ï¼Œä¸ºä»€ä¹ˆè¯´multi-headçš„ä¸¤ç§ç”Ÿæˆæ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºæœ€ç»ˆå†³å®šæ˜¯è¾“å‡ºç»´åº¦çš„æ˜¯$W^o$ã€‚æˆ‘ä»¬å¯ä»¥å°†multi-headçš„è¿‡ç¨‹çœ‹æˆæ˜¯cnnä¸­çš„éšè—å±‚ï¼Œmulti-headçš„æ•°é‡ä¹Ÿå°±å¯¹åº”ç€Conv2Dçš„filteræ•°é‡ï¼Œæ¯ä¸€ä¸ªheadå„å¸å…¶èŒï¼Œæå–ä¸åŒçš„ç‰¹å¾ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/3165ecd94c9fe68848f035ada2e2eb85.png)
### çŸ©é˜µè®¡ç®—
æˆ‘ä»¬å·²ç»çŸ¥é“æ€ä¹ˆé€šè¿‡ Self-Attention è®¡ç®—å¾—åˆ°è¾“å‡ºçŸ©é˜µ Zï¼Œè€Œ Multi-Head Attention æ˜¯ç”±å¤šä¸ª Self-Attention ç»„åˆå½¢æˆçš„ï¼Œä¸‹å›¾æ˜¯è®ºæ–‡ä¸­ Multi-Head Attention çš„ç»“æ„å›¾ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/8d199cf84adf9f7055ce4d1fa78e6053.png)
ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° Multi-Head Attention åŒ…å«å¤šä¸ª Self-Attention å±‚ï¼Œé¦–å…ˆå°†è¾“å…¥Xåˆ†åˆ«ä¼ é€’åˆ° h ä¸ªä¸åŒçš„ Self-Attention ä¸­ï¼Œè®¡ç®—å¾—åˆ° h ä¸ªè¾“å‡ºçŸ©é˜µZã€‚ä¸‹å›¾æ˜¯ h=8 æ—¶å€™çš„æƒ…å†µï¼Œæ­¤æ—¶ä¼šå¾—åˆ° 8 ä¸ªè¾“å‡ºçŸ©é˜µZã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/8bc4cd56e86c5cf56eebf3a173275ea2.png)
å¾—åˆ° 8 ä¸ªè¾“å‡ºçŸ©é˜µ$Z_1$åˆ°$Z_8$ä¹‹åï¼ŒMulti-Head Attention å°†å®ƒä»¬æ‹¼æ¥åœ¨ä¸€èµ· (Concat)ï¼Œç„¶åä¼ å…¥ä¸€ä¸ªLinearå±‚ï¼Œå¾—åˆ° Multi-Head Attention æœ€ç»ˆçš„è¾“å‡ºZã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/522a1aaa7f1b6b4ee46183b85a1da8d1.png)
å¯ä»¥çœ‹åˆ° Multi-Head Attention è¾“å‡ºçš„çŸ©é˜µZä¸å…¶è¾“å…¥çš„çŸ©é˜µXçš„ç»´åº¦æ˜¯ä¸€æ ·çš„ã€‚
## ä»£ç å®ç°
```
import torch
import torch.nn.functional as F

class MultiHeadSelfAttention(torch.nn.Module):
    def __init__(self, d_model, num_heads):
        super(MultiHeadSelfAttention, self).__init__()
        self.num_heads = num_heads
        self.d_model = d_model
        assert d_model % num_heads == 0  # ç¡®ä¿ d_model å¯ä»¥è¢« num_heads æ•´é™¤
        
        # åˆå§‹åŒ– Qã€Kã€V çŸ©é˜µå’Œè¾“å‡ºçŸ©é˜µ
        self.W_q = torch.nn.Linear(d_model, d_model)
        self.W_k = torch.nn.Linear(d_model, d_model)
        self.W_v = torch.nn.Linear(d_model, d_model)
        self.W_o = torch.nn.Linear(d_model, d_model)
        
    def forward(self, x):
        batch_size, seq_len, d_model = x.size()
        # å°†è¾“å…¥ x æ‹†åˆ†æˆ num_heads ä¸ªå¤´
        Q = self.W_q(x).view(batch_size, seq_len, self.num_heads, d_model // self.num_heads)
        K = self.W_k(x).view(batch_size, seq_len, self.num_heads, d_model // self.num_heads)
        V = self.W_v(x).view(batch_size, seq_len, self.num_heads, d_model // self.num_heads)
        
        # å¯¹æ¯ä¸ªå¤´è¿›è¡Œ scaled dot-product attention
        attention_scores = torch.matmul(Q, K.transpose(1, 2)) / (d_model ** 0.5)
        attention_probs = F.softmax(attention_scores, dim=-1)
        attention_output = torch.matmul(attention_probs, V)
        
        # å°†æ¯ä¸ªå¤´çš„è¾“å‡ºæ‹¼æ¥èµ·æ¥
        attention_output = attention_output.view(batch_size, seq_len, d_model)
        
        # ç»è¿‡çº¿æ€§å˜æ¢å¾—åˆ°æœ€ç»ˆçš„è¾“å‡º
        output = self.W_o(attention_output)
        return output

# ä¸ºäº†æµ‹è¯•
d_model = 512  # æ¨¡å‹çš„ç»´åº¦
num_heads = 8  # å¤´çš„æ•°é‡
seq_len = 10   # åºåˆ—é•¿åº¦
batch_size = 4 # æ‰¹æ¬¡å¤§å°

# åˆ›å»ºä¸€ä¸ªéšæœºè¾“å…¥å¼ é‡
x = torch.rand(batch_size, seq_len, d_model)

# åˆ›å»º Multi-Head Self-Attention æ¨¡å—å¹¶è¿›è¡Œå‰å‘ä¼ æ’­
multihead_attention = MultiHeadSelfAttention(d_model, num_heads)
output = multihead_attention(x)

# æ‰“å°è¾“å‡ºå¼ é‡çš„å½¢çŠ¶
print("Output shape:", output.shape)
```
