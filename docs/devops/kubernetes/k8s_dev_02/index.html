<!DOCTYPE html>
<html lang="zh" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.150.0">
    <meta name="generator" content="Relearn 8.0.1+b23cf6629eada0c2802f34ae4012e04343497862">
    <meta name="description" content="组件概览 关于k8s整体架构，可参考：之前文章 Kubernetes主要由以下几个核心组件组成（必须安装）：
etcd保存了整个集群的状态； apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制； controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等； scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上； kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理，安装每台工作节点； kube-proxy负责为Service提供cluster内部的服务发现和负载均衡，安装在每台工作节点； 除了核心组件，还有一些推荐的Add-ons（选装）： kube-dns负责为整个集群提供DNS服务，应该使用kubectl添加一个服务到容器，是一个发布的应用服务于 其中kubelet是二进制安装包，其他组件均为docker镜像，kubeadm负责拉取镜像并初始化环境。 kubectl是客户端管理工具，同样是个二进制。 所以kubelet,kubeadm,kubectl需要通过yum|apt-get安装，其他组件通过kubeadm安装。
安装k8s 最简单，成功率最高的安装方式其实是使用rke安装，这里使用kubeadmin是想知道每个组件的单独原理和作用，具体安装教程参考：https://docs.rancher.cn/docs/rke/installation/_index/。
已经安装如果需要清除，可按照此步骤处理(重置k8s，删除所有运行容易和镜像)
kubeadm reset docker ps -a | awk &#39;{if(NR&gt;1){print $1;system(&#34;docker stop &#34;$1);system(&#34;docker rm &#34;$1)}}&#39;; docker images | awk &#39;{system(&#34;docker rmi &#34;$3)}&#39; rm -rf $HOME/.kube 同时清除下面安装网络章节的网络相关文件 准备机器 这里使用debian环境，主备一主一从两台机器，最好固定ip，ip最好在同一网段
k8s-master 10.10.0.115 k8s-worker 10.10.0.116 安装kubelet，kubeadm，kubectl，两台机器均相同 确保两台机器提前安装包docker
apt-get install docker-ce 设置阿里云源 sudo vim /etc/apt/sources.list.d/kubernetes.list # 将下面的阿里源加入文件中 deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main # 也可以选择中科大的源 deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main 里先运行一下 apt update, 会报错，原因是缺少相应的key，可以通过下面的命令添加(E084DAB9 为上面报错的key后8位)
gpg --keyserver keyserver.ubuntu.com --recv-keys E084DAB9 gpg --export --armor E084DAB9 | sudo apt-key add - 下载安装 apt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubectl 关闭swap 如果不关闭kubernetes运行会出现错误， 即使安装成功了，node重启后也会出现kubernetes server运行错误。">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="K8S二次开发02-kubeadm安装k8s集群 :: liaomin416100569博客">
    <meta name="twitter:description" content="组件概览 关于k8s整体架构，可参考：之前文章 Kubernetes主要由以下几个核心组件组成（必须安装）：
etcd保存了整个集群的状态； apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制； controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等； scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上； kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理，安装每台工作节点； kube-proxy负责为Service提供cluster内部的服务发现和负载均衡，安装在每台工作节点； 除了核心组件，还有一些推荐的Add-ons（选装）： kube-dns负责为整个集群提供DNS服务，应该使用kubectl添加一个服务到容器，是一个发布的应用服务于 其中kubelet是二进制安装包，其他组件均为docker镜像，kubeadm负责拉取镜像并初始化环境。 kubectl是客户端管理工具，同样是个二进制。 所以kubelet,kubeadm,kubectl需要通过yum|apt-get安装，其他组件通过kubeadm安装。
安装k8s 最简单，成功率最高的安装方式其实是使用rke安装，这里使用kubeadmin是想知道每个组件的单独原理和作用，具体安装教程参考：https://docs.rancher.cn/docs/rke/installation/_index/。
已经安装如果需要清除，可按照此步骤处理(重置k8s，删除所有运行容易和镜像)
kubeadm reset docker ps -a | awk &#39;{if(NR&gt;1){print $1;system(&#34;docker stop &#34;$1);system(&#34;docker rm &#34;$1)}}&#39;; docker images | awk &#39;{system(&#34;docker rmi &#34;$3)}&#39; rm -rf $HOME/.kube 同时清除下面安装网络章节的网络相关文件 准备机器 这里使用debian环境，主备一主一从两台机器，最好固定ip，ip最好在同一网段
k8s-master 10.10.0.115 k8s-worker 10.10.0.116 安装kubelet，kubeadm，kubectl，两台机器均相同 确保两台机器提前安装包docker
apt-get install docker-ce 设置阿里云源 sudo vim /etc/apt/sources.list.d/kubernetes.list # 将下面的阿里源加入文件中 deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main # 也可以选择中科大的源 deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main 里先运行一下 apt update, 会报错，原因是缺少相应的key，可以通过下面的命令添加(E084DAB9 为上面报错的key后8位)
gpg --keyserver keyserver.ubuntu.com --recv-keys E084DAB9 gpg --export --armor E084DAB9 | sudo apt-key add - 下载安装 apt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubectl 关闭swap 如果不关闭kubernetes运行会出现错误， 即使安装成功了，node重启后也会出现kubernetes server运行错误。">
    <meta property="og:url" content="https://jiaozi789.github.io/docs/devops/kubernetes/k8s_dev_02/index.html">
    <meta property="og:site_name" content="liaomin416100569博客">
    <meta property="og:title" content="K8S二次开发02-kubeadm安装k8s集群 :: liaomin416100569博客">
    <meta property="og:description" content="组件概览 关于k8s整体架构，可参考：之前文章 Kubernetes主要由以下几个核心组件组成（必须安装）：
etcd保存了整个集群的状态； apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制； controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等； scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上； kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理，安装每台工作节点； kube-proxy负责为Service提供cluster内部的服务发现和负载均衡，安装在每台工作节点； 除了核心组件，还有一些推荐的Add-ons（选装）： kube-dns负责为整个集群提供DNS服务，应该使用kubectl添加一个服务到容器，是一个发布的应用服务于 其中kubelet是二进制安装包，其他组件均为docker镜像，kubeadm负责拉取镜像并初始化环境。 kubectl是客户端管理工具，同样是个二进制。 所以kubelet,kubeadm,kubectl需要通过yum|apt-get安装，其他组件通过kubeadm安装。
安装k8s 最简单，成功率最高的安装方式其实是使用rke安装，这里使用kubeadmin是想知道每个组件的单独原理和作用，具体安装教程参考：https://docs.rancher.cn/docs/rke/installation/_index/。
已经安装如果需要清除，可按照此步骤处理(重置k8s，删除所有运行容易和镜像)
kubeadm reset docker ps -a | awk &#39;{if(NR&gt;1){print $1;system(&#34;docker stop &#34;$1);system(&#34;docker rm &#34;$1)}}&#39;; docker images | awk &#39;{system(&#34;docker rmi &#34;$3)}&#39; rm -rf $HOME/.kube 同时清除下面安装网络章节的网络相关文件 准备机器 这里使用debian环境，主备一主一从两台机器，最好固定ip，ip最好在同一网段
k8s-master 10.10.0.115 k8s-worker 10.10.0.116 安装kubelet，kubeadm，kubectl，两台机器均相同 确保两台机器提前安装包docker
apt-get install docker-ce 设置阿里云源 sudo vim /etc/apt/sources.list.d/kubernetes.list # 将下面的阿里源加入文件中 deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main # 也可以选择中科大的源 deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main 里先运行一下 apt update, 会报错，原因是缺少相应的key，可以通过下面的命令添加(E084DAB9 为上面报错的key后8位)
gpg --keyserver keyserver.ubuntu.com --recv-keys E084DAB9 gpg --export --armor E084DAB9 | sudo apt-key add - 下载安装 apt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubectl 关闭swap 如果不关闭kubernetes运行会出现错误， 即使安装成功了，node重启后也会出现kubernetes server运行错误。">
    <meta property="og:locale" content="zh">
    <meta property="og:type" content="article">
    <meta property="article:section" content="运维一体化">
    <meta property="article:published_time" content="2025-09-18T16:55:17+08:00">
    <meta property="article:modified_time" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="name" content="K8S二次开发02-kubeadm安装k8s集群 :: liaomin416100569博客">
    <meta itemprop="description" content="组件概览 关于k8s整体架构，可参考：之前文章 Kubernetes主要由以下几个核心组件组成（必须安装）：
etcd保存了整个集群的状态； apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制； controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等； scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上； kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理，安装每台工作节点； kube-proxy负责为Service提供cluster内部的服务发现和负载均衡，安装在每台工作节点； 除了核心组件，还有一些推荐的Add-ons（选装）： kube-dns负责为整个集群提供DNS服务，应该使用kubectl添加一个服务到容器，是一个发布的应用服务于 其中kubelet是二进制安装包，其他组件均为docker镜像，kubeadm负责拉取镜像并初始化环境。 kubectl是客户端管理工具，同样是个二进制。 所以kubelet,kubeadm,kubectl需要通过yum|apt-get安装，其他组件通过kubeadm安装。
安装k8s 最简单，成功率最高的安装方式其实是使用rke安装，这里使用kubeadmin是想知道每个组件的单独原理和作用，具体安装教程参考：https://docs.rancher.cn/docs/rke/installation/_index/。
已经安装如果需要清除，可按照此步骤处理(重置k8s，删除所有运行容易和镜像)
kubeadm reset docker ps -a | awk &#39;{if(NR&gt;1){print $1;system(&#34;docker stop &#34;$1);system(&#34;docker rm &#34;$1)}}&#39;; docker images | awk &#39;{system(&#34;docker rmi &#34;$3)}&#39; rm -rf $HOME/.kube 同时清除下面安装网络章节的网络相关文件 准备机器 这里使用debian环境，主备一主一从两台机器，最好固定ip，ip最好在同一网段
k8s-master 10.10.0.115 k8s-worker 10.10.0.116 安装kubelet，kubeadm，kubectl，两台机器均相同 确保两台机器提前安装包docker
apt-get install docker-ce 设置阿里云源 sudo vim /etc/apt/sources.list.d/kubernetes.list # 将下面的阿里源加入文件中 deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main # 也可以选择中科大的源 deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main 里先运行一下 apt update, 会报错，原因是缺少相应的key，可以通过下面的命令添加(E084DAB9 为上面报错的key后8位)
gpg --keyserver keyserver.ubuntu.com --recv-keys E084DAB9 gpg --export --armor E084DAB9 | sudo apt-key add - 下载安装 apt-get update &amp;&amp; apt-get install -y kubelet kubeadm kubectl 关闭swap 如果不关闭kubernetes运行会出现错误， 即使安装成功了，node重启后也会出现kubernetes server运行错误。">
    <meta itemprop="datePublished" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="dateModified" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="wordCount" content="2496">
    <title>K8S二次开发02-kubeadm安装k8s集群 :: liaomin416100569博客</title>
    <link href="/docs/css/auto-complete/auto-complete.min.css?1758355652" rel="stylesheet">
    <script src="/docs/js/auto-complete/auto-complete.min.js?1758355652" defer></script>
    <script src="/docs/js/search-lunr.min.js?1758355652" defer></script>
    <script src="/docs/js/search.min.js?1758355652" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/docs/searchindex.en.js?1758355652";
    </script>
    <script src="/docs/js/lunr/lunr.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.stemmer.support.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.multi.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.zh.min.js?1758355652" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['zh'];
    </script>
    <link href="/docs/fonts/fontawesome/css/fontawesome-all.min.css?1758355652" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/docs/fonts/fontawesome/css/fontawesome-all.min.css?1758355652" rel="stylesheet"></noscript>
    <link href="/docs/css/perfect-scrollbar/perfect-scrollbar.min.css?1758355652" rel="stylesheet">
    <link href="/docs/css/theme.min.css?1758355652" rel="stylesheet">
    <link href="/docs/css/format-html.min.css?1758355652" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/devops\/kubernetes\/k8s_dev_02\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/jiaozi789.github.io\/docs';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'auto' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
    <link href="/docs/css/custom.css?1758355652" rel="stylesheet">
  </head>
  <body class="mobile-support html" data-url="/docs/devops/kubernetes/k8s_dev_02/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#组件概览">组件概览</a></li>
    <li><a href="#安装k8s">安装k8s</a>
      <ul>
        <li><a href="#准备机器">准备机器</a></li>
        <li><a href="#设置阿里云源">设置阿里云源</a></li>
        <li><a href="#下载安装">下载安装</a></li>
        <li><a href="#关闭swap">关闭swap</a></li>
        <li><a href="#获取镜像">获取镜像</a></li>
        <li><a href="#主节点">主节点</a>
          <ul>
            <li><a href="#初始化">初始化</a></li>
            <li><a href="#安装网络">安装网络</a></li>
          </ul>
        </li>
        <li><a href="#worker节点">worker节点</a></li>
        <li><a href="#异常问题">异常问题</a>
          <ul>
            <li><a href="#calico容器异常">calico容器异常</a></li>
            <li><a href="#无法ping通clusterip和服务名">无法ping通clusterip和服务名</a></li>
          </ul>
        </li>
        <li><a href="#发布测试">发布测试</a></li>
        <li><a href="#重新启动">重新启动</a></li>
        <li><a href="#图形管理工具">图形管理工具</a>
          <ul>
            <li><a href="#安装">安装</a></li>
            <li><a href="#获取token">获取Token</a></li>
            <li><a href="#kuboard-v3x">Kuboard v3.x</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/index.html"><span itemprop="name">liaomin416100569博客</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/devops/index.html"><span itemprop="name">运维一体化</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/devops/kubernetes/index.html"><span itemprop="name">kubernetes</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">K8S二次开发02-kubeadm安装k8s集群</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/docs/devops/kubernetes/k8s_dev_01/index.html" title="K8S二次开发01-各种资源对象的理解和定义 (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/docs/devops/kubernetes/k8s_dev_03/index.html" title="K8S二次开发03-CRD资源详解 (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable devops" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="k8s二次开发02-kubeadm安装k8s集群">K8S二次开发02-kubeadm安装k8s集群</h1>

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']]
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

<h1 id="组件概览">组件概览</h1>
<p>关于k8s整体架构，可参考：<a href="https://blog.csdn.net/liaomin416100569/article/details/86711655?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164447827216780265446300%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=164447827216780265446300&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-86711655.nonecase&utm_term=k8s&spm=1018.2226.3001.4450" rel="external" target="_blank">之前文章</a>
<a href="#R-image-b686a1554a9c6546ecffd0779b023e61" class="lightbox-link"><img alt="在这里插入图片描述" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/cc3f01cec211b1e4ef3e34775820ef65.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-b686a1554a9c6546ecffd0779b023e61"><img alt="在这里插入图片描述" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/cc3f01cec211b1e4ef3e34775820ef65.png"></a>
Kubernetes主要由以下几个核心组件组成（必须安装）：</p>
<ul>
<li>etcd保存了整个集群的状态；</li>
<li>apiserver提供了资源操作的唯一入口，并提供认证、授权、访问控制、API注册和发现等机制；</li>
<li>controller manager负责维护集群的状态，比如故障检测、自动扩展、滚动更新等；</li>
<li>scheduler负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上；</li>
<li>kubelet负责维护容器的生命周期，同时也负责Volume（CVI）和网络（CNI）的管理，安装每台工作节点；</li>
<li>kube-proxy负责为Service提供cluster内部的服务发现和负载均衡，安装在每台工作节点；
除了核心组件，还有一些推荐的Add-ons（选装）：</li>
<li>kube-dns负责为整个集群提供DNS服务，应该使用kubectl添加一个服务到容器，是一个发布的应用服务于</li>
</ul>
<p>其中kubelet是二进制安装包，其他组件均为docker镜像，kubeadm负责拉取镜像并初始化环境。
kubectl是客户端管理工具，同样是个二进制。
所以kubelet,kubeadm,kubectl需要通过yum|apt-get安装，其他组件通过kubeadm安装。</p>
<h1 id="安装k8s">安装k8s</h1>
<blockquote>
<p>最简单，成功率最高的安装方式其实是使用rke安装，这里使用kubeadmin是想知道每个组件的单独原理和作用，具体安装教程参考：https://docs.rancher.cn/docs/rke/installation/_index/。</p></blockquote>
<p>已经安装如果需要清除，可按照此步骤处理(重置k8s，删除所有运行容易和镜像)</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">reset</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">ps</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">a</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;{if(NR&gt;1){print $1;system(&#34;docker stop &#34;$1);system(&#34;docker rm &#34;$1)}}&#39;</span>;                
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">images</span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;{system(&#34;docker rmi &#34;$3)}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rm</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">rf</span> <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">同时清除下面安装网络章节的网络相关文件</span></span></span></code></pre></div>
<h2 id="准备机器">准备机器</h2>
<p>这里使用debian环境，主备一主一从两台机器，最好固定ip，ip最好在同一网段</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">k8s</span><span style="color:#f92672">-</span><span style="color:#a6e22e">master</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">k8s</span><span style="color:#f92672">-</span><span style="color:#a6e22e">worker</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.116</span></span></span></code></pre></div>
<p>安装kubelet，kubeadm，kubectl，两台机器均相同
确保两台机器提前安装包docker</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">apt</span><span style="color:#f92672">-</span><span style="color:#a6e22e">get</span> <span style="color:#a6e22e">install</span> <span style="color:#a6e22e">docker</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ce</span></span></span></code></pre></div>
<h2 id="设置阿里云源">设置阿里云源</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">vim</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apt</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sources</span>.<span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">d</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">将下面的阿里源加入文件中</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">deb</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">也可以选择中科大的源</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">deb</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main
</span></span></span></code></pre></div>
<p>里先运行一下 apt update, 会报错，原因是缺少相应的key，可以通过下面的命令添加(E084DAB9 为上面报错的key后8位)</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">gpg</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">keyserver</span> <span style="color:#a6e22e">keyserver</span>.<span style="color:#a6e22e">ubuntu</span>.<span style="color:#a6e22e">com</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">recv</span><span style="color:#f92672">-</span><span style="color:#a6e22e">keys</span> <span style="color:#a6e22e">E084DAB9</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gpg</span> <span style="color:#f92672">--</span><span style="color:#66d9ef">export</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">armor</span> <span style="color:#a6e22e">E084DAB9</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">apt</span><span style="color:#f92672">-</span><span style="color:#a6e22e">key</span> <span style="color:#a6e22e">add</span> <span style="color:#f92672">-</span></span></span></code></pre></div>
<h2 id="下载安装">下载安装</h2>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">apt</span><span style="color:#f92672">-</span><span style="color:#a6e22e">get</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">apt</span><span style="color:#f92672">-</span><span style="color:#a6e22e">get</span> <span style="color:#a6e22e">install</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">y</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">kubectl</span></span></span></code></pre></div>
<h2 id="关闭swap">关闭swap</h2>
<p>如果不关闭kubernetes运行会出现错误， 即使安装成功了，node重启后也会出现kubernetes server运行错误。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">暂时关闭</span><span style="color:#960050;background-color:#1e0010">，</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">swapoff</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">a</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">永久关闭</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vim</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fstab</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">注释掉swap那一行就行</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">虚拟机最好把内存分配调整到2G以上</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">否则关掉swap会导致图形界面难以进入</span><span style="color:#960050;background-color:#1e0010">。</span></span></span></code></pre></div>
<p>我这里是注释最后一行</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# more /etc/fstab</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fstab</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">system</span> <span style="color:#a6e22e">information</span>.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Use</span> <span style="color:#e6db74">&#39;blkid&#39;</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">print</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">universally</span> <span style="color:#a6e22e">unique</span> <span style="color:#a6e22e">identifier</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">device</span>; <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">may</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">used</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">UUID</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">more</span> <span style="color:#a6e22e">robust</span> <span style="color:#a6e22e">way</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">devices</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">that</span> <span style="color:#a6e22e">works</span> <span style="color:#a6e22e">even</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">disks</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">added</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">removed</span>. <span style="color:#a6e22e">See</span> <span style="color:#a6e22e">fstab</span>(<span style="color:#ae81ff">5</span>).
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">file</span> <span style="color:#a6e22e">system</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">mount</span> <span style="color:#a6e22e">point</span><span style="color:#f92672">&gt;</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">type</span><span style="color:#f92672">&gt;</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">options</span><span style="color:#f92672">&gt;</span>       <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">dump</span><span style="color:#f92672">&gt;</span>  <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">pass</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">was</span> <span style="color:#a6e22e">on</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sda1</span> <span style="color:#a6e22e">during</span> <span style="color:#a6e22e">installation</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">UUID</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span><span style="color:#a6e22e">c86df1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9442</span><span style="color:#f92672">-</span><span style="color:#ae81ff">46</span><span style="color:#a6e22e">c0</span><span style="color:#f92672">-</span><span style="color:#a6e22e">a29c</span><span style="color:#f92672">-</span><span style="color:#a6e22e">b8f7d0a421ab</span> <span style="color:#f92672">/</span>               <span style="color:#a6e22e">ext4</span>    <span style="color:#a6e22e">errors</span><span style="color:#f92672">=</span><span style="color:#a6e22e">remount</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ro</span> <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">swap</span> <span style="color:#a6e22e">was</span> <span style="color:#a6e22e">on</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sda5</span> <span style="color:#a6e22e">during</span> <span style="color:#a6e22e">installation</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">UUID</span><span style="color:#f92672">=</span><span style="color:#a6e22e">e4e792e9</span><span style="color:#f92672">-</span><span style="color:#a6e22e">d30b</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4e4</span><span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ab3c</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span><span style="color:#a6e22e">bd488adaae</span> <span style="color:#a6e22e">none</span>            <span style="color:#a6e22e">swap</span>    <span style="color:#a6e22e">sw</span>              <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sr0</span>        <span style="color:#f92672">/</span><span style="color:#a6e22e">media</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cdrom0</span>   <span style="color:#a6e22e">udf</span>,<span style="color:#a6e22e">iso9660</span> <span style="color:#a6e22e">user</span>,<span style="color:#a6e22e">noauto</span>     <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span></span></span></code></pre></div>
<h2 id="获取镜像">获取镜像</h2>
<p>由于官方镜像地址被墙，所以我们需要首先获取所需镜像以及它们的版本。然后从国内阿里的镜像站获取。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">config</span> <span style="color:#a6e22e">images</span> <span style="color:#a6e22e">list</span></span></span></code></pre></div>
<p>获取镜像列表后可以通过下面的脚本从阿里云获取：</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#e6db74">`kubeadm config images list`</span>; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">coredns镜像在gcr</span>.<span style="color:#a6e22e">io上是k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">:</span><span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">8.6</span> <span style="color:#a6e22e">在阿里云上是</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">:</span><span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">8.6</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">需要特殊处理</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">echo</span> <span style="color:#a6e22e">$i</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">grep</span> <span style="color:#a6e22e">coredns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span>;<span style="color:#a6e22e">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imageName</span><span style="color:#f92672">=</span><span style="color:#a6e22e">$</span>{<span style="color:#a6e22e">i</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">/</span>}  
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">pull</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">tag</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span> <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">rmi</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imageName</span><span style="color:#f92672">=</span><span style="color:#a6e22e">$</span>{<span style="color:#a6e22e">i</span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">pull</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">tag</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span> <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">docker</span> <span style="color:#a6e22e">rmi</span> <span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#f92672">/</span><span style="color:#a6e22e">$imageName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fi</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">done</span>;</span></span></code></pre></div>
<h2 id="主节点">主节点</h2>
<h3 id="初始化">初始化</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">init</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">service</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cidr</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.96</span>.<span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">12</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">-</span><span style="color:#a6e22e">repository</span><span style="color:#f92672">=</span><span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">network</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cidr</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.244</span>.<span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span> 
</span></span></code></pre></div>
<p>初始化可常用的参数：</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span> <span style="color:#a6e22e">参数说明</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">apiserver</span><span style="color:#f92672">-</span><span style="color:#a6e22e">advertise</span><span style="color:#f92672">-</span><span style="color:#a6e22e">address</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>    <span style="color:#a6e22e">这个参数就是master主机的IP地址</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">例如我的Master主机的IP是</span><span style="color:#960050;background-color:#1e0010">：</span><span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">-</span><span style="color:#a6e22e">repository</span><span style="color:#f92672">=</span><span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span>  <span style="color:#a6e22e">这个是镜像地址</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">由于国外地址无法访问</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">故使用的阿里云仓库地址</span><span style="color:#960050;background-color:#1e0010">：</span><span style="color:#a6e22e">registry</span>.<span style="color:#a6e22e">aliyuncs</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">google_containers</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">如果不指定就需要做下面获取镜像章节的动作</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">kubernetes</span><span style="color:#f92672">-</span><span style="color:#a6e22e">version</span><span style="color:#f92672">=</span><span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">17.4</span>   <span style="color:#a6e22e">这个参数是下载的k8s软件版本号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">service</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cidr</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.96</span>.<span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">12</span>       <span style="color:#a6e22e">这个参数后的IP地址直接就套用10</span>.<span style="color:#ae81ff">96.0</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">12</span> ,<span style="color:#a6e22e">以后安装时也套用即可</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">不要更改</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">--</span><span style="color:#a6e22e">pod</span><span style="color:#f92672">-</span><span style="color:#a6e22e">network</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cidr</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.244</span>.<span style="color:#ae81ff">0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>       <span style="color:#a6e22e">k8s内部的pod节点之间网络可以使用的IP段</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">不能和service</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cidr写一样</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">如果不知道怎么配</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">就先用这个10</span>.<span style="color:#ae81ff">244.0</span>.<span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span></span></span></code></pre></div>
<p>一般都会报错</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>[<span style="color:#a6e22e">wait</span><span style="color:#f92672">-</span><span style="color:#a6e22e">control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plane</span>] <span style="color:#a6e22e">Waiting</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">boot</span> <span style="color:#a6e22e">up</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">control</span> <span style="color:#a6e22e">plane</span> <span style="color:#a6e22e">as</span> <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">Pods</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">directory</span> <span style="color:#e6db74">&#34;/etc/kubernetes/manifests&#34;</span>. <span style="color:#a6e22e">This</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">take</span> <span style="color:#a6e22e">up</span> <span style="color:#a6e22e">to</span> <span style="color:#ae81ff">4</span><span style="color:#a6e22e">m0s</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">kubelet</span><span style="color:#f92672">-</span><span style="color:#a6e22e">check</span>] <span style="color:#a6e22e">Initial</span> <span style="color:#a6e22e">timeout</span> <span style="color:#66d9ef">of</span> <span style="color:#ae81ff">40</span><span style="color:#a6e22e">s</span> <span style="color:#a6e22e">passed</span>.
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">kubelet</span><span style="color:#f92672">-</span><span style="color:#a6e22e">check</span>] <span style="color:#a6e22e">It</span> <span style="color:#a6e22e">seems</span> <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">isn</span><span style="color:#e6db74">&#39;t running or healthy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubelet-check] The HTTP call equal to &#39;</span><span style="color:#a6e22e">curl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">sSL</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//localhost:10248/healthz&#39; failed with error: Get &#34;http://localhost:10248/healthz&#34;: dial tcp [::1]:10248: connect: connection refused.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[<span style="color:#a6e22e">kubelet</span><span style="color:#f92672">-</span><span style="color:#a6e22e">check</span>] <span style="color:#a6e22e">It</span> <span style="color:#a6e22e">seems</span> <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">isn</span><span style="color:#e6db74">&#39;t running or healthy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubelet-check] The HTTP call equal to &#39;</span><span style="color:#a6e22e">curl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">sSL</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//localhost:10248/healthz&#39; failed with error: Get &#34;http://localhost:10248/healthz&#34;: dial tcp [::1]:10248: connect: connection refused.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[<span style="color:#a6e22e">kubelet</span><span style="color:#f92672">-</span><span style="color:#a6e22e">check</span>] <span style="color:#a6e22e">It</span> <span style="color:#a6e22e">seems</span> <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">isn</span><span style="color:#e6db74">&#39;t running or healthy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubelet-check] The HTTP call equal to &#39;</span><span style="color:#a6e22e">curl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">sSL</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//localhost:10248/healthz&#39; failed with error: Get &#34;http://localhost:10248/healthz&#34;: dial tcp [::1]:10248: connect: connection refused.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[<span style="color:#a6e22e">kubelet</span><span style="color:#f92672">-</span><span style="color:#a6e22e">check</span>] <span style="color:#a6e22e">It</span> <span style="color:#a6e22e">seems</span> <span style="color:#a6e22e">like</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">kubelet</span> <span style="color:#a6e22e">isn</span><span style="color:#e6db74">&#39;t running or healthy.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubelet-check] The HTTP call equal to &#39;</span><span style="color:#a6e22e">curl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">sSL</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//localhost:10248/healthz&#39; failed with error: Get &#34;http://localhost:10248/healthz&#34;: dial tcp [::1]:10248: connect: connection refused.
</span></span></span></code></pre></div>
<p>查看官网介绍为 docker 和 kubelet 服务中的 cgroup 驱动不一致，有两种方法
方式一：驱动向 docker 看齐
方式二：驱动为向 kubelet 看齐
如果docker 不方便重启则统一向 kubelet看齐，并重启对应的服务即可
解决方式
docker 配置文件
这里采取的是方式二，docker 默认驱动为 cgroupfs ,只需要添加</p>
<p>&ldquo;exec-opts&rdquo;: [
&ldquo;native.cgroupdriver=systemd&rdquo;
],
修改后配置文件</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">controlplane</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">cat</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">docker</span><span style="color:#f92672">/</span><span style="color:#a6e22e">daemon</span>.<span style="color:#a6e22e">json</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span>
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bip&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;172.12.0.1/24&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;http://docker-registry-mirror.kodekloud.com&#34;</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>重启docker</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">systemctl</span> <span style="color:#a6e22e">restart</span> <span style="color:#a6e22e">docker</span></span></span></code></pre></div>
<p>kublete 配置文件
grep 截取一下,可以看得出来kubelet默认 cgoup 驱动为systemd</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">controlplane</span><span style="color:#f92672">:~</span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">cat</span> <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#960050;background-color:#1e0010">/lib/kubelet/config.yaml |grep group</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cgroupDriver</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">systemd</span></span></span></code></pre></div>
<p>修改后重置并重新初始化可正常初始化</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">reset</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">init</span></span></span></code></pre></div>
<p>成功后提示</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">Your</span> <span style="color:#a6e22e">Kubernetes</span> <span style="color:#a6e22e">control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plane</span> <span style="color:#a6e22e">has</span> <span style="color:#a6e22e">initialized</span> <span style="color:#a6e22e">successfully</span><span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">To</span> <span style="color:#a6e22e">start</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">your</span> <span style="color:#a6e22e">cluster</span>, <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">need</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">regular</span> <span style="color:#a6e22e">user</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">cp</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubernetes</span><span style="color:#f92672">/</span><span style="color:#a6e22e">admin</span>.<span style="color:#a6e22e">conf</span> <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">chown</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">id</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">u</span>)<span style="color:#f92672">:</span><span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">id</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">g</span>) <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Alternatively</span>, <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">root</span> <span style="color:#a6e22e">user</span>, <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">export</span> <span style="color:#a6e22e">KUBECONFIG</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/admin.conf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">You</span> <span style="color:#a6e22e">should</span> <span style="color:#a6e22e">now</span> <span style="color:#a6e22e">deploy</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">network</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">cluster</span>.
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Run</span> <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">one</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">options</span> <span style="color:#a6e22e">listed</span> <span style="color:#a6e22e">at</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Then</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">join</span> <span style="color:#a6e22e">any</span> <span style="color:#a6e22e">number</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">worker</span> <span style="color:#a6e22e">nodes</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">running</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">following</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">each</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">root</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">join</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6443</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">token</span> <span style="color:#a6e22e">pedwrg</span>.<span style="color:#a6e22e">x3ocfkg6ui1t5yht</span> <span style="color:#f92672">\</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">--</span><span style="color:#a6e22e">discovery</span><span style="color:#f92672">-</span><span style="color:#a6e22e">token</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ca</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cert</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hash</span> <span style="color:#a6e22e">sha256</span><span style="color:#f92672">:</span><span style="color:#a6e22e">a696588d58710779c758a0cdc4f0da3154af5d62f9b54420b5bb78d63f11e7a2</span> 
</span></span></code></pre></div>
<p>注意最后一段的kubeadm join是worker节点加入使用的，注意保存,如果忘记了可通过以下命令打印：</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">token</span> <span style="color:#a6e22e">create</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">print</span><span style="color:#f92672">-</span><span style="color:#a6e22e">join</span><span style="color:#f92672">-</span><span style="color:#a6e22e">command</span></span></span></code></pre></div>
<p>普通用户安装需要执行如下脚本：</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">p</span> <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">cp</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubernetes</span><span style="color:#f92672">/</span><span style="color:#a6e22e">admin</span>.<span style="color:#a6e22e">conf</span> <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">chown</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">id</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">u</span>)<span style="color:#f92672">:</span><span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">id</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">g</span>) <span style="color:#a6e22e">$HOME</span><span style="color:#f92672">/</span>.<span style="color:#a6e22e">kube</span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span></span></span></code></pre></div>
<p>root用户直接运行</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#66d9ef">export</span> <span style="color:#a6e22e">KUBECONFIG</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/admin.conf</span></span></span></code></pre></div>
<p>此时查看所有二进制安装的进程</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# ps -ef | grep kube</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">7691</span>  <span style="color:#ae81ff">7622</span>  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03</span> <span style="color:#a6e22e">etcd</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">advertise</span><span style="color:#f92672">-</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#a6e22e">urls</span><span style="color:#f92672">=</span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//10.10.0.115:2379 --cert-file=/etc/kubernetes/pki/etcd/server.crt --client-cert-auth=true --data-dir=/var/lib/etcd --initial-advertise-peer-urls=https://10.10.0.115:2380 --initial-cluster=liaok8s=https://10.10.0.115:2380 --key-file=/etc/kubernetes/pki/etcd/server.key --listen-client-urls=https://127.0.0.1:2379,https://10.10.0.115:2379 --listen-metrics-urls=http://127.0.0.1:2381 --listen-peer-urls=https://10.10.0.115:2380 --name=liaok8s --peer-cert-file=/etc/kubernetes/pki/etcd/peer.crt --peer-client-cert-auth=true --peer-key-file=/etc/kubernetes/pki/etcd/peer.key --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt --snapshot-count=10000 --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">7736</span>  <span style="color:#ae81ff">7648</span>  <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">apiserver</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">advertise</span><span style="color:#f92672">-</span><span style="color:#a6e22e">address</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">privileged</span><span style="color:#f92672">=</span><span style="color:#66d9ef">true</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">authorization</span><span style="color:#f92672">-</span><span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Node</span>,<span style="color:#a6e22e">RBAC</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">client</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ca</span><span style="color:#f92672">-</span><span style="color:#a6e22e">file</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/pki/ca.crt --enable-admission-plugins=NodeRestriction --enable-bootstrap-token-auth=true --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key --etcd-servers=https://127.0.0.1:2379 --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key --requestheader-allowed-names=front-proxy-client --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6443 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/etc/kubernetes/pki/sa.pub --service-account-signing-key-file=/etc/kubernetes/pki/sa.key --service-cluster-ip-range=10.96.0.0/12 --tls-cert-file=/etc/kubernetes/pki/apiserver.crt --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">7744</span>  <span style="color:#ae81ff">7661</span>  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">authentication</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kubeconfig</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/controller-manager.conf --authorization-kubeconfig=/etc/kubernetes/controller-manager.conf --bind-address=127.0.0.1 --client-ca-file=/etc/kubernetes/pki/ca.crt --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt --cluster-signing-key-file=/etc/kubernetes/pki/ca.key --controllers=*,bootstrapsigner,tokencleaner --kubeconfig=/etc/kubernetes/controller-manager.conf --leader-elect=true --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --root-ca-file=/etc/kubernetes/pki/ca.crt --service-account-private-key-file=/etc/kubernetes/pki/sa.key --use-service-account-credentials=true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">7752</span>  <span style="color:#ae81ff">7695</span>  <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">01</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheduler</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">authentication</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kubeconfig</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/scheduler.conf --authorization-kubeconfig=/etc/kubernetes/scheduler.conf --bind-address=127.0.0.1 --kubeconfig=/etc/kubernetes/scheduler.conf --leader-elect=true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">7965</span>     <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">03</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubelet</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">bootstrap</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kubeconfig</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">8294</span>  <span style="color:#ae81ff">8274</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">config</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/var/lib/kube-proxy/config.conf --hostname-override=liaok8s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>      <span style="color:#ae81ff">9929</span>  <span style="color:#ae81ff">1346</span>  <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">33</span> <span style="color:#a6e22e">pts</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span> <span style="color:#a6e22e">grep</span> <span style="color:#a6e22e">kube</span></span></span></code></pre></div>
<p>查看系统pod</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# kubectl get pods --namespace kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>                              <span style="color:#a6e22e">READY</span>   <span style="color:#a6e22e">STATUS</span>              <span style="color:#a6e22e">RESTARTS</span>   <span style="color:#a6e22e">AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">f9l5d</span>           <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">ContainerCreating</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m18s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gtbp6</span>           <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">ContainerCreating</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m18s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">etcd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                      <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>             <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m23s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">apiserver</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>            <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>             <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m25s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>             <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m23s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#a6e22e">phdl</span>                  <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>             <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m18s</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheduler</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>            <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>             <span style="color:#ae81ff">4</span>          <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m22s</span></span></span></code></pre></div>
<p>发现dns关于网络的服务都是0个实例
同时检查node节点（目前就一个master节点，版本1.12.3）</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# kubectl get node</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>      <span style="color:#a6e22e">STATUS</span>   <span style="color:#a6e22e">ROLES</span>                  <span style="color:#a6e22e">AGE</span>    <span style="color:#a6e22e">VERSION</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">liaok8s</span>   <span style="color:#a6e22e">Ready</span>    <span style="color:#a6e22e">control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">plane</span>,<span style="color:#a6e22e">master</span>   <span style="color:#ae81ff">4</span><span style="color:#a6e22e">m9s</span>   <span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">23.3</span></span></span></code></pre></div>
<p>查看版本</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# kubectl version --short=true</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Client</span> <span style="color:#a6e22e">Version</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">23.3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Server</span> <span style="color:#a6e22e">Version</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">23.3</span></span></span></code></pre></div>
<p>上面安装成功后如果通过查询kube-system下Pod的运行情况，会发现和网络相关的Pod都处于Pending的状态，这是因为缺少相关的网络插件。</p>
<h3 id="安装网络">安装网络</h3>
<p>上面安装成功后如果通过查询kube-system下Pod的运行情况，会放下和网络相关的Pod都处于Pending的状态，这是因为缺少相关的网络插件，而网络插件有很多个（以下任选一个），可以选择自己需要的。
比较流行的几个为：</p>
<ul>
<li>flannel</li>
<li>weave</li>
<li>calico
这里以calico为例
Calico是一个纯三层的协议，为OpenStack虚机和Docker容器提供多主机间通信。Calico不使用重叠网络比如flannel和libnetwork重叠网络驱动，
它是一个纯三层的方法，使用虚拟路由代替虚拟交换，每一台虚拟路由通过BGP协议传播可达信息（路由）到剩余数据中心。<a href="https://blog.csdn.net/ccy19910925/article/details/82423452" rel="external" target="_blank">calico原理参考</a>
不要直接使用下面方式下载安装，因为node间通信，默认会选择第一个物理网卡的ip，会导致选错ip，无法通信</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//docs.projectcalico.org/manifests/calico.yaml
</span></span></span></code></pre></div>
<p>应该首先下载calico.yaml
wget <a href="https://docs.projectcalico.org/manifests/calico.yaml" rel="external" target="_blank">https://docs.projectcalico.org/manifests/calico.yaml</a>
修改yaml文件容器名称为：calico-node，搜索大概这个内容</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>      <span style="color:#a6e22e">containers</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">image</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">docker</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">calico</span><span style="color:#f92672">/</span><span style="color:#a6e22e">node</span><span style="color:#f92672">:</span><span style="color:#a6e22e">v3</span>.<span style="color:#ae81ff">22.0</span></span></span></code></pre></div>
<p>新增一个变量 env部分</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>            <span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IP_AUTODETECTION_METHOD</span>
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;interface=ens.*&#34;</span></span></span></code></pre></div>
<p>意思是找物理主机的ip是使用ens开头的网卡，具体的本地物理网卡名称可以通过 ip addr查看</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">calico</span>.<span style="color:#a6e22e">yaml</span></span></span></code></pre></div>
<p>检测pod是否安装成功</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# kubectl get pods --namespace kube-system -o wide</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>                                       <span style="color:#a6e22e">READY</span>   <span style="color:#a6e22e">STATUS</span>    <span style="color:#a6e22e">RESTARTS</span>   <span style="color:#a6e22e">AGE</span>    <span style="color:#a6e22e">IP</span>                <span style="color:#a6e22e">NODE</span>      <span style="color:#a6e22e">NOMINATED</span> <span style="color:#a6e22e">NODE</span>   <span style="color:#a6e22e">READINESS</span> <span style="color:#a6e22e">GATES</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controllers</span><span style="color:#f92672">-</span><span style="color:#ae81ff">566</span><span style="color:#a6e22e">dc76669</span><span style="color:#f92672">-</span><span style="color:#a6e22e">dwlrk</span>   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">4</span><span style="color:#a6e22e">m4s</span>   <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">134.129</span>   <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gtpcw</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">4</span><span style="color:#a6e22e">m4s</span>   <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">f9l5d</span>                    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">172.16</span>.<span style="color:#ae81ff">134.131</span>    <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gtbp6</span>                    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">172.16</span>.<span style="color:#ae81ff">134.129</span>    <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">etcd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                               <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">apiserver</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>            <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">2</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#a6e22e">phdl</span>                           <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheduler</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">4</span>          <span style="color:#ae81ff">64</span><span style="color:#a6e22e">m</span>    <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>       <span style="color:#a6e22e">liaok8s</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span></span></span></code></pre></div>
<p>如果安装失败很有可能是之前安装reset过没有清除完，清除后重装</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#a6e22e">删除安装插件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">calico</span>.<span style="color:#a6e22e">yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#a6e22e">检查所有节点上的网络</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">看看是否存在Tunl0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">若存在Tunl0</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#a6e22e">将其删除</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">modprobe</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">r</span> <span style="color:#a6e22e">ipip</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#a6e22e">移除与Calico网络插件有关的网络配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ls</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cni</span><span style="color:#f92672">/</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">d</span><span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rm</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">rf</span> <span style="color:#a6e22e">calico相关文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rm</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">rf</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cni</span><span style="color:#f92672">/</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">d</span><span style="color:#f92672">/*</span><span style="color:#a6e22e">calico</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">删除所有calico的pod</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#e6db74">`kubectl get pods --namespace kube-system`</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">echo</span> <span style="color:#a6e22e">$i</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">grep</span> <span style="color:#a6e22e">calico</span>;<span style="color:#a6e22e">then</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">echo</span> <span style="color:#a6e22e">$i</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;system(&#34;kubectl delete --force pod &#34;$1&#34; --namespace kube-system&#34;)&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">done</span>;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#a6e22e">重新安装</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">calico</span>.<span style="color:#a6e22e">yaml</span></span></span></code></pre></div>
<h2 id="worker节点">worker节点</h2>
<p>同主节点kubelet和docker的驱动类型必须一致
修改/etc/docker/daemon.json 重启docker</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span> <span style="color:#e6db74">&#34;exec-opts&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span>
</span></span><span style="display:flex;"><span>  ],</span></span></code></pre></div>
<p>注意worker节点也要获取这些镜像，虽然只有部分使用，比如pause，否则kubelet会出现拉取错误
之前是没有在worker节点拉取镜像，在主节点查看calico网络的event日志</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pods</span> <span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ncwdc</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Events</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Type</span>     <span style="color:#a6e22e">Reason</span>                    <span style="color:#a6e22e">Age</span>                   <span style="color:#a6e22e">From</span>               <span style="color:#a6e22e">Message</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">----</span>     <span style="color:#f92672">------</span>                    <span style="color:#f92672">----</span>                  <span style="color:#f92672">----</span>               <span style="color:#f92672">-------</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Normal</span>   <span style="color:#a6e22e">Scheduled</span>                 <span style="color:#ae81ff">15</span><span style="color:#a6e22e">m</span>                   <span style="color:#66d9ef">default</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheduler</span>  <span style="color:#a6e22e">Successfully</span> <span style="color:#a6e22e">assigned</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span><span style="color:#f92672">/</span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ncwdc</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">pve</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tmpl</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodContainer</span>  <span style="color:#ae81ff">15</span><span style="color:#a6e22e">m</span>                   <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">unable</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">ensure</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">container</span> <span style="color:#a6e22e">exists</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">container</span> <span style="color:#66d9ef">for</span> [<span style="color:#a6e22e">kubepods</span> <span style="color:#a6e22e">burstable</span> <span style="color:#a6e22e">podb1e24b58</span><span style="color:#f92672">-</span><span style="color:#a6e22e">fe92</span><span style="color:#f92672">-</span><span style="color:#ae81ff">42</span><span style="color:#a6e22e">d6</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8857</span><span style="color:#f92672">-</span><span style="color:#ae81ff">61</span><span style="color:#a6e22e">d4d36638a2</span>] <span style="color:#f92672">:</span> <span style="color:#a6e22e">mkdir</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">sys</span><span style="color:#f92672">/</span><span style="color:#a6e22e">fs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">cgroup</span><span style="color:#f92672">/</span><span style="color:#a6e22e">devices</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubepods</span>.<span style="color:#a6e22e">slice</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubepods</span><span style="color:#f92672">-</span><span style="color:#a6e22e">burstable</span>.<span style="color:#a6e22e">slice</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubepods</span><span style="color:#f92672">-</span><span style="color:#a6e22e">burstable</span><span style="color:#f92672">-</span><span style="color:#a6e22e">podb1e24b58_fe92_42d6_8857_61d4d36638a2</span>.<span style="color:#a6e22e">slice</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">no</span> <span style="color:#a6e22e">such</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">or</span> <span style="color:#a6e22e">directory</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodSandBox</span>    <span style="color:#ae81ff">15</span><span style="color:#a6e22e">m</span>                   <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Unknown</span> <span style="color:#a6e22e">desc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">pulling</span> <span style="color:#a6e22e">image</span> <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.6&#34;</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#e6db74">&#34;https://k8s.gcr.io/v2/&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">net</span><span style="color:#f92672">/</span><span style="color:#a6e22e">http</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">request</span> <span style="color:#a6e22e">canceled</span> <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">waiting</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">connection</span> (<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Timeout</span> <span style="color:#a6e22e">exceeded</span> <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">awaiting</span> <span style="color:#a6e22e">headers</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodSandBox</span>    <span style="color:#ae81ff">14</span><span style="color:#a6e22e">m</span>                   <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Unknown</span> <span style="color:#a6e22e">desc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">pulling</span> <span style="color:#a6e22e">image</span> <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.6&#34;</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#e6db74">&#34;https://k8s.gcr.io/v2/&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dial</span> <span style="color:#a6e22e">tcp</span> <span style="color:#ae81ff">74.125</span>.<span style="color:#ae81ff">204.82</span><span style="color:#f92672">:</span><span style="color:#ae81ff">443</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">/</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">timeout</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodSandBox</span>    <span style="color:#ae81ff">10</span><span style="color:#a6e22e">m</span>                   <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Unknown</span> <span style="color:#a6e22e">desc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">pulling</span> <span style="color:#a6e22e">image</span> <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.6&#34;</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#e6db74">&#34;https://k8s.gcr.io/v2/&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dial</span> <span style="color:#a6e22e">tcp</span> <span style="color:#ae81ff">142.251</span>.<span style="color:#ae81ff">8.82</span><span style="color:#f92672">:</span><span style="color:#ae81ff">443</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">/</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">timeout</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodSandBox</span>    <span style="color:#ae81ff">8</span><span style="color:#a6e22e">m35s</span> (<span style="color:#a6e22e">x13</span> <span style="color:#a6e22e">over</span> <span style="color:#ae81ff">15</span><span style="color:#a6e22e">m</span>)  <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Unknown</span> <span style="color:#a6e22e">desc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">pulling</span> <span style="color:#a6e22e">image</span> <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.6&#34;</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#e6db74">&#34;https://k8s.gcr.io/v2/&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">net</span><span style="color:#f92672">/</span><span style="color:#a6e22e">http</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">request</span> <span style="color:#a6e22e">canceled</span> <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">waiting</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">connection</span> (<span style="color:#a6e22e">Client</span>.<span style="color:#a6e22e">Timeout</span> <span style="color:#a6e22e">exceeded</span> <span style="color:#66d9ef">while</span> <span style="color:#a6e22e">awaiting</span> <span style="color:#a6e22e">headers</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">FailedCreatePodSandBox</span>    <span style="color:#ae81ff">8</span><span style="color:#a6e22e">m6s</span>                  <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Failed</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">create</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rpc</span> <span style="color:#a6e22e">error</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Unknown</span> <span style="color:#a6e22e">desc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">pulling</span> <span style="color:#a6e22e">image</span> <span style="color:#e6db74">&#34;k8s.gcr.io/pause:3.6&#34;</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">daemon</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#e6db74">&#34;https://k8s.gcr.io/v2/&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dial</span> <span style="color:#a6e22e">tcp</span> <span style="color:#ae81ff">108.177</span>.<span style="color:#ae81ff">125.82</span><span style="color:#f92672">:</span><span style="color:#ae81ff">443</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">/</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">timeout</span></span></span></code></pre></div>
<p>使用之前的kubeadm join命令加入，如果忘记了可以在主节点获取</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">token</span> <span style="color:#a6e22e">create</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">print</span><span style="color:#f92672">-</span><span style="color:#a6e22e">join</span><span style="color:#f92672">-</span><span style="color:#a6e22e">command</span></span></span></code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubeadm</span> <span style="color:#a6e22e">join</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span><span style="color:#f92672">:</span><span style="color:#ae81ff">6443</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">token</span> <span style="color:#a6e22e">dprbpd</span>.<span style="color:#a6e22e">gdjxay6moqf10d05</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">discovery</span><span style="color:#f92672">-</span><span style="color:#a6e22e">token</span><span style="color:#f92672">-</span><span style="color:#a6e22e">ca</span><span style="color:#f92672">-</span><span style="color:#a6e22e">cert</span><span style="color:#f92672">-</span><span style="color:#a6e22e">hash</span> <span style="color:#a6e22e">sha256</span><span style="color:#f92672">:</span><span style="color:#a6e22e">a696588d58710779c758a0cdc4f0da3154af5d62f9b54420b5bb78d63f11e7a2</span> 
</span></span></code></pre></div>
<p>加入成功后，可通过docker ps 查看</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pve</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tmpl</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# docker ps</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CONTAINER</span> <span style="color:#a6e22e">ID</span>   <span style="color:#a6e22e">IMAGE</span>                  <span style="color:#a6e22e">COMMAND</span>                  <span style="color:#a6e22e">CREATED</span>        <span style="color:#a6e22e">STATUS</span>        <span style="color:#a6e22e">PORTS</span>     <span style="color:#a6e22e">NAMES</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">96170</span><span style="color:#a6e22e">aa46f83</span>   <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pause</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3.6</span>   <span style="color:#e6db74">&#34;/pause&#34;</span>                 <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span> <span style="color:#a6e22e">ago</span>   <span style="color:#a6e22e">Up</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span>             <span style="color:#a6e22e">k8s_POD_nginx_default_7c3d47ef</span><span style="color:#f92672">-</span><span style="color:#a6e22e">f478</span><span style="color:#f92672">-</span><span style="color:#ae81ff">40</span><span style="color:#a6e22e">b4</span><span style="color:#f92672">-</span><span style="color:#a6e22e">b154</span><span style="color:#f92672">-</span><span style="color:#a6e22e">e9334cff14e3_1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span><span style="color:#a6e22e">c627df7a7ca</span>   <span style="color:#a6e22e">f109b1742d34</span>           <span style="color:#e6db74">&#34;start_runit&#34;</span>            <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span> <span style="color:#a6e22e">ago</span>   <span style="color:#a6e22e">Up</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span>             <span style="color:#a6e22e">k8s_calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node_calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">j8x2d_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system_3875d252</span><span style="color:#f92672">-</span><span style="color:#ae81ff">86</span><span style="color:#a6e22e">cf</span><span style="color:#f92672">-</span><span style="color:#ae81ff">47e4</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">c86</span><span style="color:#f92672">-</span><span style="color:#a6e22e">e74f32356d51_1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">c30f1e963eae</span>   <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pause</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3.6</span>   <span style="color:#e6db74">&#34;/pause&#34;</span>                 <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span> <span style="color:#a6e22e">ago</span>   <span style="color:#a6e22e">Up</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span>             <span style="color:#a6e22e">k8s_POD_calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">j8x2d_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system_3875d252</span><span style="color:#f92672">-</span><span style="color:#ae81ff">86</span><span style="color:#a6e22e">cf</span><span style="color:#f92672">-</span><span style="color:#ae81ff">47e4</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">c86</span><span style="color:#f92672">-</span><span style="color:#a6e22e">e74f32356d51_1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0426</span><span style="color:#a6e22e">d0f18715</span>   <span style="color:#ae81ff">9</span><span style="color:#a6e22e">b7cc9982109</span>           <span style="color:#e6db74">&#34;/usr/local/bin/kube…&#34;</span>   <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span> <span style="color:#a6e22e">ago</span>   <span style="color:#a6e22e">Up</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span>             <span style="color:#a6e22e">k8s_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kql69_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system_838b79c1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span><span style="color:#a6e22e">c1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">46e1</span><span style="color:#f92672">-</span><span style="color:#a6e22e">a806</span><span style="color:#f92672">-</span><span style="color:#ae81ff">868</span><span style="color:#a6e22e">ca3fa87d3_2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">773974</span><span style="color:#a6e22e">f94bba</span>   <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">gcr</span>.<span style="color:#a6e22e">io</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pause</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3.6</span>   <span style="color:#e6db74">&#34;/pause&#34;</span>                 <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span> <span style="color:#a6e22e">ago</span>   <span style="color:#a6e22e">Up</span> <span style="color:#ae81ff">13</span> <span style="color:#a6e22e">hours</span>             <span style="color:#a6e22e">k8s_POD_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kql69_kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system_838b79c1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span><span style="color:#a6e22e">c1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">46e1</span><span style="color:#f92672">-</span><span style="color:#a6e22e">a806</span><span style="color:#f92672">-</span><span style="color:#ae81ff">868</span><span style="color:#a6e22e">ca3fa87d3_1</span></span></span></code></pre></div>
<p>从节点回安装pause，calico，kubeproxy等组件，二进制组件</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pve</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tmpl</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# ps -ef | grep kube</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>       <span style="color:#ae81ff">392</span>     <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1</span> <span style="color:#a6e22e">Feb10</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">13</span><span style="color:#f92672">:</span><span style="color:#ae81ff">19</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kubelet</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">bootstrap</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kubeconfig</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">root</span>       <span style="color:#ae81ff">967</span>   <span style="color:#ae81ff">947</span>  <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">Feb10</span> <span style="color:#f92672">?</span>        <span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">08</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">config</span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">/var/lib/kube-proxy/config.conf --hostname-override=pve-tmpl</span></span></span></code></pre></div>
<h2 id="异常问题">异常问题</h2>
<h3 id="calico容器异常">calico容器异常</h3>
<p>如果calico安装出现问题，一般都会导致kube-system下的calico相关的容器无法正常运行</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# kubectl get pods --namespace kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>                                       <span style="color:#a6e22e">READY</span>   <span style="color:#a6e22e">STATUS</span>    <span style="color:#a6e22e">RESTARTS</span>      <span style="color:#a6e22e">AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controllers</span><span style="color:#f92672">-</span><span style="color:#ae81ff">566</span><span style="color:#a6e22e">dc76669</span><span style="color:#f92672">-</span><span style="color:#a6e22e">dllq7</span>   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>             <span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">j2ffk</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>             <span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">j8x2d</span>                          <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">f9l5d</span>                    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">coredns</span><span style="color:#f92672">-</span><span style="color:#ae81ff">64897985</span><span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gtbp6</span>                    <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">etcd</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                               <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">3</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">apiserver</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">4</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">controller</span><span style="color:#f92672">-</span><span style="color:#a6e22e">manager</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>            <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">3</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#a6e22e">phdl</span>                           <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">proxy</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kql69</span>                           <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">2</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">15</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheduler</span><span style="color:#f92672">-</span><span style="color:#a6e22e">liaok8s</span>                     <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">5</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">17</span><span style="color:#a6e22e">h</span></span></span></code></pre></div>
<p>如果任意一个容器出现异常可以通过查看event发现问题</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">calico</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">j2ffk</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span></span></span></code></pre></div>
<p>我这里之前没有修改calico.yaml直接apply导致出现了一个问题</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">Unhealthy</span>  <span style="color:#ae81ff">23</span><span style="color:#a6e22e">s</span> (<span style="color:#a6e22e">x3</span> <span style="color:#a6e22e">over</span> <span style="color:#ae81ff">25</span><span style="color:#a6e22e">s</span>)  <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Readiness</span> <span style="color:#a6e22e">probe</span> <span style="color:#a6e22e">failed</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">calico</span><span style="color:#f92672">/</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">ready</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">BIRD</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">ready</span><span style="color:#f92672">:</span> Error <span style="color:#a6e22e">querying</span> <span style="color:#a6e22e">BIRD</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">unable</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">BIRDv4</span> <span style="color:#a6e22e">socket</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dial</span> <span style="color:#a6e22e">unix</span> <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#960050;background-color:#1e0010">/run/calico/bird.ctl: connect: connection refused</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Warning</span>  <span style="color:#a6e22e">Unhealthy</span>  <span style="color:#ae81ff">20</span><span style="color:#a6e22e">s</span>                <span style="color:#a6e22e">kubelet</span>            <span style="color:#a6e22e">Readiness</span> <span style="color:#a6e22e">probe</span> <span style="color:#a6e22e">failed</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2022</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15</span><span style="color:#f92672">:</span><span style="color:#ae81ff">15.807</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">250</span>] <span style="color:#a6e22e">confd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">health</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">180</span><span style="color:#f92672">:</span> Number <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">node</span>(<span style="color:#a6e22e">s</span>) <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">BGP</span> <span style="color:#a6e22e">peering</span> <span style="color:#a6e22e">established</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span></span></span></code></pre></div>
<p>这个问题就是calico通信无法识别主机间真实的物理ip引起的，可通过安装calicoctl诊断
安装请参考官网：https://projectcalico.docs.tigera.io/maintenance/clis/calicoctl/install
正确的结果为
在master节点，peer_address为多个从节点的ip，一个从节点一个，INFO为Established</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# calicoctl node status</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Calico</span> <span style="color:#a6e22e">process</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">running</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">IPv4</span> <span style="color:#a6e22e">BGP</span> <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">PEER</span> <span style="color:#a6e22e">ADDRESS</span> <span style="color:#f92672">|</span>     <span style="color:#a6e22e">PEER</span> <span style="color:#a6e22e">TYPE</span>     <span style="color:#f92672">|</span> <span style="color:#a6e22e">STATE</span> <span style="color:#f92672">|</span>  <span style="color:#a6e22e">SINCE</span>   <span style="color:#f92672">|</span>    <span style="color:#a6e22e">INFO</span>     <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.116</span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">to</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">mesh</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">up</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29</span><span style="color:#f92672">:</span><span style="color:#ae81ff">59</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Established</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">IPv6</span> <span style="color:#a6e22e">BGP</span> <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">No</span> <span style="color:#a6e22e">IPv6</span> <span style="color:#a6e22e">peers</span> <span style="color:#a6e22e">found</span>.</span></span></code></pre></div>
<p>在worker节点,peer_address为多个从节点的ip和主节点的ip，一个从节点一个，INFO为Established</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pve</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tmpl</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/home/mainte# calicoctl node status</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Calico</span> <span style="color:#a6e22e">process</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">running</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">IPv4</span> <span style="color:#a6e22e">BGP</span> <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#a6e22e">PEER</span> <span style="color:#a6e22e">ADDRESS</span> <span style="color:#f92672">|</span>     <span style="color:#a6e22e">PEER</span> <span style="color:#a6e22e">TYPE</span>     <span style="color:#f92672">|</span> <span style="color:#a6e22e">STATE</span> <span style="color:#f92672">|</span>  <span style="color:#a6e22e">SINCE</span>   <span style="color:#f92672">|</span>    <span style="color:#a6e22e">INFO</span>     <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#ae81ff">10.10</span>.<span style="color:#ae81ff">0.115</span>  <span style="color:#f92672">|</span> <span style="color:#a6e22e">node</span><span style="color:#f92672">-</span><span style="color:#a6e22e">to</span><span style="color:#f92672">-</span><span style="color:#a6e22e">node</span> <span style="color:#a6e22e">mesh</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">up</span>    <span style="color:#f92672">|</span> <span style="color:#ae81ff">12</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29</span><span style="color:#f92672">:</span><span style="color:#ae81ff">59</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">Established</span> <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+--------------+-------------------+-------+----------+-------------+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">IPv6</span> <span style="color:#a6e22e">BGP</span> <span style="color:#a6e22e">status</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">No</span> <span style="color:#a6e22e">IPv6</span> <span style="color:#a6e22e">peers</span> <span style="color:#a6e22e">found</span>.</span></span></code></pre></div>
<p>注意这些ip如果不是物理主机的ip， 变成了某个网卡的内部地址就会出现通信问题。</p>
<blockquote>
<p>在主和工作节点上都会有个tunl0的网卡，工作节点的tunl0的ip地址就是pod的节点ip段</p></blockquote>
<h3 id="无法ping通clusterip和服务名">无法ping通clusterip和服务名</h3>
<p>因为我之前重置过多次集群，没有指定固定的pod ip段，导致master和worker节点tunl0的ip不在同一个网段，导致无法正常通讯。
<a href="#R-image-5975e1696fcf98f3b61aae7b83dfe13d" class="lightbox-link"><img alt="在这里插入图片描述" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/ea50b5931d1bc9996d7485dcb5b62604.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-5975e1696fcf98f3b61aae7b83dfe13d"><img alt="在这里插入图片描述" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/ea50b5931d1bc9996d7485dcb5b62604.png"></a>
此时我们可以创建一个dnsutils镜像在kube-system下用来诊断网络</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">apiVersion</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dnsutils</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spec</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">containers</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">-</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">dnsutils</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">image</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">mydlqclub</span><span style="color:#f92672">/</span><span style="color:#a6e22e">dnsutils</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1.3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">imagePullPolicy</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">IfNotPresent</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">command</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;sleep&#34;</span>,<span style="color:#e6db74">&#34;3600&#34;</span>]</span></span></code></pre></div>
<p>通过 Kubectl 工具部署 NDS 工具镜像
通过 Kubectl 工具，将对上面 DNS 工具镜像部署到 Kubernetes 中：</p>
<p>-n：指定应用部署的 Namespace 空间。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">$</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">create</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">ndsutils</span>.<span style="color:#a6e22e">yaml</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span></span></span></code></pre></div>
<p>进入 DNS 工具 Pod 的命令行
上面 DNS 工具已经部署完成，我们可也通过 Kubectl 工具进入 Pod 命令行，然后，使用里面的一些工具进行问题分析，命令如下：
exec：让指定 Pod 容器执行某些命令。
-i：将控制台内容传入到容器。
-t：进入容器的 tty 使用 bash 命令行。
-n：指定上面部署 DNS Pod 所在的 Namespace。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">$</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">exec</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">it</span> <span style="color:#a6e22e">dnsutils</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sh</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span></span></span></code></pre></div>
<p>通过 Ping 和 Nsloopup 命令测试
进入容器 sh 命令行界面后，先使用 ping 命令来分别探测观察是否能够 ping 通集群内部和集群外部的地址
首先确认下ndsutils的ip地址：192.168.57.136和第一个coredns相同。
进入容器后 :</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping 192.168.57.136   coredns1能ping通，在同一个worker节点</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PING</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.136</span> (<span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.136</span>)<span style="color:#f92672">:</span> <span style="color:#ae81ff">56</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.136</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0.058</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.136</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0.045</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.136</span> <span style="color:#a6e22e">ping</span> <span style="color:#a6e22e">statistics</span> <span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">transmitted</span>, <span style="color:#ae81ff">2</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">received</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">%</span> <span style="color:#a6e22e">packet</span> <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">round</span><span style="color:#f92672">-</span><span style="color:#a6e22e">trip</span> <span style="color:#a6e22e">min</span><span style="color:#f92672">/</span><span style="color:#a6e22e">avg</span><span style="color:#f92672">/</span><span style="color:#a6e22e">max</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.045</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0.051</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0.058</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping 192.168.134.132 master对应的coredns无法ping通</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PING</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">134.132</span> (<span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">134.132</span>)<span style="color:#f92672">:</span> <span style="color:#ae81ff">56</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">134.132</span> <span style="color:#a6e22e">ping</span> <span style="color:#a6e22e">statistics</span> <span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">transmitted</span>, <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">received</span>, <span style="color:#ae81ff">100</span><span style="color:#f92672">%</span> <span style="color:#a6e22e">packet</span> <span style="color:#a6e22e">loss</span></span></span></code></pre></div>
<p>查看容器的/etc/resolv.conf文件</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # more /etc/resolv.conf </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nameserver</span> <span style="color:#ae81ff">10.96</span>.<span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span> <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">options</span> <span style="color:#a6e22e">ndots</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span></span></span></code></pre></div>
<p>发现nameserver指向的是service=kube-dns的集群ip
<a href="#R-image-2dec1aff9f0063c630a1811ae612f250" class="lightbox-link"><img alt="在这里插入图片描述" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/4ebbedc30185c322871f9e63eaf6db9b.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-2dec1aff9f0063c630a1811ae612f250"><img alt="在这里插入图片描述" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/4ebbedc30185c322871f9e63eaf6db9b.png"></a>
注意clusterip是不能ping的 可以通过ip:端口组合来访问。
此时ping下外网，不通的</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping www.baidu.com</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span></span></span></code></pre></div>
<p>kube-dns的service实际是负载均衡到两个coredns上，其中一个是通的我们设置dns服务是这个通的试试</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">nameserver</span> <span style="color:#ae81ff">10.96</span>.<span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nameserver</span> <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.138</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">search</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span>.<span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span> <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span> <span style="color:#a6e22e">cluster</span>.<span style="color:#a6e22e">local</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">options</span> <span style="color:#a6e22e">ndots</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span></span></span></code></pre></div>
<p>再次测试发现正常</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping www.baidu.com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PING</span> <span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">baidu</span>.<span style="color:#a6e22e">com</span> (<span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span>)<span style="color:#f92672">:</span> <span style="color:#ae81ff">56</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.204</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.330</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">43.863</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.107</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.148</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.329</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.210</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">7</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.204</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.113</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> <span style="color:#a6e22e">bytes</span> <span style="color:#a6e22e">from</span> <span style="color:#ae81ff">110.242</span>.<span style="color:#ae81ff">68.4</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">9</span> <span style="color:#a6e22e">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52</span> <span style="color:#a6e22e">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">44.161</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">baidu</span>.<span style="color:#a6e22e">com</span> <span style="color:#a6e22e">ping</span> <span style="color:#a6e22e">statistics</span> <span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">transmitted</span>, <span style="color:#ae81ff">10</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">received</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">%</span> <span style="color:#a6e22e">packet</span> <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">round</span><span style="color:#f92672">-</span><span style="color:#a6e22e">trip</span> <span style="color:#a6e22e">min</span><span style="color:#f92672">/</span><span style="color:#a6e22e">avg</span><span style="color:#f92672">/</span><span style="color:#a6e22e">max</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">43.863</span><span style="color:#f92672">/</span><span style="color:#ae81ff">44.166</span><span style="color:#f92672">/</span><span style="color:#ae81ff">44.330</span> <span style="color:#a6e22e">ms</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping nginx.default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PING</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#66d9ef">default</span> (<span style="color:#ae81ff">10.99</span>.<span style="color:#ae81ff">35.228</span>)<span style="color:#f92672">:</span> <span style="color:#ae81ff">56</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#66d9ef">default</span> <span style="color:#a6e22e">ping</span> <span style="color:#a6e22e">statistics</span> <span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">transmitted</span>, <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">packets</span> <span style="color:#a6e22e">received</span>, <span style="color:#ae81ff">100</span><span style="color:#f92672">%</span> <span style="color:#a6e22e">packet</span> <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # ping httpd.default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PING</span> <span style="color:#a6e22e">httpd</span>.<span style="color:#66d9ef">default</span> (<span style="color:#ae81ff">10.98</span>.<span style="color:#ae81ff">37.38</span>)<span style="color:#f92672">:</span> <span style="color:#ae81ff">56</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">^</span><span style="color:#a6e22e">C</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # wget nginx.default   注意属于两个不同的namespace所以需要在服务名称后加上.namesapce:端口访问，ip是不能直接ping通的 但是可以获取到dns的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Connecting</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#66d9ef">default</span> (<span style="color:#ae81ff">10.99</span>.<span style="color:#ae81ff">35.228</span><span style="color:#f92672">:</span><span style="color:#ae81ff">80</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">index</span>.<span style="color:#a6e22e">html</span>           <span style="color:#ae81ff">100</span><span style="color:#f92672">%</span> <span style="color:#f92672">|**********************************************************************************************************************************************************************************************|</span>   <span style="color:#ae81ff">615</span>   <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span><span style="color:#f92672">:</span><span style="color:#ae81ff">00</span> <span style="color:#a6e22e">ETA</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # more index.html</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">head</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">title</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/title&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">style</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">html</span> { <span style="color:#a6e22e">color</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheme</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">light</span> <span style="color:#a6e22e">dark</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">body</span> { <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">35</span><span style="color:#a6e22e">em</span>; <span style="color:#a6e22e">margin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">auto</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">font</span><span style="color:#f92672">-</span><span style="color:#a6e22e">family</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Tahoma</span>, <span style="color:#a6e22e">Verdana</span>, <span style="color:#a6e22e">Arial</span>, <span style="color:#a6e22e">sans</span><span style="color:#f92672">-</span><span style="color:#a6e22e">serif</span>; }
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/style&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/head&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">body</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/h1&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">If</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">see</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">web</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">successfully</span> <span style="color:#a6e22e">installed</span> <span style="color:#a6e22e">and</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">working</span>. <span style="color:#a6e22e">Further</span> <span style="color:#a6e22e">configuration</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">required</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">For</span> <span style="color:#a6e22e">online</span> <span style="color:#a6e22e">documentation</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">please</span> <span style="color:#a6e22e">refer</span> <span style="color:#a6e22e">to</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">org</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">/a&gt;.&lt;br/</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Commercial</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">available</span> <span style="color:#a6e22e">at</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/a&gt;.&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">em</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Thank</span> <span style="color:#a6e22e">you</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/em&gt;&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/body&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/html&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">/ # </span></span></span></code></pre></div>
<p>这里可以想到 ,想着是否我们需要将pod的ip全部都设置为相同的段能访问是否就可行了，重置k8s,init
带上&ndash;pod-network-cidr=10.244.0.0/16  发现依然不行，会不是是coredns不应该在master节点上有个pod的了。
重新按照coredns，参考： <a href="https://github.com/coredns/deployment/tree/master/kubernetes" rel="external" target="_blank">https://github.com/coredns/deployment/tree/master/kubernetes</a>
下载这两个文件</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">wget</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">wget</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//raw.githubusercontent.com/coredns/deployment/master/kubernetes/deploy.sh
</span></span></span></code></pre></div>
<p>执行命令(-i指定的参数是kube-dns clusterid的地址，默认是10.96.0.10)，</p>
<blockquote>
<p>注意先提前删除kube-system下的deploy=coredns,service=kube-dns</p></blockquote>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">deploy</span> <span style="color:#a6e22e">coredns</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">svc</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">dns</span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chmod</span> <span style="color:#f92672">+</span><span style="color:#a6e22e">x</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">sh</span> <span style="color:#f92672">&amp;&amp;</span> .<span style="color:#f92672">/</span><span style="color:#a6e22e">deploy</span>.<span style="color:#a6e22e">sh</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">i</span> <span style="color:#ae81ff">10.96</span>.<span style="color:#ae81ff">0.10</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#f92672">-</span></span></span></code></pre></div>
<p>如果命令执行缺少jq，提前用yum或者apt-get或者apk安装，重新安装完成，在测试一切正常了，但是这个命令安装只是产生了一个coredns的pod，依然有点不知所以然虽然正常运行，后续在新增一个worker节点在测试下他的service分发的逻辑。</p>
<h2 id="发布测试">发布测试</h2>
<p>主节点运行</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">nginx</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span><span style="color:#f92672">=</span><span style="color:#a6e22e">nginx</span></span></span></code></pre></div>
<p>查看nginx状态</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# kubectl get pods -o wide                     </span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>    <span style="color:#a6e22e">READY</span>   <span style="color:#a6e22e">STATUS</span>    <span style="color:#a6e22e">RESTARTS</span>      <span style="color:#a6e22e">AGE</span>   <span style="color:#a6e22e">IP</span>               <span style="color:#a6e22e">NODE</span>       <span style="color:#a6e22e">NOMINATED</span> <span style="color:#a6e22e">NODE</span>   <span style="color:#a6e22e">READINESS</span> <span style="color:#a6e22e">GATES</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nginx</span>   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">13</span><span style="color:#a6e22e">h</span> <span style="color:#a6e22e">ago</span>)   <span style="color:#ae81ff">14</span><span style="color:#a6e22e">h</span>   <span style="color:#ae81ff">192.168</span>.<span style="color:#ae81ff">57.130</span>   <span style="color:#a6e22e">pve</span><span style="color:#f92672">-</span><span style="color:#a6e22e">tmpl</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>           <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span></span></span></code></pre></div>
<p>查看执行过程（如果ready状态一直是0）</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">describe</span> <span style="color:#a6e22e">pod</span> <span style="color:#a6e22e">nginx</span></span></span></code></pre></div>
<p>通过pod ip访问http地址</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# curl 192.168.57.130</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">head</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">title</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/title&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">style</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">html</span> { <span style="color:#a6e22e">color</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheme</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">light</span> <span style="color:#a6e22e">dark</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">body</span> { <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">35</span><span style="color:#a6e22e">em</span>; <span style="color:#a6e22e">margin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">auto</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">font</span><span style="color:#f92672">-</span><span style="color:#a6e22e">family</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Tahoma</span>, <span style="color:#a6e22e">Verdana</span>, <span style="color:#a6e22e">Arial</span>, <span style="color:#a6e22e">sans</span><span style="color:#f92672">-</span><span style="color:#a6e22e">serif</span>; }
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/style&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/head&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">body</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/h1&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">If</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">see</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">web</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">successfully</span> <span style="color:#a6e22e">installed</span> <span style="color:#a6e22e">and</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">working</span>. <span style="color:#a6e22e">Further</span> <span style="color:#a6e22e">configuration</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">required</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">For</span> <span style="color:#a6e22e">online</span> <span style="color:#a6e22e">documentation</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">please</span> <span style="color:#a6e22e">refer</span> <span style="color:#a6e22e">to</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">org</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">/a&gt;.&lt;br/</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Commercial</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">available</span> <span style="color:#a6e22e">at</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/a&gt;.&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">em</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Thank</span> <span style="color:#a6e22e">you</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/em&gt;&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/body&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/html&gt;</span></span></span></code></pre></div>
<p>创建service</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# kubectl expose pod nginx --port=80</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">service</span><span style="color:#f92672">/</span><span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">exposed</span></span></span></code></pre></div>
<p>查看service</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# kubectl get service nginx -o wide</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>    <span style="color:#a6e22e">TYPE</span>        <span style="color:#a6e22e">CLUSTER</span><span style="color:#f92672">-</span><span style="color:#a6e22e">IP</span>     <span style="color:#a6e22e">EXTERNAL</span><span style="color:#f92672">-</span><span style="color:#a6e22e">IP</span>   <span style="color:#a6e22e">PORT</span>(<span style="color:#a6e22e">S</span>)   <span style="color:#a6e22e">AGE</span>   <span style="color:#a6e22e">SELECTOR</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">nginx</span>   <span style="color:#a6e22e">ClusterIP</span>   <span style="color:#ae81ff">10.99</span>.<span style="color:#ae81ff">35.228</span>   <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">none</span><span style="color:#f92672">&gt;</span>        <span style="color:#ae81ff">80</span><span style="color:#f92672">/</span><span style="color:#a6e22e">TCP</span>    <span style="color:#ae81ff">46</span><span style="color:#a6e22e">s</span>   <span style="color:#a6e22e">run</span><span style="color:#f92672">=</span><span style="color:#a6e22e">nginx</span></span></span></code></pre></div>
<p>通过集群ip负载访问容器</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">root</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">liaok8s</span><span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">/usr/local/bin# curl 10.99.35.228</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;!</span><span style="color:#a6e22e">DOCTYPE</span> <span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">head</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">title</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/title&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">style</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">html</span> { <span style="color:#a6e22e">color</span><span style="color:#f92672">-</span><span style="color:#a6e22e">scheme</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">light</span> <span style="color:#a6e22e">dark</span>; }
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">body</span> { <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">35</span><span style="color:#a6e22e">em</span>; <span style="color:#a6e22e">margin</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> <span style="color:#a6e22e">auto</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">font</span><span style="color:#f92672">-</span><span style="color:#a6e22e">family</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Tahoma</span>, <span style="color:#a6e22e">Verdana</span>, <span style="color:#a6e22e">Arial</span>, <span style="color:#a6e22e">sans</span><span style="color:#f92672">-</span><span style="color:#a6e22e">serif</span>; }
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/style&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/head&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">body</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">h1</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Welcome</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">nginx</span><span style="color:#f92672">!&lt;</span><span style="color:#960050;background-color:#1e0010">/h1&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">If</span> <span style="color:#a6e22e">you</span> <span style="color:#a6e22e">see</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">nginx</span> <span style="color:#a6e22e">web</span> <span style="color:#a6e22e">server</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">successfully</span> <span style="color:#a6e22e">installed</span> <span style="color:#a6e22e">and</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">working</span>. <span style="color:#a6e22e">Further</span> <span style="color:#a6e22e">configuration</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">required</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">For</span> <span style="color:#a6e22e">online</span> <span style="color:#a6e22e">documentation</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">please</span> <span style="color:#a6e22e">refer</span> <span style="color:#a6e22e">to</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">org</span><span style="color:#f92672">&lt;</span><span style="color:#e6db74">/a&gt;.&lt;br/</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Commercial</span> <span style="color:#a6e22e">support</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">available</span> <span style="color:#a6e22e">at</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">nginx</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/a&gt;.&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">p</span><span style="color:#f92672">&gt;&lt;</span><span style="color:#a6e22e">em</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Thank</span> <span style="color:#a6e22e">you</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">nginx</span>.<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/em&gt;&lt;/p&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/body&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/html&gt;</span></span></span></code></pre></div>
<p>验证dns正确性
安装一个apahce httpd服务</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">run</span> <span style="color:#a6e22e">httpd</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">image</span> <span style="color:#a6e22e">httpd</span></span></span></code></pre></div>
<p>安装成功后进入worker节点宿主机，进入nginx容器</p>
<h2 id="重新启动">重新启动</h2>
<p>如果因为异常断电，导致k8s停止，可设置集群自动启动
配置环境变量</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#centos下
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>echo <span style="color:#e6db74">&#34;export KUBECONFIG=/etc/kubernetes/admin.conf&#34;</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">~/</span>.bash_profile <span style="color:#f92672">&amp;&amp;</span> source <span style="color:#f92672">~/</span>.bash_profile
</span></span><span style="display:flex;"><span><span style="color:#75715e">#debian下
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>echo <span style="color:#e6db74">&#34;export KUBECONFIG=/etc/kubernetes/admin.conf&#34;</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">~/</span>.bashrc <span style="color:#f92672">&amp;&amp;</span> source <span style="color:#f92672">~/</span>.bashrc 
</span></span></code></pre></div>
<p>在主工作节点设置服务自启</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl restart kubelet</span></span></code></pre></div>
<blockquote>
<p>如果kubelet无法启动，很大可能是swap未正常关闭 ，sudo swapoff -a 再试试</p></blockquote>
<h2 id="图形管理工具">图形管理工具</h2>
<p>Kubernetes 容器编排已越来越被大家关注，然而使用 Kubernetes 的门槛却依然很高，主要体现在这几个方面：</p>
<ul>
<li>集群的安装复杂，出错概率大</li>
<li>Kubernetes相较于容器化，引入了许多新的概念，学习难度高</li>
<li>需要手工编写 YAML 文件，难以在多环境下管理</li>
<li>缺少好的实战案例可以参考</li>
</ul>
<p>Kuboard，是一款免费的 Kubernetes 图形化管理工具，Kuboard 力图帮助用户快速在 Kubernetes 上落地微服务。</p>
<h3 id="安装">安装</h3>
<p>如果您参考 <a href="https://kuboard.cn" rel="external" target="_blank">https://kuboard.cn</a> 网站上提供的 Kubernetes 安装文档，可在 master 节点上执行以下命令。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//kuboard.cn/install-script/kuboard.yaml
</span></span></span></code></pre></div>
<p>查看 Kuboard 运行状态：</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">pods</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">eip</span>.<span style="color:#a6e22e">work</span><span style="color:#f92672">/</span><span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#a6e22e">kuboard</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NAME</span>                       <span style="color:#a6e22e">READY</span>   <span style="color:#a6e22e">STATUS</span>    <span style="color:#a6e22e">RESTARTS</span>   <span style="color:#a6e22e">AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kuboard</span><span style="color:#f92672">-</span><span style="color:#ae81ff">756</span><span style="color:#a6e22e">d46c4d4</span><span style="color:#f92672">-</span><span style="color:#a6e22e">qh6cm</span>   <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>     <span style="color:#a6e22e">Running</span>   <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">101</span><span style="color:#a6e22e">m</span></span></span></code></pre></div>
<p>确保kuboard 处于 Running 状态</p>
<h3 id="获取token">获取Token</h3>
<p>您可以获得管理员用户、只读用户的Token。
Kuboard 有计划开发权限设置的功能，在这之前，如果您需要更细粒度的权限控制，请参考 <a href="https://www.kuboard.cn/learning/k8s-advanced/sec/rbac/example.html" rel="external" target="_blank">RBAC Example</a>
此Token拥有 ClusterAdmin 的权限，可以执行所有操作</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">kubectl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">secret</span> <span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">kubectl</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">n</span> <span style="color:#a6e22e">kube</span><span style="color:#f92672">-</span><span style="color:#a6e22e">system</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">secret</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">grep</span> <span style="color:#a6e22e">kuboard</span><span style="color:#f92672">-</span><span style="color:#a6e22e">user</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">awk</span> <span style="color:#e6db74">&#39;{print $1}&#39;</span>) <span style="color:#f92672">-</span><span style="color:#a6e22e">o</span> <span style="color:#a6e22e">go</span><span style="color:#f92672">-</span><span style="color:#a6e22e">template</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{{.data.token}}&#39;</span> <span style="color:#f92672">|</span> <span style="color:#a6e22e">base64</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">d</span></span></span></code></pre></div>
<p>Kuboard Service 使用了 NodePort 的方式暴露服务，NodePort 为 32567；您可以按如下方式访问 Kuboard。</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//任意一个Worker节点的IP地址:32567/
</span></span></span></code></pre></div>
<p>输入前一步骤中获得的 token，可进入 Kuboard 集群概览页
<a href="#R-image-1884b8754721806c9a7ea6fc9cc00384" class="lightbox-link"><img alt="在这里插入图片描述" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/8723bcdb310516438947fcbbd1b88149.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-1884b8754721806c9a7ea6fc9cc00384"><img alt="在这里插入图片描述" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/8723bcdb310516438947fcbbd1b88149.png"></a></p>
<h3 id="kuboard-v3x">Kuboard v3.x</h3>
<p>Kuboard v3.x 支持 Kubernetes 多集群管理。如果您从 Kuboard v1.0.x 或者 Kuboard v2.0.x 升级到 Kuboard，请注意：</p>
<ul>
<li>您可以同时使用 Kuboard v3.x 和 Kuboard v2.0.x；</li>
<li>Kuboard v3.x 支持 amd64 (x86) 架构和 arm68 (armv8) 架构的 CPU；
可参考kuboard官网：https://kuboard.cn/install/v3/install-in-k8s.html
在线安装：</li>
</ul>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">kubectl</span> <span style="color:#a6e22e">apply</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">f</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//addons.kuboard.cn/kuboard/kuboard-v3.yaml
</span></span></span></code></pre></div>
<p><a href="#R-image-a02ab83fd77d9b1e34f7243665de2526" class="lightbox-link"><img alt="在这里插入图片描述" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/3b29a3bd36e39927fdb7dcc2688efd36.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-a02ab83fd77d9b1e34f7243665de2526"><img alt="在这里插入图片描述" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_02.md.images/3b29a3bd36e39927fdb7dcc2688efd36.png"></a>
访问 Kuboard
在浏览器中打开链接 http://your-node-ip-address:30080</p>
<p>输入初始用户名和密码，并登录</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">用户名</span><span style="color:#960050;background-color:#1e0010">：</span> <span style="color:#a6e22e">admin</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">密码</span><span style="color:#960050;background-color:#1e0010">：</span> <span style="color:#a6e22e">Kuboard123</span></span></span></code></pre></div>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Sep 18, 2025
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/docs/index.html">
            <div class="logo-title">liaomin416100569博客</div>
          </a>
        </div>
        <search><form action="/docs/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/docs/index.html"><a class="padding" href="/docs/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/docs/programming/index.html"><a class="padding" href="/docs/programming/index.html">编程开发</a><ul id="R-subsections-e3fc01b477dbaf64a8f5013a3dab5c5b" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-id="/docs/devops/index.html"><a class="padding" href="/docs/devops/index.html">运维一体化</a><ul id="R-subsections-389d4feb4920b919bcbc0b1e9947dace" class="collapsible-menu">
            <li class="parent alwaysopen " data-nav-id="/docs/devops/kubernetes/index.html"><a class="padding" href="/docs/devops/kubernetes/index.html">kubernetes</a><ul id="R-subsections-a6d9d4850f81ae033d42cdaa03dad084" class="collapsible-menu">
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_01/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_01/index.html">K8S二次开发01-各种资源对象的理解和定义</a></li>
            <li class="active " data-nav-id="/docs/devops/kubernetes/k8s_dev_02/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_02/index.html">K8S二次开发02-kubeadm安装k8s集群</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_03/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_03/index.html">K8S二次开发03-CRD资源详解</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_04/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_04/index.html">K8S二次开发04-自定义operator（operator-sdk调试）</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_05/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_05/index.html">K8S二次开发05-使用clientgo自定义ingresscontroller</a></li></ul></li>
            <li class="alwaysopen " data-nav-id="/docs/devops/networking/index.html"><a class="padding" href="/docs/devops/networking/index.html">网络技术</a><ul id="R-subsections-bd6b3f75e8269a91d29691b78d3bac17" class="collapsible-menu"></ul></li></ul></li>
            <li class="" data-nav-id="/docs/security/index.html"><a class="padding" href="/docs/security/index.html">安全攻防</a><ul id="R-subsections-66815ecaaecfc1c209e5637d03b258b2" class="collapsible-menu"></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/docs/js/clipboard/clipboard.min.js?1758355652" defer></script>
    <script src="/docs/js/perfect-scrollbar/perfect-scrollbar.min.js?1758355652" defer></script>
    <script src="/docs/js/theme.min.js?1758355652" defer></script>
  </body>
</html>
