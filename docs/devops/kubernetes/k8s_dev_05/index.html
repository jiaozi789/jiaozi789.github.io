<!DOCTYPE html>
<html lang="zh" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.150.0">
    <meta name="generator" content="Relearn 8.0.1+b23cf6629eada0c2802f34ae4012e04343497862">
    <meta name="description" content="clientgoç®€ä»‹ client-go ä½œä¸ºå®˜æ–¹ç»´æŠ¤çš„ go è¯­è¨€å®ç°çš„ client åº“ï¼Œæä¾›äº†å¤§é‡çš„é«˜è´¨é‡ä»£ç å¸®åŠ©å¼€å‘è€…ç¼–å†™è‡ªå·±çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¥è®¿é—®ã€æ“ä½œ Kubernetes é›†ç¾¤
infomerç®€ä»‹ cient-go æ˜¯ä» k8s ä»£ç ä¸­æŠ½å‡ºæ¥çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼ŒInformer æ˜¯ client-go ä¸­çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œå·²ç»è¢« kubernetes ä¸­ä¼—å¤šç»„ä»¶æ‰€ä½¿ç”¨ã€‚æ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientï¼Œæœ¬åœ°ç¼“å­˜è¢«ç§°ä¸º Storeï¼Œç´¢å¼•è¢«ç§°ä¸º Indexã€‚ä½¿ç”¨ informer çš„ç›®çš„æ˜¯ä¸ºäº†å‡è½» apiserver æ•°æ®äº¤äº’çš„å‹åŠ›è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª cache å±‚, å®¢æˆ·ç«¯å¯¹ apiserver æ•°æ®çš„ â€œè¯»å–â€ å’Œ â€œç›‘å¬â€ æ“ä½œéƒ½é€šè¿‡æœ¬åœ° informer è¿›è¡Œã€‚Informer å®ä¾‹çš„Lister()æ–¹æ³•å¯ä»¥ç›´æ¥æŸ¥æ‰¾ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ã€‚
Informer çš„ä¸»è¦åŠŸèƒ½ï¼š
åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ æ ¹æ®å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandler infomeräº§ç”ŸèƒŒæ™¯ éšç€Controllerè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœControllerç›´æ¥è®¿é—®k8s-apiserverï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´å…¶å‹åŠ›è¿‡å¤§ï¼Œäºæ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å°±æœ‰äº†Informerçš„æ¦‚å¿µã€‚å…¶å‘å±•åˆ°ä»Šå¤©è¿™ä¸ªæ¶æ„ï¼Œå¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹è¿­ä»£æ€è·¯ï¼š ç¬¬ä¸€é˜¶æ®µï¼ŒControllerç›´æ¥è®¿é—®k8s-api-serverã€‚å­˜åœ¨çš„é—®é¢˜ï¼šå¤šä¸ªæ§åˆ¶å™¨å¤§é‡è®¿é—®k8s-apiserveræ—¶ä¼šå¯¹å…¶é€ æˆå·¨å¤§çš„å‹åŠ›ã€‚
ç¬¬äºŒé˜¶æ®µï¼ŒInformerä»£æ›¿Controllerå»è®¿é—®k8s-apiserverã€‚è€ŒControllerçš„æ‰€æœ‰æ“ä½œæ“ä½œ(å¦‚ï¼šæŸ¥çŠ¶æ€ã€å¯¹èµ„æºè¿›è¡Œä¼¸ç¼©ç­‰ï¼‰éƒ½å’ŒInformerè¿›è¡Œäº¤äº’ã€‚ä½†Informeræ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½å»è®¿é—®k8s-apiserverï¼Œå®ƒåªè¦åœ¨éœ€è¦çš„æ—¶å€™é€šè¿‡ListAndWatch(å³é€šè¿‡k8s List APIè·å–æ‰€æœ‰èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼›é€šè¿‡Wath APIå»ç›‘å¬è¿™äº›èµ„æºçŠ¶æ€çš„å˜åŒ–)ä¸k8s-apiserveräº¤äº’å³å¯ã€‚
ListAndWatchçš„ä»£ç ä½ç½®: client-go/tools/cache/reflector.go
func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error{ â€¦ } ç¬¬ä¸‰é˜¶æ®µï¼Œ Informerå¹¶æ²¡æœ‰ç›´æ¥è®¿é—®k8s-api-serverï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«Reflectorçš„å¯¹è±¡è¿›è¡Œapi-serverçš„è®¿é—®ã€‚ä¸Šé¢æ‰€è¯´çš„ ListAndWatch äº‹å®ä¸Šæ˜¯ç”±Reflector`å®ç°çš„ã€‚">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller :: liaomin416100569åšå®¢">
    <meta name="twitter:description" content="clientgoç®€ä»‹ client-go ä½œä¸ºå®˜æ–¹ç»´æŠ¤çš„ go è¯­è¨€å®ç°çš„ client åº“ï¼Œæä¾›äº†å¤§é‡çš„é«˜è´¨é‡ä»£ç å¸®åŠ©å¼€å‘è€…ç¼–å†™è‡ªå·±çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¥è®¿é—®ã€æ“ä½œ Kubernetes é›†ç¾¤
infomerç®€ä»‹ cient-go æ˜¯ä» k8s ä»£ç ä¸­æŠ½å‡ºæ¥çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼ŒInformer æ˜¯ client-go ä¸­çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œå·²ç»è¢« kubernetes ä¸­ä¼—å¤šç»„ä»¶æ‰€ä½¿ç”¨ã€‚æ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientï¼Œæœ¬åœ°ç¼“å­˜è¢«ç§°ä¸º Storeï¼Œç´¢å¼•è¢«ç§°ä¸º Indexã€‚ä½¿ç”¨ informer çš„ç›®çš„æ˜¯ä¸ºäº†å‡è½» apiserver æ•°æ®äº¤äº’çš„å‹åŠ›è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª cache å±‚, å®¢æˆ·ç«¯å¯¹ apiserver æ•°æ®çš„ â€œè¯»å–â€ å’Œ â€œç›‘å¬â€ æ“ä½œéƒ½é€šè¿‡æœ¬åœ° informer è¿›è¡Œã€‚Informer å®ä¾‹çš„Lister()æ–¹æ³•å¯ä»¥ç›´æ¥æŸ¥æ‰¾ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ã€‚
Informer çš„ä¸»è¦åŠŸèƒ½ï¼š
åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ æ ¹æ®å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandler infomeräº§ç”ŸèƒŒæ™¯ éšç€Controllerè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœControllerç›´æ¥è®¿é—®k8s-apiserverï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´å…¶å‹åŠ›è¿‡å¤§ï¼Œäºæ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å°±æœ‰äº†Informerçš„æ¦‚å¿µã€‚å…¶å‘å±•åˆ°ä»Šå¤©è¿™ä¸ªæ¶æ„ï¼Œå¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹è¿­ä»£æ€è·¯ï¼š ç¬¬ä¸€é˜¶æ®µï¼ŒControllerç›´æ¥è®¿é—®k8s-api-serverã€‚å­˜åœ¨çš„é—®é¢˜ï¼šå¤šä¸ªæ§åˆ¶å™¨å¤§é‡è®¿é—®k8s-apiserveræ—¶ä¼šå¯¹å…¶é€ æˆå·¨å¤§çš„å‹åŠ›ã€‚
ç¬¬äºŒé˜¶æ®µï¼ŒInformerä»£æ›¿Controllerå»è®¿é—®k8s-apiserverã€‚è€ŒControllerçš„æ‰€æœ‰æ“ä½œæ“ä½œ(å¦‚ï¼šæŸ¥çŠ¶æ€ã€å¯¹èµ„æºè¿›è¡Œä¼¸ç¼©ç­‰ï¼‰éƒ½å’ŒInformerè¿›è¡Œäº¤äº’ã€‚ä½†Informeræ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½å»è®¿é—®k8s-apiserverï¼Œå®ƒåªè¦åœ¨éœ€è¦çš„æ—¶å€™é€šè¿‡ListAndWatch(å³é€šè¿‡k8s List APIè·å–æ‰€æœ‰èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼›é€šè¿‡Wath APIå»ç›‘å¬è¿™äº›èµ„æºçŠ¶æ€çš„å˜åŒ–)ä¸k8s-apiserveräº¤äº’å³å¯ã€‚
ListAndWatchçš„ä»£ç ä½ç½®: client-go/tools/cache/reflector.go
func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error{ â€¦ } ç¬¬ä¸‰é˜¶æ®µï¼Œ Informerå¹¶æ²¡æœ‰ç›´æ¥è®¿é—®k8s-api-serverï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«Reflectorçš„å¯¹è±¡è¿›è¡Œapi-serverçš„è®¿é—®ã€‚ä¸Šé¢æ‰€è¯´çš„ ListAndWatch äº‹å®ä¸Šæ˜¯ç”±Reflector`å®ç°çš„ã€‚">
    <meta property="og:url" content="https://jiaozi789.github.io/docs/devops/kubernetes/k8s_dev_05/index.html">
    <meta property="og:site_name" content="liaomin416100569åšå®¢">
    <meta property="og:title" content="K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller :: liaomin416100569åšå®¢">
    <meta property="og:description" content="clientgoç®€ä»‹ client-go ä½œä¸ºå®˜æ–¹ç»´æŠ¤çš„ go è¯­è¨€å®ç°çš„ client åº“ï¼Œæä¾›äº†å¤§é‡çš„é«˜è´¨é‡ä»£ç å¸®åŠ©å¼€å‘è€…ç¼–å†™è‡ªå·±çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¥è®¿é—®ã€æ“ä½œ Kubernetes é›†ç¾¤
infomerç®€ä»‹ cient-go æ˜¯ä» k8s ä»£ç ä¸­æŠ½å‡ºæ¥çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼ŒInformer æ˜¯ client-go ä¸­çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œå·²ç»è¢« kubernetes ä¸­ä¼—å¤šç»„ä»¶æ‰€ä½¿ç”¨ã€‚æ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientï¼Œæœ¬åœ°ç¼“å­˜è¢«ç§°ä¸º Storeï¼Œç´¢å¼•è¢«ç§°ä¸º Indexã€‚ä½¿ç”¨ informer çš„ç›®çš„æ˜¯ä¸ºäº†å‡è½» apiserver æ•°æ®äº¤äº’çš„å‹åŠ›è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª cache å±‚, å®¢æˆ·ç«¯å¯¹ apiserver æ•°æ®çš„ â€œè¯»å–â€ å’Œ â€œç›‘å¬â€ æ“ä½œéƒ½é€šè¿‡æœ¬åœ° informer è¿›è¡Œã€‚Informer å®ä¾‹çš„Lister()æ–¹æ³•å¯ä»¥ç›´æ¥æŸ¥æ‰¾ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ã€‚
Informer çš„ä¸»è¦åŠŸèƒ½ï¼š
åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ æ ¹æ®å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandler infomeräº§ç”ŸèƒŒæ™¯ éšç€Controllerè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœControllerç›´æ¥è®¿é—®k8s-apiserverï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´å…¶å‹åŠ›è¿‡å¤§ï¼Œäºæ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å°±æœ‰äº†Informerçš„æ¦‚å¿µã€‚å…¶å‘å±•åˆ°ä»Šå¤©è¿™ä¸ªæ¶æ„ï¼Œå¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹è¿­ä»£æ€è·¯ï¼š ç¬¬ä¸€é˜¶æ®µï¼ŒControllerç›´æ¥è®¿é—®k8s-api-serverã€‚å­˜åœ¨çš„é—®é¢˜ï¼šå¤šä¸ªæ§åˆ¶å™¨å¤§é‡è®¿é—®k8s-apiserveræ—¶ä¼šå¯¹å…¶é€ æˆå·¨å¤§çš„å‹åŠ›ã€‚
ç¬¬äºŒé˜¶æ®µï¼ŒInformerä»£æ›¿Controllerå»è®¿é—®k8s-apiserverã€‚è€ŒControllerçš„æ‰€æœ‰æ“ä½œæ“ä½œ(å¦‚ï¼šæŸ¥çŠ¶æ€ã€å¯¹èµ„æºè¿›è¡Œä¼¸ç¼©ç­‰ï¼‰éƒ½å’ŒInformerè¿›è¡Œäº¤äº’ã€‚ä½†Informeræ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½å»è®¿é—®k8s-apiserverï¼Œå®ƒåªè¦åœ¨éœ€è¦çš„æ—¶å€™é€šè¿‡ListAndWatch(å³é€šè¿‡k8s List APIè·å–æ‰€æœ‰èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼›é€šè¿‡Wath APIå»ç›‘å¬è¿™äº›èµ„æºçŠ¶æ€çš„å˜åŒ–)ä¸k8s-apiserveräº¤äº’å³å¯ã€‚
ListAndWatchçš„ä»£ç ä½ç½®: client-go/tools/cache/reflector.go
func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error{ â€¦ } ç¬¬ä¸‰é˜¶æ®µï¼Œ Informerå¹¶æ²¡æœ‰ç›´æ¥è®¿é—®k8s-api-serverï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«Reflectorçš„å¯¹è±¡è¿›è¡Œapi-serverçš„è®¿é—®ã€‚ä¸Šé¢æ‰€è¯´çš„ ListAndWatch äº‹å®ä¸Šæ˜¯ç”±Reflector`å®ç°çš„ã€‚">
    <meta property="og:locale" content="zh">
    <meta property="og:type" content="article">
    <meta property="article:section" content="è¿ç»´ä¸€ä½“åŒ–">
    <meta property="article:published_time" content="2025-09-18T16:55:17+08:00">
    <meta property="article:modified_time" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="name" content="K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller :: liaomin416100569åšå®¢">
    <meta itemprop="description" content="clientgoç®€ä»‹ client-go ä½œä¸ºå®˜æ–¹ç»´æŠ¤çš„ go è¯­è¨€å®ç°çš„ client åº“ï¼Œæä¾›äº†å¤§é‡çš„é«˜è´¨é‡ä»£ç å¸®åŠ©å¼€å‘è€…ç¼–å†™è‡ªå·±çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¥è®¿é—®ã€æ“ä½œ Kubernetes é›†ç¾¤
infomerç®€ä»‹ cient-go æ˜¯ä» k8s ä»£ç ä¸­æŠ½å‡ºæ¥çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼ŒInformer æ˜¯ client-go ä¸­çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œå·²ç»è¢« kubernetes ä¸­ä¼—å¤šç»„ä»¶æ‰€ä½¿ç”¨ã€‚æ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientï¼Œæœ¬åœ°ç¼“å­˜è¢«ç§°ä¸º Storeï¼Œç´¢å¼•è¢«ç§°ä¸º Indexã€‚ä½¿ç”¨ informer çš„ç›®çš„æ˜¯ä¸ºäº†å‡è½» apiserver æ•°æ®äº¤äº’çš„å‹åŠ›è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª cache å±‚, å®¢æˆ·ç«¯å¯¹ apiserver æ•°æ®çš„ â€œè¯»å–â€ å’Œ â€œç›‘å¬â€ æ“ä½œéƒ½é€šè¿‡æœ¬åœ° informer è¿›è¡Œã€‚Informer å®ä¾‹çš„Lister()æ–¹æ³•å¯ä»¥ç›´æ¥æŸ¥æ‰¾ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ã€‚
Informer çš„ä¸»è¦åŠŸèƒ½ï¼š
åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ æ ¹æ®å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandler infomeräº§ç”ŸèƒŒæ™¯ éšç€Controllerè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœControllerç›´æ¥è®¿é—®k8s-apiserverï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´å…¶å‹åŠ›è¿‡å¤§ï¼Œäºæ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å°±æœ‰äº†Informerçš„æ¦‚å¿µã€‚å…¶å‘å±•åˆ°ä»Šå¤©è¿™ä¸ªæ¶æ„ï¼Œå¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹è¿­ä»£æ€è·¯ï¼š ç¬¬ä¸€é˜¶æ®µï¼ŒControllerç›´æ¥è®¿é—®k8s-api-serverã€‚å­˜åœ¨çš„é—®é¢˜ï¼šå¤šä¸ªæ§åˆ¶å™¨å¤§é‡è®¿é—®k8s-apiserveræ—¶ä¼šå¯¹å…¶é€ æˆå·¨å¤§çš„å‹åŠ›ã€‚
ç¬¬äºŒé˜¶æ®µï¼ŒInformerä»£æ›¿Controllerå»è®¿é—®k8s-apiserverã€‚è€ŒControllerçš„æ‰€æœ‰æ“ä½œæ“ä½œ(å¦‚ï¼šæŸ¥çŠ¶æ€ã€å¯¹èµ„æºè¿›è¡Œä¼¸ç¼©ç­‰ï¼‰éƒ½å’ŒInformerè¿›è¡Œäº¤äº’ã€‚ä½†Informeræ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½å»è®¿é—®k8s-apiserverï¼Œå®ƒåªè¦åœ¨éœ€è¦çš„æ—¶å€™é€šè¿‡ListAndWatch(å³é€šè¿‡k8s List APIè·å–æ‰€æœ‰èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼›é€šè¿‡Wath APIå»ç›‘å¬è¿™äº›èµ„æºçŠ¶æ€çš„å˜åŒ–)ä¸k8s-apiserveräº¤äº’å³å¯ã€‚
ListAndWatchçš„ä»£ç ä½ç½®: client-go/tools/cache/reflector.go
func (r *Reflector) ListAndWatch(stopCh &lt;-chan struct{}) error{ â€¦ } ç¬¬ä¸‰é˜¶æ®µï¼Œ Informerå¹¶æ²¡æœ‰ç›´æ¥è®¿é—®k8s-api-serverï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«Reflectorçš„å¯¹è±¡è¿›è¡Œapi-serverçš„è®¿é—®ã€‚ä¸Šé¢æ‰€è¯´çš„ ListAndWatch äº‹å®ä¸Šæ˜¯ç”±Reflector`å®ç°çš„ã€‚">
    <meta itemprop="datePublished" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="dateModified" content="2025-09-18T16:55:17+08:00">
    <meta itemprop="wordCount" content="1246">
    <title>K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller :: liaomin416100569åšå®¢</title>
    <link href="/docs/css/auto-complete/auto-complete.min.css?1758355652" rel="stylesheet">
    <script src="/docs/js/auto-complete/auto-complete.min.js?1758355652" defer></script>
    <script src="/docs/js/search-lunr.min.js?1758355652" defer></script>
    <script src="/docs/js/search.min.js?1758355652" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/docs/searchindex.en.js?1758355652";
    </script>
    <script src="/docs/js/lunr/lunr.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.stemmer.support.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.multi.min.js?1758355652" defer></script>
    <script src="/docs/js/lunr/lunr.zh.min.js?1758355652" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['zh'];
    </script>
    <link href="/docs/fonts/fontawesome/css/fontawesome-all.min.css?1758355652" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/docs/fonts/fontawesome/css/fontawesome-all.min.css?1758355652" rel="stylesheet"></noscript>
    <link href="/docs/css/perfect-scrollbar/perfect-scrollbar.min.css?1758355652" rel="stylesheet">
    <link href="/docs/css/theme.min.css?1758355652" rel="stylesheet">
    <link href="/docs/css/format-html.min.css?1758355652" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = `.min`;
      window.relearn.path='\/devops\/kubernetes\/k8s_dev_05\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..\/..';
      window.relearn.absBaseUri='https:\/\/jiaozi789.github.io\/docs';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'auto' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
    <link href="/docs/css/custom.css?1758355652" rel="stylesheet">
  </head>
  <body class="mobile-support html" data-url="/docs/devops/kubernetes/k8s_dev_05/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li><a href="#clientgoç®€ä»‹">clientgoç®€ä»‹</a></li>
    <li><a href="#infomerç®€ä»‹">infomerç®€ä»‹</a>
      <ul>
        <li><a href="#infomeräº§ç”ŸèƒŒæ™¯">infomeräº§ç”ŸèƒŒæ™¯</a></li>
        <li><a href="#infomerç»„ä»¶">infomerç»„ä»¶</a></li>
        <li><a href="#informer-çš„å·¥ä½œæµç¨‹">Informer çš„å·¥ä½œæµç¨‹</a></li>
      </ul>
    </li>
    <li><a href="#è‡ªå®šä¹‰-ingress-controller">è‡ªå®šä¹‰ Ingress Controller</a>
      <ul>
        <li><a href="#ingress-å¯¹è±¡">Ingress å¯¹è±¡</a></li>
        <li><a href="#ingresså®ç°">Ingresså®ç°</a>
          <ul>
            <li><a href="#client-goå®ç°">client-goå®ç°</a></li>
            <li><a href="#åˆ›å»ºé•œåƒ">åˆ›å»ºé•œåƒ</a></li>
            <li><a href="#åˆ›å»ºdaemonset">åˆ›å»ºdaemonset</a></li>
            <li><a href="#åˆ›å»ºingress">åˆ›å»ºingress</a></li>
          </ul>
        </li>
        <li><a href="#æ˜ å°„åŸŸå">æ˜ å°„åŸŸå</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/index.html"><span itemprop="name">liaomin416100569åšå®¢</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/devops/index.html"><span itemprop="name">è¿ç»´ä¸€ä½“åŒ–</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/docs/devops/kubernetes/index.html"><span itemprop="name">kubernetes</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/docs/devops/kubernetes/k8s_dev_04/index.html" title="K8SäºŒæ¬¡å¼€å‘04-è‡ªå®šä¹‰operatorï¼ˆoperator-sdkè°ƒè¯•ï¼‰ (ğŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/docs/devops/networking/index.html" title="ç½‘ç»œæŠ€æœ¯ (ğŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable devops" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="k8säºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller">K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller</h1>

<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']]
  }
};
</script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

<h1 id="clientgoç®€ä»‹">clientgoç®€ä»‹</h1>
<p>client-go ä½œä¸ºå®˜æ–¹ç»´æŠ¤çš„ go è¯­è¨€å®ç°çš„ client åº“ï¼Œæä¾›äº†å¤§é‡çš„é«˜è´¨é‡ä»£ç å¸®åŠ©å¼€å‘è€…ç¼–å†™è‡ªå·±çš„å®¢æˆ·ç«¯ç¨‹åºï¼Œæ¥è®¿é—®ã€æ“ä½œ Kubernetes é›†ç¾¤</p>
<h1 id="infomerç®€ä»‹">infomerç®€ä»‹</h1>
<p>cient-go æ˜¯ä» k8s ä»£ç ä¸­æŠ½å‡ºæ¥çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼ŒInformer æ˜¯ client-go ä¸­çš„æ ¸å¿ƒå·¥å…·åŒ…ï¼Œå·²ç»è¢« kubernetes ä¸­ä¼—å¤šç»„ä»¶æ‰€ä½¿ç”¨ã€‚æ‰€è°“ Informerï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦æœ‰æœ¬åœ°ç¼“å­˜å’Œç´¢å¼•æœºåˆ¶çš„ã€å¯ä»¥æ³¨å†Œ EventHandler çš„ clientï¼Œæœ¬åœ°ç¼“å­˜è¢«ç§°ä¸º Storeï¼Œç´¢å¼•è¢«ç§°ä¸º Indexã€‚ä½¿ç”¨ informer çš„ç›®çš„æ˜¯ä¸ºäº†å‡è½» apiserver æ•°æ®äº¤äº’çš„å‹åŠ›è€ŒæŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ª cache å±‚, å®¢æˆ·ç«¯å¯¹ apiserver æ•°æ®çš„ â€œè¯»å–â€ å’Œ â€œç›‘å¬â€ æ“ä½œéƒ½é€šè¿‡æœ¬åœ° informer è¿›è¡Œã€‚Informer å®ä¾‹çš„Lister()æ–¹æ³•å¯ä»¥ç›´æ¥æŸ¥æ‰¾ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­çš„æ•°æ®ã€‚</p>
<p>Informer çš„ä¸»è¦åŠŸèƒ½ï¼š</p>
<ol>
<li>åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜</li>
<li>æ ¹æ®å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œè§¦å‘äº‹å…ˆæ³¨å†Œå¥½çš„ ResourceEventHandler</li>
</ol>
<h2 id="infomeräº§ç”ŸèƒŒæ™¯">infomeräº§ç”ŸèƒŒæ™¯</h2>
<p>éšç€Controllerè¶Šæ¥è¶Šå¤šï¼Œå¦‚æœControllerç›´æ¥è®¿é—®k8s-apiserverï¼Œé‚£ä¹ˆå°†ä¼šå¯¼è‡´å…¶å‹åŠ›è¿‡å¤§ï¼Œäºæ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹å°±æœ‰äº†Informerçš„æ¦‚å¿µã€‚å…¶å‘å±•åˆ°ä»Šå¤©è¿™ä¸ªæ¶æ„ï¼Œå¤§æ¦‚å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹è¿­ä»£æ€è·¯ï¼š
<a href="#R-image-3600e3ed493eb08202d75bcfeea07840" class="lightbox-link"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/6b5152da370b2af1692642eb872e08cb.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3600e3ed493eb08202d75bcfeea07840"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/6b5152da370b2af1692642eb872e08cb.png"></a>
ç¬¬ä¸€é˜¶æ®µï¼ŒControllerç›´æ¥è®¿é—®k8s-api-serverã€‚å­˜åœ¨çš„é—®é¢˜ï¼šå¤šä¸ªæ§åˆ¶å™¨å¤§é‡è®¿é—®k8s-apiserveræ—¶ä¼šå¯¹å…¶é€ æˆå·¨å¤§çš„å‹åŠ›ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼ŒInformerä»£æ›¿Controllerå»è®¿é—®k8s-apiserverã€‚è€ŒControllerçš„æ‰€æœ‰æ“ä½œæ“ä½œ(å¦‚ï¼šæŸ¥çŠ¶æ€ã€å¯¹èµ„æºè¿›è¡Œä¼¸ç¼©ç­‰ï¼‰éƒ½å’ŒInformerè¿›è¡Œäº¤äº’ã€‚ä½†Informeræ²¡æœ‰å¿…è¦æ¯æ¬¡éƒ½å»è®¿é—®k8s-apiserverï¼Œå®ƒåªè¦åœ¨éœ€è¦çš„æ—¶å€™é€šè¿‡ListAndWatch(å³é€šè¿‡k8s List APIè·å–æ‰€æœ‰èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼›é€šè¿‡Wath APIå»ç›‘å¬è¿™äº›èµ„æºçŠ¶æ€çš„å˜åŒ–)ä¸k8s-apiserveräº¤äº’å³å¯ã€‚</p>
<p>ListAndWatchçš„ä»£ç ä½ç½®: client-go/tools/cache/reflector.go</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>func (r <span style="color:#f92672">*</span>Reflector) ListAndWatch(stopCh <span style="color:#f92672">&lt;-</span>chan <span style="color:#66d9ef">struct</span>{}) error{ <span style="color:#960050;background-color:#1e0010">â€¦</span> }</span></span></code></pre></div>
<p>ç¬¬ä¸‰é˜¶æ®µï¼Œ Informerå¹¶æ²¡æœ‰ç›´æ¥è®¿é—®k8s-api-serverï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«Reflectorçš„å¯¹è±¡è¿›è¡Œapi-serverçš„è®¿é—®ã€‚ä¸Šé¢æ‰€è¯´çš„ ListAndWatch äº‹å®ä¸Šæ˜¯ç”±Reflector`å®ç°çš„ã€‚</p>
<p>ç¬¬å››é˜¶æ®µ, é€šè¿‡æŒ‡å®šèµ„æºç±»å‹æ¥Watchç‰¹å®šèµ„æºã€‚</p>
<p>// ä»£ç ä½ç½®: client-go/tools/cache/listwatch.go</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Watcher is any object that knows how to start a watch on a resource.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>type Watcher interface {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Watch should begin a watch at the specified version.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Watch(options metav1.ListOptions) (watch.Interface, error)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>ç¬¬äº”é˜¶æ®µï¼Œå®šä¹‰SharedInformerã€‚å¦‚æœControllerä¸Informeræ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œé‚£ä¹ˆk8s-api-serverçš„å‹åŠ›ä¹Ÿè¿˜æ˜¯æŒºå¤§çš„ã€‚ä½†æ˜¯ç±»ä¼¼äºPodè¿™æ ·çš„èµ„æºæ¥è¯´ï¼ŒDeploymentå’ŒStatefulSetéƒ½èƒ½å¯¹å®ƒè¿›è¡Œç®¡ç†ï¼Œå½“å¤šä¸ªæ§åˆ¶å™¨åŒæ—¶æƒ³æŸ¥Podçš„çŠ¶æ€æ—¶ï¼Œå®ç°ä¸Šï¼Œåªéœ€è¦æœ‰ä¸€ä¸ªInformerå°±èƒ½æ»¡è¶³éœ€æ±‚äº†ï¼Œå³: SharedInformeredã€‚</p>
<p>ç¬¬å…­é˜¶æ®µï¼Œè§£å†³å¤šä¸ªä¸åŒçš„æ§åˆ¶å™¨æ’é™¤ä¸é‡è¯•é—®é¢˜ï¼Œå¼•å…¥DeltaFIFOQueueã€‚æ¯å½“èµ„æºè¢«ä¿®æ”¹æ—¶ï¼ŒReflectorå°±ä¼šæ”¶åˆ°äº‹ä»¶é€šçŸ¥ï¼Œå¹¶å°†å¯¹åº”çš„äº‹ä»¶æ”¾å…¥DeltaFIFOQueueä¸­ã€‚å¦å¤–ï¼ŒSharedInformerä¼šä¸æ–­ä»DeltaFIFOQueueä¸­è¯»å–äº‹ä»¶å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜(ThreadSafeStore)çš„çŠ¶æ€ã€‚</p>
<h2 id="infomerç»„ä»¶">infomerç»„ä»¶</h2>
<p>Informer ä¸­ä¸»è¦æœ‰ Reflectorã€Delta FIFO Queueã€Local Storeã€WorkQueue å‡ ä¸ªç»„ä»¶ã€‚ä»¥ä¸‹æ˜¯ Informer çš„å·¥ä½œæµç¨‹å›¾ã€‚
<a href="#R-image-3e1f048ecf1f7e439398d88a3ff5ea2f" class="lightbox-link"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/bc12981c1fc71039b947ed69e4a9cfd2.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-3e1f048ecf1f7e439398d88a3ff5ea2f"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/bc12981c1fc71039b947ed69e4a9cfd2.png"></a>
æ ¹æ®æµç¨‹å›¾æ¥è§£é‡Šä¸€ä¸‹ Informer ä¸­å‡ ä¸ªç»„ä»¶çš„ä½œç”¨ï¼š</p>
<ul>
<li>
<p>Reflectorï¼šç§°ä¹‹ä¸ºåå°„å™¨ï¼Œå®ç°å¯¹ apiserver æŒ‡å®šç±»å‹å¯¹è±¡çš„ç›‘æ§(ListAndWatch)ï¼Œå…¶ä¸­åå°„å®ç°çš„å°±æ˜¯æŠŠç›‘æ§çš„ç»“æœå®ä¾‹åŒ–æˆå…·ä½“çš„å¯¹è±¡ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ Kubernetes çš„ List/Watch APIï¼›</p>
</li>
<li>
<p>DeltaIFIFO Queueï¼šä¸€ä¸ªå¢é‡é˜Ÿåˆ—ï¼Œå°† Reflector ç›‘æ§å˜åŒ–çš„å¯¹è±¡å½¢æˆä¸€ä¸ª FIFO é˜Ÿåˆ—ï¼Œæ­¤å¤„çš„ Delta å°±æ˜¯å˜åŒ–ï¼›</p>
</li>
<li>
<p>LocalStoreï¼šå°±æ˜¯ informer çš„ cacheï¼Œè¿™é‡Œé¢ç¼“å­˜çš„æ˜¯ apiserver ä¸­çš„å¯¹è±¡(å…¶ä¸­æœ‰ä¸€éƒ¨åˆ†å¯èƒ½è¿˜åœ¨DeltaFIFO ä¸­)ï¼Œæ­¤æ—¶ä½¿ç”¨è€…å†æŸ¥è¯¢å¯¹è±¡çš„æ—¶å€™å°±ç›´æ¥ä» cache ä¸­æŸ¥æ‰¾ï¼Œå‡å°‘äº† apiserver çš„å‹åŠ›ï¼ŒLocalStore åªä¼šè¢« Lister çš„ List/Get æ–¹æ³•è®¿é—®ã€‚</p>
</li>
<li>
<p>WorkQueueï¼šDeltaIFIFO æ”¶åˆ°æ—¶é—´åä¼šå…ˆå°†æ—¶é—´å­˜å‚¨åœ¨è‡ªå·±çš„æ•°æ®ç»“æ„ä¸­ï¼Œç„¶åç›´æ¥æ“ä½œ Store ä¸­å­˜å‚¨çš„æ•°æ®ï¼Œæ›´æ–°å®Œ store å DeltaIFIFO ä¼šå°†è¯¥äº‹ä»¶ pop åˆ° WorkQueue ä¸­ï¼ŒController æ”¶åˆ° WorkQueue ä¸­çš„äº‹ä»¶ä¼šæ ¹æ®å¯¹åº”çš„ç±»å‹è§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚</p>
</li>
</ul>
<h2 id="informer-çš„å·¥ä½œæµç¨‹">Informer çš„å·¥ä½œæµç¨‹</h2>
<ul>
<li>Informer é¦–å…ˆä¼š list/watch apiserverï¼ŒInformer æ‰€ä½¿ç”¨çš„ Reflector åŒ…è´Ÿè´£ä¸ apiserver å»ºç«‹è¿æ¥ï¼ŒReflector ä½¿ç”¨ ListAndWatch çš„æ–¹æ³•ï¼Œä¼šå…ˆä» apiserver ä¸­ list è¯¥èµ„æºçš„æ‰€æœ‰å®ä¾‹ï¼Œlist ä¼šæ‹¿åˆ°è¯¥å¯¹è±¡æœ€æ–°çš„ resourceVersionï¼Œç„¶åä½¿ç”¨ watch æ–¹æ³•ç›‘å¬è¯¥ resourceVersion ä¹‹åçš„æ‰€æœ‰å˜åŒ–ï¼Œè‹¥ä¸­é€”å‡ºç°å¼‚å¸¸ï¼Œreflector åˆ™ä¼šä»æ–­å¼€çš„ resourceVersion å¤„é‡ç°å°è¯•ç›‘å¬æ‰€æœ‰å˜åŒ–ï¼Œä¸€æ—¦è¯¥å¯¹è±¡çš„å®ä¾‹æœ‰åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°åŠ¨ä½œï¼ŒReflector éƒ½ä¼šæ”¶åˆ°â€äº‹ä»¶é€šçŸ¥â€ï¼Œè¿™æ—¶ï¼Œè¯¥äº‹ä»¶åŠå®ƒå¯¹åº”çš„ API å¯¹è±¡è¿™ä¸ªç»„åˆï¼Œè¢«ç§°ä¸ºå¢é‡ï¼ˆDeltaï¼‰ï¼Œå®ƒä¼šè¢«æ”¾è¿› DeltaFIFO ä¸­ã€‚</li>
<li>Informer ä¼šä¸æ–­åœ°ä»è¿™ä¸ª DeltaFIFO ä¸­è¯»å–å¢é‡ï¼Œæ¯æ‹¿å‡ºä¸€ä¸ªå¯¹è±¡ï¼ŒInformer å°±ä¼šåˆ¤æ–­è¿™ä¸ªå¢é‡çš„æ—¶é—´ç±»å‹ï¼Œç„¶ååˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°çš„ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ storeã€‚</li>
<li>å¦‚æœäº‹ä»¶ç±»å‹æ˜¯ Addedï¼ˆæ·»åŠ å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆ Informer ä¼šé€šè¿‡ Indexer çš„åº“æŠŠè¿™ä¸ªå¢é‡é‡Œçš„ API å¯¹è±¡ä¿å­˜åˆ°æœ¬åœ°çš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸ºå®ƒåˆ›å»ºç´¢å¼•ï¼Œè‹¥ä¸ºåˆ é™¤æ“ä½œï¼Œåˆ™åœ¨æœ¬åœ°ç¼“å­˜ä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚</li>
<li>DeltaFIFO å† pop è¿™ä¸ªäº‹ä»¶åˆ° controller ä¸­ï¼Œcontroller ä¼šè°ƒç”¨äº‹å…ˆæ³¨å†Œçš„ ResourceEventHandler å›è°ƒå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</li>
<li>åœ¨ ResourceEventHandler å›è°ƒå‡½æ•°ä¸­ï¼Œå…¶å®åªæ˜¯åšäº†ä¸€äº›å¾ˆç®€å•çš„è¿‡æ»¤ï¼Œç„¶åå°†å…³å¿ƒå˜æ›´çš„ Object æ”¾åˆ° workqueue é‡Œé¢ã€‚</li>
<li>Controller ä» workqueue é‡Œé¢å–å‡º Objectï¼Œå¯åŠ¨ä¸€ä¸ª worker æ¥æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘é€šå¸¸æ˜¯è®¡ç®—ç›®å‰é›†ç¾¤çš„çŠ¶æ€å’Œç”¨æˆ·å¸Œæœ›è¾¾åˆ°çš„çŠ¶æ€æœ‰å¤šå¤§çš„åŒºåˆ«ï¼Œç„¶åå­œå­œä¸å€¦åœ°è®© apiserver å°†çŠ¶æ€æ¼”åŒ–åˆ°ç”¨æˆ·å¸Œæœ›è¾¾åˆ°çš„çŠ¶æ€ï¼Œæ¯”å¦‚ä¸º deployment åˆ›å»ºæ–°çš„ podsï¼Œæˆ–è€…æ˜¯æ‰©å®¹/ç¼©å®¹ deploymentã€‚</li>
<li>åœ¨workerä¸­å°±å¯ä»¥ä½¿ç”¨ lister æ¥è·å– resourceï¼Œè€Œä¸ç”¨é¢‘ç¹çš„è®¿é—® apiserverï¼Œå› ä¸º apiserver ä¸­ resource çš„å˜æ›´éƒ½ä¼šåæ˜ åˆ°æœ¬åœ°çš„ cache ä¸­ã€‚</li>
</ul>
<p>Informer åœ¨ä½¿ç”¨æ—¶éœ€è¦å…ˆåˆå§‹åŒ–ä¸€ä¸ª InformerFactoryï¼Œç›®å‰ä¸»è¦æ¨èä½¿ç”¨çš„æ˜¯ SharedInformerFactoryï¼ŒShared æŒ‡çš„æ˜¯åœ¨å¤šä¸ª Informer ä¸­å…±äº«ä¸€ä¸ªæœ¬åœ° cacheã€‚
Informer ä¸­çš„ ResourceEventHandler å‡½æ•°æœ‰ä¸‰ç§ï¼š</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// ResourceEventHandlerFuncs is an adaptor to let you easily specify as many or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// as few of the notification functions as you want while still implementing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ResourceEventHandler.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>type ResourceEventHandlerFuncs <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    AddFunc    <span style="color:#a6e22e">func</span>(obj interface{})
</span></span><span style="display:flex;"><span>    UpdateFunc func(oldObj, newObj interface{})
</span></span><span style="display:flex;"><span>    DeleteFunc func(obj interface{})
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>è¿™ä¸‰ç§å‡½æ•°çš„å¤„ç†é€»è¾‘æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œåœ¨åˆå§‹åŒ– controller æ—¶æ³¨å†Œå®Œ ResourceEventHandler åï¼Œä¸€æ—¦è¯¥å¯¹è±¡çš„å®ä¾‹æœ‰åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ä¸‰ä¸­æ“ä½œåå°±ä¼šè§¦å‘å¯¹åº”çš„ ResourceEventHandlerã€‚</p>
<h1 id="è‡ªå®šä¹‰-ingress-controller">è‡ªå®šä¹‰ Ingress Controller</h1>
<p>åœ¨ Kubernetes ä¸­é€šè¿‡ Ingress æ¥æš´éœ²æœåŠ¡åˆ°é›†ç¾¤å¤–éƒ¨ï¼Œè¿™ä¸ªå·²ç»æ˜¯ä¸€ä¸ªå¾ˆæ™®éçš„æ–¹å¼äº†ï¼Œè€ŒçœŸæ­£æ‰®æ¼”è¯·æ±‚è½¬å‘çš„è§’è‰²æ˜¯èƒŒåçš„ Ingress Controllerï¼Œæ¯”å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ traefikã€ingress-nginx ç­‰å°±æ˜¯ä¸€ä¸ª Ingress Controllerã€‚è¿™é‡Œå°†é€šè¿‡ client-goæ¥å®ç°ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰çš„ Ingress Controllerï¼Œå¯ä»¥åŠ æ·±æˆ‘ä»¬å¯¹ Ingress çš„ç†è§£ã€‚
æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªnginxçš„æœåŠ¡</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>kubectl run nginx <span style="color:#f92672">--</span>image<span style="color:#f92672">=</span>nginx</span></span></code></pre></div>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ NodePort ç±»å‹çš„ Service æ¥è¿›è¡Œè®¿é—®</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: whoami
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    app: whoami
</span></span><span style="display:flex;"><span>  ports:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> protocol: TCP
</span></span><span style="display:flex;"><span>      port: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      targetPort: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      nodePort:<span style="color:#ae81ff">80</span></span></span></code></pre></div>
<p>ä½†æ˜¯å½“æˆ‘ä»¬åº”ç”¨è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ç«¯å£çš„ç®¡ç†ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¸é‡‡ç”¨è¯¥æ–¹å¼ï¼Œä¹‹å‰æˆ‘ä»¬çš„æ–¹æ³•æ˜¯ç”¨ DaemonSet åœ¨æ¯ä¸ªè¾¹ç¼˜èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Nginx åº”ç”¨ï¼š</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  hostNetwork: true
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> image: nginx:<span style="color:#ae81ff">1.15.3</span><span style="color:#f92672">-</span>alpine
</span></span><span style="display:flex;"><span>      name: nginx
</span></span><span style="display:flex;"><span>      ports:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> name: http
</span></span><span style="display:flex;"><span>          containerPort: <span style="color:#ae81ff">80</span></span></span></code></pre></div>
<p>é€šè¿‡è®¾ç½® hostNetwork:trueï¼Œå®¹å™¨å°†ç»‘å®šèŠ‚ç‚¹çš„80ç«¯å£ï¼Œè€Œä¸ä»…ä»…æ˜¯å®¹å™¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡èŠ‚ç‚¹çš„å…¬å…± IP åœ°å€çš„ 80 ç«¯å£è®¿é—®åˆ° Nginx åº”ç”¨äº†ã€‚è¿™ç§æ–¹æ³•ç†è®ºä¸Šè‚¯å®šæ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªæœ€å¤§çš„é—®é¢˜å°±æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª Nginx é…ç½®æ–‡ä»¶ï¼Œå¦‚æœåº”ç”¨æœ‰å˜æ›´ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼Œä¸èƒ½è‡ªåŠ¨å‘ç°å’Œçƒ­æ›´æ–°ï¼Œè¿™å¯¹äºå¤§é‡çš„åº”ç”¨ç»´æŠ¤çš„æˆæœ¬æ˜¾ç„¶å¤ªå¤§,åŒæ—¶æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦æš´éœ²ä¸»æœºç«¯å£ï¼Œç«¯å£å¤ªå¤šä¸å¥½ç»´æŠ¤ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç”¨å¦å¤–ä¸€ä¸ª Kubernetes æä¾›çš„æ–¹æ¡ˆäº†ï¼šIngressã€‚</p>
<h2 id="ingress-å¯¹è±¡">Ingress å¯¹è±¡</h2>
<p>Kubernetes å†…ç½®å°±æ”¯æŒé€šè¿‡ Ingress å¯¹è±¡å°†å¤–éƒ¨çš„åŸŸåæ˜ å°„åˆ°é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼Œç±»ä¼¼äºnginxï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„ Ingress å¯¹è±¡æ¥å¯¹å¤–æš´éœ²æœåŠ¡ï¼š</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>apiVersion: networking.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: testingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  tls:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> hosts:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;*.jiaozi.com&#34;</span>
</span></span><span style="display:flex;"><span>      secretName: jiaozi<span style="color:#f92672">-</span>tls
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> host: main.jiaozi.com
</span></span><span style="display:flex;"><span>      http:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-</span> path: <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>            pathType: Prefix
</span></span><span style="display:flex;"><span>            backend:
</span></span><span style="display:flex;"><span>              service:
</span></span><span style="display:flex;"><span>                name: nginx
</span></span><span style="display:flex;"><span>                port:
</span></span><span style="display:flex;"><span>                  number: <span style="color:#ae81ff">80</span></span></span></code></pre></div>
<p>è¿™é‡Œä¸ºäº†æœ€ç®€å•å®ç°ingressæ¡ˆä¾‹ï¼Œæˆ‘ä»¬å»é™¤æ‰httpsçš„éƒ¨åˆ†</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>apiVersion: networking.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: testingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> host: main.jiaozi.com
</span></span><span style="display:flex;"><span>      http:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-</span> path: <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>            pathType: Prefix
</span></span><span style="display:flex;"><span>            backend:
</span></span><span style="display:flex;"><span>              service:
</span></span><span style="display:flex;"><span>                name: nginx
</span></span><span style="display:flex;"><span>                port:
</span></span><span style="display:flex;"><span>                  number: <span style="color:#ae81ff">80</span></span></span></code></pre></div>
<blockquote>
<p>ä¸Šé¢é…ç½®çš„å¤§æ¦‚æ„è¯†æ˜¯å½“è®¿é—®main.jiaozi.com/ä¸‹æ‰€æœ‰è¯·æ±‚è½¬å‘åˆ°nginxæœåŠ¡çš„80ç«¯å£ã€‚</p></blockquote>
<h2 id="ingresså®ç°">Ingresså®ç°</h2>
<h3 id="client-goå®ç°">client-goå®ç°</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>package controller
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/demdxx/gocast&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	v1 <span style="color:#e6db74">&#34;k8s.io/api/networking/v1&#34;</span>
</span></span><span style="display:flex;"><span>	metav1 <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/util/runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http/httputil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/url&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>	_ <span style="color:#e6db74">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;regexp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>var client <span style="color:#f92672">*</span>kubernetes.Clientset
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  è·å–Clientsetå¯¹è±¡å®¢æˆ·ç«¯æ“ä½œå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>func GetClientSet() (<span style="color:#f92672">*</span>kubernetes.Clientset, error) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> client<span style="color:#f92672">==</span>nil {
</span></span><span style="display:flex;"><span>		var kubeconfig <span style="color:#f92672">*</span>string
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> home :<span style="color:#f92672">=</span> homedir.HomeDir(); home <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			kubeconfig <span style="color:#f92672">=</span> flag.String(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, filepath.Join(home, <span style="color:#e6db74">&#34;.kube&#34;</span>, <span style="color:#e6db74">&#34;config&#34;</span>), <span style="color:#e6db74">&#34;(optional) absolute path to the kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//kubeconfig = flag.String(&#34;kubeconfig&#34;, filepath.Join( &#34;d:/test/&#34;, &#34;config&#34;), &#34;(optional) absolute path to the kubeconfig file&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			kubeconfig <span style="color:#f92672">=</span> flag.String(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;absolute path to the kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		flag.Parse()
</span></span><span style="display:flex;"><span>		config, err :<span style="color:#f92672">=</span> clientcmd.BuildConfigFromFlags(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span>kubeconfig)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//é›†ç¾¤å†…éƒ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			log.Println(<span style="color:#e6db74">&#34;è¿›å»é›†ç¾¤å†…éƒ¨è·å–é›†ç¾¤å†…éƒ¨é…ç½®&#34;</span>)
</span></span><span style="display:flex;"><span>			config, err <span style="color:#f92672">=</span> rest.InClusterConfig()
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
</span></span><span style="display:flex;"><span>				log.Println(<span style="color:#e6db74">&#34;è¿›å»é›†ç¾¤å†…éƒ¨è·å–é…ç½®é”™è¯¯:&#34;</span>,err)
</span></span><span style="display:flex;"><span>				panic(err)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// åˆå§‹åŒ– client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		var configerr error
</span></span><span style="display:flex;"><span>		client,configerr<span style="color:#f92672">=</span>kubernetes.NewForConfig(config)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> client,configerr
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> client,nil
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  watch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     ingressæˆ–è€…serviceå‘ç”Ÿå˜åŒ–ç›´æ¥é‡å¯è¯»å–é…ç½®é‡å¯ä»£ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">WatchResource</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆå§‹åŒ– client
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	clientset, err :<span style="color:#f92672">=</span> GetClientSet()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> err <span style="color:#f92672">!=</span> nil {
</span></span><span style="display:flex;"><span>		log.Panic(err.Error())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	stopper :<span style="color:#f92672">=</span> make(chan <span style="color:#66d9ef">struct</span>{})
</span></span><span style="display:flex;"><span>	defer close(stopper)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆå§‹åŒ– informer ä¸ºäº†é™ä½è¿‡å¤šwatchå¯¹apiserverçš„å‹åŠ›ï¼Œä½¿ç”¨å…±äº«çš„infomer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	factory :<span style="color:#f92672">=</span> informers.NewSharedInformerFactory(clientset, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//åˆ›å»ºä¸€ä¸ªserviceçš„informer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//serviceInformer := factory.Core().V1().Services()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//ingressInformer := factory.Core().V1().Pods()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ingressInformer :<span style="color:#f92672">=</span> factory.Networking().V1().Ingresses()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//SharedIndexInformer æä¾› add and get Indexers èƒ½åŠ›åŸºäº SharedInformer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	defer runtime.HandleCrash()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//// å¯åŠ¨ informerï¼Œlist &amp; watch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	go factory.Start(stopper)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// list  ä¸€ä¸ª Informer å®ä¾‹åªèƒ½ç›‘å¬ä¸€ç§ resourceï¼Œæ¯ä¸ª resource éœ€è¦åˆ›å»ºå¯¹åº”çš„ Informer å®ä¾‹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>cache.WaitForCacheSync(stopper, ingressInformer.Informer().HasSynced) {
</span></span><span style="display:flex;"><span>		runtime.HandleError(fmt.Errorf(<span style="color:#e6db74">&#34;Timed out waiting for caches to sync&#34;</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	go func() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä½¿ç”¨è‡ªå®šä¹‰ handler infomerè·å–åˆ°äº‹ä»¶å¯¹è±¡ååˆ†å‘åˆ°è¿™ä¸ªhandlerä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ingressInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{
</span></span><span style="display:flex;"><span>			AddFunc: func(obj interface{}) {
</span></span><span style="display:flex;"><span>				onUpdate(<span style="color:#e6db74">&#34;ADD&#34;</span>, obj)
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			UpdateFunc: func(o1 interface{}, o2 interface{}) { onUpdate(<span style="color:#e6db74">&#34;UPDATE&#34;</span>, o1, o2) }, <span style="color:#75715e">// æ­¤å¤„çœç•¥ workqueue çš„ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			DeleteFunc: func(o1 interface{}) { onUpdate(<span style="color:#e6db74">&#34;DELETE&#34;</span>, o1) },
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span>make(chan <span style="color:#66d9ef">int</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">onUpdate</span>(op string, obj ...interface{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> obj[<span style="color:#ae81ff">0</span>].(type) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span>v1.Ingress:
</span></span><span style="display:flex;"><span>		ingress <span style="color:#f92672">=</span> obj[<span style="color:#ae81ff">0</span>].(<span style="color:#f92672">*</span>v1.Ingress)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;ADD&#34;</span><span style="color:#f92672">==</span>op {
</span></span><span style="display:flex;"><span>			ingress <span style="color:#f92672">=</span> obj[<span style="color:#ae81ff">0</span>].(<span style="color:#f92672">*</span>v1.Ingress)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;UPDATE&#34;</span><span style="color:#f92672">==</span>op {
</span></span><span style="display:flex;"><span>			ingress <span style="color:#f92672">=</span> obj[<span style="color:#ae81ff">1</span>].(<span style="color:#f92672">*</span>v1.Ingress)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;DELETE&#34;</span><span style="color:#f92672">==</span>op {
</span></span><span style="display:flex;"><span>			ingress <span style="color:#f92672">=</span> nil
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	RenderProxyConfig()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>var ingress <span style="color:#f92672">*</span>v1.Ingress
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   å®šä¹‰å’Œingressé…ç½®åŒ¹é…çš„æ˜ å°„å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>type Server <span style="color:#66d9ef">struct</span>{
</span></span><span style="display:flex;"><span>	ServiceName string  <span style="color:#75715e">//è·³è½¬k8sæœåŠ¡åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	Port string         <span style="color:#75715e">//è·³è½¬k8sæœåŠ¡ç«¯å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	MatchHost string    <span style="color:#75715e">//åŒ¹é…hostname
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>var regServerMapping map[string]<span style="color:#f92672">*</span>Server<span style="color:#f92672">=</span>make(map[string]<span style="color:#f92672">*</span>Server)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>func RenderProxyConfig(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ingress<span style="color:#f92672">!=</span>nil {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> _, rule :<span style="color:#f92672">=</span> range ingress.Spec.Rules {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> _, path :<span style="color:#f92672">=</span> range rule.HTTP.Paths {
</span></span><span style="display:flex;"><span>				mappingHost :<span style="color:#f92672">=</span> rule.Host
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">//ä¸ºäº†é˜²æ­¢http.handleåœ¨ingressä¿®æ”¹åé‡æ–°æ³¨å†Œï¼Œå¯¼è‡´å‡ºé”™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span>  _, ok :<span style="color:#f92672">=</span>regServerMapping[path.Path];<span style="color:#f92672">!</span>ok {
</span></span><span style="display:flex;"><span>					var server <span style="color:#f92672">*</span>Server;
</span></span><span style="display:flex;"><span>					server <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>Server{
</span></span><span style="display:flex;"><span>						ServiceName: path.Backend.Service.Name,
</span></span><span style="display:flex;"><span>						Port:        gocast.ToString(path.Backend.Service.Port.Number),
</span></span><span style="display:flex;"><span>						MatchHost:   strings.ReplaceAll(mappingHost, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;.*&#34;</span>),
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					http.Handle(path.Path, server)
</span></span><span style="display:flex;"><span>					regServerMapping[path.Path]<span style="color:#f92672">=</span>server
</span></span><span style="display:flex;"><span>				}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>					server:<span style="color:#f92672">=</span>regServerMapping[path.Path]
</span></span><span style="display:flex;"><span>					server.ServiceName<span style="color:#f92672">=</span>path.Backend.Service.Name;
</span></span><span style="display:flex;"><span>					server.Port<span style="color:#f92672">=</span>gocast.ToString(path.Backend.Service.Port.Number)
</span></span><span style="display:flex;"><span>					server.MatchHost<span style="color:#f92672">=</span>strings.ReplaceAll(mappingHost, <span style="color:#e6db74">&#34;*&#34;</span>, <span style="color:#e6db74">&#34;.*&#34;</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>func <span style="color:#a6e22e">StartProxy</span>(){
</span></span><span style="display:flex;"><span>	RenderProxyConfig()
</span></span><span style="display:flex;"><span>	http.ListenAndServe(<span style="color:#e6db74">&#34;:80&#34;</span>, nil)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP å¤„ç† HTTP è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>func (s <span style="color:#f92672">*</span>Server )ServeHTTP(w http.ResponseWriter, r <span style="color:#f92672">*</span>http.Request) {
</span></span><span style="display:flex;"><span>	requestHost:<span style="color:#f92672">=</span>r.Host
</span></span><span style="display:flex;"><span>	log.Println(<span style="color:#e6db74">&#34;å¼€å§‹åŒ¹é…ingreesåŸŸå:&#34;</span>,s.MatchHost,<span style="color:#e6db74">&#34;ï¼Œåˆ°è¯·æ±‚åŸŸåï¼š&#34;</span>,requestHost)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> result,_:<span style="color:#f92672">=</span>regexp.Match(s.MatchHost,[]byte(requestHost));result {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//é€šè¿‡æœåŠ¡åç§°è·å–åˆ°é›†ç¾¤ip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		client, _ :<span style="color:#f92672">=</span> GetClientSet()
</span></span><span style="display:flex;"><span>		service, _ :<span style="color:#f92672">=</span> client.CoreV1().Services(ingress.Namespace).Get(context.TODO(), s.ServiceName, metav1.GetOptions{})
</span></span><span style="display:flex;"><span>		log.Println(<span style="color:#e6db74">&#34;åŒ¹é…åˆ°service:&#34;</span>,service)
</span></span><span style="display:flex;"><span>		serviceIp :<span style="color:#f92672">=</span> service.Spec.ClusterIP
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//serviceIp := &#34;10.10.0.118&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// æ ¹æ®è¯·æ±‚çš„åŸŸåå’Œ Path è·¯å¾„è·å–èƒŒåçœŸå®çš„åç«¯åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		backendURL, _ :<span style="color:#f92672">=</span> url.Parse(<span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">+</span> serviceIp <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> s.Port)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å¯¹åç«¯çœŸå® URL å‘èµ·ä»£ç†è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		p :<span style="color:#f92672">=</span> httputil.NewSingleHostReverseProxy(backendURL)
</span></span><span style="display:flex;"><span>		p.ServeHTTP(w, r)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>main.goä»£ç </p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>package main
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">import</span> (
</span></span><span style="display:flex;"><span>	controller <span style="color:#e6db74">&#34;clientgo/controller&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>func main() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//å¼€å¯informerç›‘å¬ingressèµ„æºçš„å˜åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	go controller.WatchResource()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//å¼€å¯ä»£ç†æœåŠ¡å™¨æ¥æ”¶æ¥è‡ªå¤–éƒ¨çš„è¯·æ±‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	controller.StartProxy()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h3 id="åˆ›å»ºé•œåƒ">åˆ›å»ºé•œåƒ</h3>
<p>æˆ‘ä»¬è‡ªå®šä¹‰çš„controllerå› ä¸ºå¯¹å¤–æ¥å—è¯·æ±‚ï¼Œå¹¶èƒ½è½¬å‘åˆ°nginxåº”ç”¨ï¼Œæ‰€ä»¥ä»–æœ¬èº«ä¹Ÿå¿…é¡»æ˜¯ä¸€ä¸ªå’Œè½¬å‘æœåŠ¡åœ¨åŒä¸€ä¸ªnamespaceçš„k8såº”ç”¨.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e"># ç¬¬ä¸€é˜¶æ®µçš„é•œåƒå®šä¹‰ä¸ºåå­—builder é€šè¿‡golangå°†æºä»£ç æ„å»ºå‡ºåº”ç”¨ç¨‹åºï¼Œç¬¬äºŒé˜¶æ®µå°±æ˜¯ç”¨è¾“å‡ºçš„åº”ç”¨ç¨‹åºç›´æ¥åœ¨æœ€å°é•œåƒä¸‹è¿è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FROM golang:<span style="color:#ae81ff">1.17</span> as builder
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WORKDIR <span style="color:#f92672">/</span>workspace
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Copy the Go Modules manifests
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>COPY go.mod go.mod
</span></span><span style="display:flex;"><span>COPY go.sum go.sum
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cache deps before building and copying source so that we don&#39;t need to re-download as much
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># and so that source changes don&#39;t invalidate our downloaded layer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>RUN go env <span style="color:#f92672">-</span>w GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>RUN <span style="color:#66d9ef">export</span> GO111MODULE<span style="color:#f92672">=</span>on
</span></span><span style="display:flex;"><span>RUN go env <span style="color:#f92672">-</span>w GOPROXY<span style="color:#f92672">=</span>https:<span style="color:#75715e">//mirrors.aliyun.com/goproxy/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>RUN <span style="color:#66d9ef">export</span> GOPROXY<span style="color:#f92672">=</span>https:<span style="color:#75715e">//mirrors.aliyun.com/goproxy/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>RUN go mod download <span style="color:#f92672">-</span>x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Copy the go source
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>COPY main.go main.go
</span></span><span style="display:flex;"><span>COPY controller<span style="color:#f92672">/</span> controller<span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Build
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>RUN CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span>amd64 go build <span style="color:#f92672">-</span>a <span style="color:#f92672">-</span>o manager main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ä½¿ç”¨æœ€å°çš„é•œåƒzi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>FROM alpine:latest
</span></span><span style="display:flex;"><span>WORKDIR <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>COPY <span style="color:#f92672">--</span>from<span style="color:#f92672">=</span>builder <span style="color:#f92672">/</span>workspace<span style="color:#f92672">/</span>manager .
</span></span><span style="display:flex;"><span>ENTRYPOINT [<span style="color:#e6db74">&#34;/manager&#34;</span>]</span></span></code></pre></div>
<p>ä½¿ç”¨dockerå‘½ä»¤æ„å»ºé•œåƒ</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>docker build <span style="color:#f92672">-</span>t jiaozi.com:<span style="color:#ae81ff">5000</span><span style="color:#f92672">/</span>hello<span style="color:#f92672">-</span>ingress:<span style="color:#ae81ff">1.0.1</span> .</span></span></code></pre></div>
<p>ä¸Šä¼ åˆ°ç§æœjiaozi.com:5000</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>docker push jiaozi.com:<span style="color:#ae81ff">5000</span><span style="color:#f92672">/</span>hello<span style="color:#f92672">-</span>ingress:<span style="color:#ae81ff">1.0.1</span> 
</span></span></code></pre></div>
<blockquote>
<p>ç§æœåˆ›å»ºè¯·å‚è€ƒä¸Šä¸€ç« èŠ‚ <a href="https://blog.csdn.net/liaomin416100569/article/details/122985042?spm=1001.2014.3001.5501" rel="external" target="_blank">K8SäºŒæ¬¡å¼€å‘04-è‡ªå®šä¹‰operatorï¼ˆoperator-sdkè°ƒè¯•ï¼‰-å‰ç½®å®‰è£…ç« èŠ‚</a></p></blockquote>
<h3 id="åˆ›å»ºdaemonset">åˆ›å»ºdaemonset</h3>
<p>åˆ›å»ºçš„controlleréœ€è¦åœ¨æ¯ä¸ªworkerèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå¯¹å¤–æš´éœ²çš„ç«¯å£ï¼Œæ‰€ä»¥å¿…é¡»å°†ä¹‹å‰åˆ›å»ºçš„client-goé•œåƒéƒ¨ç½²ä¸ºdaemonset</p>
<blockquote>
<p>æ³¨æ„è‡ªå®šä¹‰çš„controlleréœ€è¦åˆ›å»ºå¯¹åº”è´¦å·å’Œæƒé™ï¼Œå¹¶ä¸”ç»‘å®šåœ¨daemonsetä¸­ï¼Œå¦åˆ™ä»£ç listwatchä¼šæç¤ºæ²¡æœ‰æƒé™</p></blockquote>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>serviceaccount
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">namespace</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span>kind: ClusterRole
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>role
</span></span><span style="display:flex;"><span>rules:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> apiGroups:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> services
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> endpoints
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> secrets
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> get
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> list
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> watch
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> apiGroups:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> extensions
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> networking.k8s.io
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> ingresses
</span></span><span style="display:flex;"><span>    verbs:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> get
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> list
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">-</span> watch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span>kind: ClusterRoleBinding
</span></span><span style="display:flex;"><span>apiVersion: rbac.authorization.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>binding
</span></span><span style="display:flex;"><span>roleRef:
</span></span><span style="display:flex;"><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style="display:flex;"><span>  kind: ClusterRole
</span></span><span style="display:flex;"><span>  name: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>role
</span></span><span style="display:flex;"><span>subjects:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> kind: ServiceAccount
</span></span><span style="display:flex;"><span>    name: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>serviceaccount
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">namespace</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span>
</span></span><span style="display:flex;"><span>apiVersion: apps<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>kind: DaemonSet
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: hello<span style="color:#f92672">-</span>ingress<span style="color:#f92672">-</span>ds
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">namespace</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  selector:
</span></span><span style="display:flex;"><span>    matchLabels:
</span></span><span style="display:flex;"><span>      app: hello<span style="color:#f92672">-</span>ingress
</span></span><span style="display:flex;"><span>      release: stable
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">template</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    metadata:
</span></span><span style="display:flex;"><span>      labels:
</span></span><span style="display:flex;"><span>        app: hello<span style="color:#f92672">-</span>ingress
</span></span><span style="display:flex;"><span>        release: stable
</span></span><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      hostNetwork: true
</span></span><span style="display:flex;"><span>      serviceAccountName: hello<span style="color:#f92672">-</span>ingresscontroller<span style="color:#f92672">-</span>serviceaccount
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">-</span> name: hello<span style="color:#f92672">-</span>ingress
</span></span><span style="display:flex;"><span>          image: jiaozi.com:<span style="color:#ae81ff">5000</span><span style="color:#f92672">/</span>hello<span style="color:#f92672">-</span>ingress:<span style="color:#ae81ff">1.0.1</span>
</span></span><span style="display:flex;"><span>          imagePullPolicy: IfNotPresent</span></span></code></pre></div>
<p>ä½¿ç”¨kubectlåˆ›å»º</p>
<h3 id="åˆ›å»ºingress">åˆ›å»ºingress</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>apiVersion: networking.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: testingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> host: main.jiaozi.com
</span></span><span style="display:flex;"><span>      http:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-</span> path: <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>            pathType: Prefix
</span></span><span style="display:flex;"><span>            backend:
</span></span><span style="display:flex;"><span>              service:
</span></span><span style="display:flex;"><span>                name: nginx
</span></span><span style="display:flex;"><span>                port:
</span></span><span style="display:flex;"><span>                  number: <span style="color:#ae81ff">80</span></span></span></code></pre></div>
<p>ä½¿ç”¨kubectl apply -f åˆ›å»º</p>
<h2 id="æ˜ å°„åŸŸå">æ˜ å°„åŸŸå</h2>
<p>æ–°å»ºä¸¤ä¸ªæµ‹è¯•çš„åŸŸåï¼ŒæŒ‡å‘workerèŠ‚ç‚¹</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ae81ff">10.10.0.116</span> main.jiaozi.com
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10.10.0.116</span> gg.jiaozi.com</span></span></code></pre></div>
<p>è®¿é—®main.jiaozi.com
<a href="#R-image-00758b82240c614bc071160f53cd28e2" class="lightbox-link"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox figure-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/313cf1de0eaa7279ba37fadb2f4f401f.png" style=" height: auto; width: auto;"></a>
<a href="javascript:history.back();" class="lightbox-back" id="R-image-00758b82240c614bc071160f53cd28e2"><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazy lightbox lightbox-image" loading="lazy" src="/docs/images/content/devops/kubernetes/k8s_dev_05.md.images/313cf1de0eaa7279ba37fadb2f4f401f.png"></a>
æ— æ³•è®¿é—®gg.jiaozi.com
å°è¯•ä¿®æ”¹ingressé…ç½®</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>apiVersion: networking.k8s.io<span style="color:#f92672">/</span>v1
</span></span><span style="display:flex;"><span>kind: Ingress
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: testingress
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  rules:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-</span> host: <span style="color:#f92672">*</span>.jiaozi.com
</span></span><span style="display:flex;"><span>      http:
</span></span><span style="display:flex;"><span>        paths:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">-</span> path: <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>            pathType: Prefix
</span></span><span style="display:flex;"><span>            backend:
</span></span><span style="display:flex;"><span>              service:
</span></span><span style="display:flex;"><span>                name: nginx
</span></span><span style="display:flex;"><span>                port:
</span></span><span style="display:flex;"><span>                  number: <span style="color:#ae81ff">80</span></span></span></code></pre></div>
<p>ä½¿ç”¨kubectl apply -f  æµ‹è¯•gg.jiaozi.comå’Œ*.jiaozi.comå­åŸŸåå‡å¯æ­£å¸¸è®¿é—®ã€‚</p>

  <footer class="footline">
              <i class='fa-fw fas fa-calendar'></i> Sep 18, 2025
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/docs/index.html">
            <div class="logo-title">liaomin416100569åšå®¢</div>
          </a>
        </div>
        <search><form action="/docs/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/docs/index.html"><a class="padding" href="/docs/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/docs/programming/index.html"><a class="padding" href="/docs/programming/index.html">ç¼–ç¨‹å¼€å‘</a><ul id="R-subsections-e3fc01b477dbaf64a8f5013a3dab5c5b" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-id="/docs/devops/index.html"><a class="padding" href="/docs/devops/index.html">è¿ç»´ä¸€ä½“åŒ–</a><ul id="R-subsections-389d4feb4920b919bcbc0b1e9947dace" class="collapsible-menu">
            <li class="parent alwaysopen " data-nav-id="/docs/devops/kubernetes/index.html"><a class="padding" href="/docs/devops/kubernetes/index.html">kubernetes</a><ul id="R-subsections-a6d9d4850f81ae033d42cdaa03dad084" class="collapsible-menu">
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_01/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_01/index.html">K8SäºŒæ¬¡å¼€å‘01-å„ç§èµ„æºå¯¹è±¡çš„ç†è§£å’Œå®šä¹‰</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_02/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_02/index.html">K8SäºŒæ¬¡å¼€å‘02-kubeadmå®‰è£…k8sé›†ç¾¤</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_03/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_03/index.html">K8SäºŒæ¬¡å¼€å‘03-CRDèµ„æºè¯¦è§£</a></li>
            <li class="" data-nav-id="/docs/devops/kubernetes/k8s_dev_04/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_04/index.html">K8SäºŒæ¬¡å¼€å‘04-è‡ªå®šä¹‰operatorï¼ˆoperator-sdkè°ƒè¯•ï¼‰</a></li>
            <li class="active " data-nav-id="/docs/devops/kubernetes/k8s_dev_05/index.html"><a class="padding" href="/docs/devops/kubernetes/k8s_dev_05/index.html">K8SäºŒæ¬¡å¼€å‘05-ä½¿ç”¨clientgoè‡ªå®šä¹‰ingresscontroller</a></li></ul></li>
            <li class="alwaysopen " data-nav-id="/docs/devops/networking/index.html"><a class="padding" href="/docs/devops/networking/index.html">ç½‘ç»œæŠ€æœ¯</a><ul id="R-subsections-bd6b3f75e8269a91d29691b78d3bac17" class="collapsible-menu"></ul></li></ul></li>
            <li class="" data-nav-id="/docs/security/index.html"><a class="padding" href="/docs/security/index.html">å®‰å…¨æ”»é˜²</a><ul id="R-subsections-66815ecaaecfc1c209e5637d03b258b2" class="collapsible-menu"></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/docs/js/clipboard/clipboard.min.js?1758355652" defer></script>
    <script src="/docs/js/perfect-scrollbar/perfect-scrollbar.min.js?1758355652" defer></script>
    <script src="/docs/js/theme.min.js?1758355652" defer></script>
  </body>
</html>
